# Анализ: Обоснование расположения команды

## Предыстория проблемы

Пользователи сообщества сообщили: **расположение команды analyze в spec-kit и novel-write не совпадает**

- spec-kit (разработка кода): analyze **перед** implement
- novel-write (создание романов): analyze **после** write

Является ли это ошибкой дизайна или намеренным решением? Этот документ подробно обсудит обоснованность этого различия.

## Сравнение процессов

### Стандартный процесс spec-kit (разработка ПО)

```
constitution → specify → clarify → plan → tasks → analyze → implement
                                                      ↑
                                           Проверка перед реализацией
```

Источник: [spec-kit README.md L216](https://github.com/github/spec-kit)

```markdown
| `/analyze` | Анализ согласованности и полноты кросс-артефактов
             (запускается после /tasks, перед /implement) |
```

**Роль analyze**:
- Кросс-проверка согласованности между спецификациями, планами и задачами
- Проверка полноты (все ли требования имеют соответствующие задачи)
- Выявление противоречий и упущений (для исправления перед кодированием)
- Обеспечение достаточной подготовки перед реализацией

### Стандартный процесс novel-write (создание романов)

```
constitution → specify → clarify → plan → tasks → write → analyze
                                                             ↑
                                              Проверка после написания
```

Источник: [novel-write templates/commands/write.md L115](../../templates/commands/write.md)

```markdown
/constitution → Определение принципов творчества
     ↓
/specify → Определение требований к истории
     ↓
/clarify → Уточнение ключевых решений
     ↓
/plan → Разработка технического решения
     ↓
/tasks → Декомпозиция задач для выполнения
     ↓
/write → 【Текущий】этап написания
     ↓
/analyze → Проверка согласованности качества
```

**Роль analyze**:
- Проверка соответствия написанного контента спецификациям
- Проверка связности сюжета, последовательности персонажей
- Оценка достижения стандартов качества
- Генерация предложений по улучшению

## Анализ ключевых различий

### Различие 1: Разные объекты проверки

| Аспект | spec-kit (код) | novel-write (роман) |
|--------|----------------|-------------------|
| **Объект проверки** | Документы спецификаций, планы, списки задач | Написанный контент |
| **Содержание проверки** | Согласованность, полнота, реализуемость | Качество, связность, выражение темы |
| **Время проверки** | Перед реализацией (превентивно) | После написания (оценочно) |

### Различие 2: Разная стоимость ошибки

**Стоимость ошибки при разработке кода**:
- ❌ Если не провести analyze перед реализацией, можно написать 50% кода и обнаружить противоречие в дизайне
- ❌ Высокая стоимость рефакторинга, написанный код может быть непригоден
- ✅ Предварительная проверка позволяет избежать переделок

**Стоимость ошибки при создании романов**:
- ✅ Чрезмерный анализ перед написанием может прервать творческий поток
- ✅ Сначала завершить черновик, а затем массово редактировать — более эффективный процесс
- ✅ Литературные произведения допускают совершенствование в процессе пересмотра

### Различие 3: Характер цикла обратной связи

**Разработка кода (превентивная обратная связь)**:
```
plan → tasks → analyze → обнаружение противоречий → изменение plan/tasks → implement
          ↑_______________|
        （нет потерь кода）
```

**Создание романов (итеративная обратная связь)**:
```
plan → tasks → write → analyze → обнаружение проблем → редактирование контента
                  ↑_______________________|
              （контент уже существует, доработка, а не переписывание）
```

## Обоснование дизайна

### Почему код требует "analyze before implement"?

#### 1. **Возможность немедленного изменения**
- Спецификации, планы, задачи — это документы, стоимость их изменения низка
- После обнаружения проблем analyze, достаточно скорректировать документы
- Корректировки перед реализацией не приводят к потере рабочего времени на код

#### 2. **Двоичная корректность**
- Код либо компилируется, либо нет
- Тесты либо проходят, либо нет
- Analyze может заранее выявить эти двоичные проблемы

#### 3. **Сложность зависимостей**
- Между модулями кода существуют сильные зависимости
- Как только начинается реализация, дерево зависимостей определяется
- Предварительный analyze позволяет оптимизировать структуру зависимостей

#### 4. **Инструментальная проверка**
- Analyze может автоматически проверять:
  - Есть ли задачи для всех требований спецификации
  - Охватывают ли задачи все компоненты плана
  - Соответствуют ли контракты модели данных
- Эти проверки не требуют реального кода

**Пример: пункты проверки analyze в spec-kit**
```markdown
## Анализ покрытия
- [ ] Все требования P0 имеют соответствующие задачи
- [ ] Все сущности в data-model.md имеют задачи CRUD
- [ ] Все API-эндпоинты в contracts/ имеют задачи реализации

## Анализ согласованности
- [ ] Технологический стек плана соответствует инструментам в задачах
- [ ] Отсутствие противоречий между spec.md и plan.md
- [ ] Задачи тестирования существуют перед задачами реализации (TDD)
```

### Почему романы требуют "write before analyze"?

#### 1. **Защита творческого потока**
- Написание требует непрерывного творческого состояния (flow state)
- Частые прерывания нарушают повествовательный ритм и вдохновение
- Массовый анализ после завершения черновика больше соответствует творческой психологии

#### 2. **Непрерывность качества**
- Качество литературы не является двоичным (не "правильно/неправильно")
- Требуется оценка, измерения качества (от 1 до 10)
- Необходимо иметь фактический контент для оценки качества

#### 3. **Контекстная зависимость**
- Отдельная глава не может проверить тему, ритм, арку персонажа
- Необходимо накопить определенный объем (5-10 глав) для глубокого анализа
- Массовая проверка эффективнее поглавной

#### 4. **Режим итеративного совершенствования**
- Создание романа по сути — это "черновик → пересмотр → доработка"
- Черновик допускает несовершенство, корректировка происходит после analyze
- Этот режим принципиально отличается от "сначала тестирование" в коде

**Пример: пункты проверки analyze в novel-write**
```markdown
## Проверка соответствия конституции
- [ ] Соответствует ли основным ценностям
- [ ] Достигнуты ли стандарты качества

## Анализ соответствия спецификациям
- [ ] Реализованы ли обязательные элементы P0
- [ ] Оценка соответствия целевой аудитории

## Анализ качества контента
- [ ] Оценка плотности сюжета
- [ ] Проверка последовательности персонажей
- [ ] Анализ изменений ритма
```

## Инженерия vs Искусство: принципиальные различия

### Сравнительная таблица аспектов

| Аспект | Разработка кода (инженерия) | Создание романов (искусство) |
|--------|----------------|----------------|
| **Стандарт корректности** | Двоичный (пройдено/не пройдено) | Непрерывный спектр (1-10 баллов) |
| **Время проверки** | Превентивное (до) | Оценочное (после) |
| **Стоимость изменения** | Высокая после реализации, низкая до | Приемлема после черновика |
| **Характер рабочего процесса** | Может прерываться, параллелен | Требует непрерывности |
| **Механизм обратной связи** | Автоматизированные инструменты проверки | Комбинированная оценка человеком и ИИ |
| **Гранулярность проверки** | Мелкая (уровень функции) | Крупная (уровень главы/тома) |
| **Идеальное время** | С первого раза должно быть правильно | Постепенное совершенствование в процессе итераций |

### Психологические различия

**Рабочий режим инженера**:
- Сначала проектирование архитектуры (можно многократно обдумывать)
- Кодирование после подтверждения отсутствия ошибок
- Проблемы в процессе кодирования — это дефекты дизайна

**Рабочий режим писателя**:
- Сначала быстрое фиксирование идей (не прерываться рациональным мышлением)
- Оценка всего произведения после завершения черновика
- Редактирование — необходимая часть творческого процесса

### Проверка историческим опытом

**Лучшие практики в разработке ПО**:
- TDD (разработка через тестирование): сначала писать тесты, потом код
- Design Review: проверка дизайна перед реализацией
- Architecture Review: проверка архитектуры перед кодированием
- **Вывод**: предварительная проверка признана лучшей практикой

**Лучшие практики в создании литературы**:
- Хемингуэй: «Все первые черновики — дерьмо» (сначала закончить, потом совершенствовать)
- Стивен Кинг: сначала написать полную историю, затем отложить на 6 недель для редактирования
- Стандартный процесс писательских мастерских: Draft → Critique → Revise
- **Вывод**: пост-редактирование — стандартный процесс творчества

## Что если наоборот?

### Гипотеза 1: Код также использует "implement before analyze"

```
plan → tasks → implement → analyze → обнаружение проблем
                    ↓
                Написано 5000 строк кода
                    ↓
            analyze обнаруживает противоречие в архитектуре
                    ↓
            Требуется рефакторинг или переписывание ❌
```

**Проблемы**:
- Потеряно много времени на кодирование
- Возможно накопление технического долга
- Снижение морального духа команды

### Гипотеза 2: Романы также используют "analyze before write"

```
plan → tasks → analyze (проверка плана) → write
                ↑
        Что проверять? Контента еще нет!
```

**Проблемы**:
- Analyze не может проверить несуществующий контент
- Может проверять только логичность плана, но это уже сделано на этапе clarify
- Чрезмерный анализ приводит к «параличу перфекциониста», невозможно начать писать черновик

## Реальные сценарии использования

### Сценарии использования analyze в spec-kit

**Время**: после завершения tasks.md, перед implement

**Типичный диалог**:
```
User: /tasks
AI: Список задач сгенерирован, включает 23 задачи

User: /analyze
AI:
Анализ завершен!

【Анализ покрытия】
✅ Все требования P0 имеют соответствующие задачи
⚠️  В спецификации отсутствует task для функции "уведомления пользователя"
❌ В data-model.md отсутствует задача CRUD для сущности Comment

【Анализ согласованности】
✅ Plan использует PostgreSQL, задачи корректно настроены для базы данных
❌ Спецификация требует "обновления в реальном времени", но в плане не указан WebSocket

Рекомендации:
1. Добавить 3 задачи для функции уведомлений
2. Добавить 4 задачи для CRUD Comment
3. Дополнить план решением WebSocket

Исправьте эти проблемы перед запуском /implement
```

### Сценарии использования analyze в novel-write

**Время**: после написания 5-10 глав или завершения тома

**Типичный диалог**:
```
User: /write (завершено 1-5 глав)

User: /analyze
AI:
Комплексный отчет об анализе

【Соответствие конституции】8/10
✅ Соответствует основным ценностям
⚠️ Ритм в главе 3 немного медленный, что может повлиять на удержание читателя

【Соответствие спецификациям】7/10
✅ Основной элемент P0 "конфликт родителей и детей" полностью раскрыт
❌ Основной элемент P0 "создание интриги" недостаточен, в конце главы 5 должен быть поворотный момент

【Качество контента】
- Плотность сюжета: средняя
- Последовательность персонажей: главный герой реагирует на одно и то же событие противоречиво в главах 2 и 4
- Ритм: первые 3 главы медленные, ускорение в главах 4-5 обосновано

【Предложения по улучшению】
P0 (срочно):
1. Исправить противоречие в характере главного героя (главы 2 vs 4)
2. Добавить создание интриги в конце главы 5

P1 (оптимизация):
1. Главу 3 можно сократить на 20% для улучшения ритма
```

## Заключение

### Различие в расположении команды analyze является обоснованным

| Проект | Расположение команды | Причина |
|-----|---------|------|
| **spec-kit** | tasks → **analyze** → implement | Превентивная проверка, снижение затрат на реализацию |
| **novel-write** | tasks → write → **analyze** | Оценочная проверка, защита творческого потока |

### Принципы дизайна

**Инженерная деятельность** (код):
- Следовать принципу "Семь раз отмерь, один раз отрежь"
- Предварительная проверка позволяет избежать переделок
- analyze перед implement

**Художественная деятельность** (роман):
- Следовать принципу "Лучше сделано, чем идеально"
- Черновик допускает несовершенство, доработка происходит позже
- analyze после write

### Единая философия методологии

Несмотря на разное расположение analyze, оба случая следуют основной идее **Specification-Driven Development**:

```
Specification (что) → Plan (как) → Execute (сделать) → Verify (проверить)
```

Различие заключается в **времени Verify**:
- Код: verify перед Execute (превентивно)
- Роман: verify после Execute (оценочно)

Это различие демонстрирует **гибкость методологии SDD**: одна и та же концептуальная рамка адаптирует детали реализации в зависимости от особенностей области.

### Рекомендации для пользователей

**При разработке ПО с использованием spec-kit**:
- ✅ Обязательно запускайте analyze перед implement
- ✅ Корректируйте plan/tasks в соответствии с отчетом analyze
- ✅ Начинайте кодирование только после того, как analyze пройдет все проверки

**При создании романов с использованием novel-write**:
- ✅ Сосредоточьтесь на написании, не прерывайте себя частым анализом в процессе
- ✅ Запускайте analyze после накопления определенного объема (5-10 глав или том)
- ✅ Проводите массовую редактуру в соответствии с отчетом analyze

---

**Итоговое резюме**: Это не ошибка дизайна, а **обоснованное различие, обусловленное спецификой области**. Коду нужен "всезнайка до события", роману — "всезнайка после события".

---

## Приложение: Интеллектуальный двухрежимный дизайн (добавлено в v0.12.0)

### Проблема: Оба требования разумны

После обсуждения сообществом мы обнаружили, что оба типа анализа analyze имеют ценность:

1. **Анализ фреймворка перед написанием** (предложение Цзэн Сишэна)
   - Проверка согласованности спецификаций, планов и задач
   - Обеспечение достаточной подготовки перед началом написания
   - Предотвращение обнаружения проблем дизайна в середине процесса написания

2. **Анализ контента после написания** (исходный дизайн)
   - Проверка качества написанного контента
   - Проверка соответствия спецификациям
   - Предоставление предложений по улучшению

### Решение: Одна команда, два интеллектуальных режима

Придерживаясь **принципа сдержанности** (избегая взрыва команд), мы реализовали **интеллектуальный двухрежимный analyze**:

```bash
/analyze  # Автоматически определяет, какой анализ следует выполнить
```

### Логика интеллектуального определения

Система автоматически определяет текущую стадию творчества и решает, какой анализ выполнить:

```
Количество глав = 0     → Анализ фреймворка (подготовительная стадия)
Количество глав < 3     → Анализ структуры (рекомендуется продолжить написание)
Количество глав ≥ 3     → Анализ содержания (проверка качества)
```

### Режим ручного управления

Позволяет пользователю явно указать тип анализа:

```bash
/analyze --type=framework  # Принудительный анализ структуры
/analyze --type=content    # Принудительный анализ содержания
```

### Сравнение двух режимов анализа

| Параметр | Анализ структуры | Анализ содержания |
|---|---|---|
| **Время выполнения** | до `write` | после `write` |
| **Объект анализа** | Документы со спецификациями/планами/задачами | Завершенные главы |
| **Основная цель** | Проверка готовности | Проверка соответствия стандартам качества |
| **Проверяемые пункты** | Полнота охвата, согласованность, предупреждения о логических ошибках | Соответствие конституции (правилам), соответствие спецификациям, качество контента |
| **Рекомендации по выводу** | Исправление противоречий в документах, добавление недостающих задач | Исправление проблем контента, оптимизация качества глав |

### Пример практического использования

#### Пример 1: Этап подготовки к написанию

```bash
Пользователь: /tasks
AI: Сгенерировано 28 задач для написания

Пользователь: /analyze
AI: Обнаружен пустой контент глав, выполняется анализ согласованности структуры...

【Анализ полноты охвата】
⚠️ Спецификация "Описание злодея" не соответствует ни одной задаче
❌ В плане, главы 10-12, отсутствуют разбитые задачи

【Оценка готовности】6/10
Рекомендация: исправьте указанные проблемы перед началом написания
```

#### Пример 2: После завершения нескольких глав

```bash
Пользователь: /write (завершены главы 1-7)

Пользователь: /analyze
AI: Обнаружено 7 завершенных глав, выполняется анализ качества содержания...

【Соответствие конституции】8/10 ✅
【Соответствие спецификациям】7/10 ⚠️ P0 требования охвачены на 67%
【Качество содержания】7.5/10 ⚠️ 2 логических несоответствия

【Рекомендации по улучшению】
P0: Исправить противоречия во временной линии, противоречия в способностях персонажей
P1: Добавить интригу в главу 5

【Рекомендация】: после исправления проблем P0, продолжайте создавать главы 8-10
```

### Философия дизайна

**Сдержанность, но не упрощение**:
- ❌ Не создавать отдельные команды `/framework-analyze` и `/content-analyze`
- ✅ Одна команда `/analyze`, которая интеллектуально определяет сценарий
- ✅ Поддержка ручного указания режима (для продвинутых пользователей)
- ✅ Автоматическая обработка 90% сценариев, ручное управление — 10%

**Принцип сдержанности WeChat**:
- Мощный функционал, но лаконичные команды
- Интеллектуальная система, не обременяющая пользователя
- Продвинутые функции скрыты, не мешая обычному использованию

### Техническая реализация

Подробности см. в `templates/commands/analyze.md` и `scripts/bash/check-analyze-stage.sh`

---

**Резюме**: Интеллектуальный двухрежимный дизайн удовлетворяет обеим потребностям анализа, сохраняя при этом лаконичность команды. Это идеальный пример баланса между **принципом сдержанности** и **потребностями пользователя**.