```markdown
# Spec-Kit Руководство по практическому программированию: Методология разработки, управляемой спецификациями (SDD)

> Практическое руководство по Spec-Kit для китайских разработчиков
> Создание платформы онлайн-образования «Интеллектуальный класс» с нуля

---

## 0. Начало работы с Spec-Kit

### Установка инструмента командной строки Specify

Spec-Kit предоставляет инструмент командной строки `specify` для быстрого инициализации проектов. Выберите любой из следующих способов установки:

#### Способ 1: Постоянная установка (рекомендуется)

Установите один раз и используйте везде:

```bash
uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
```

После установки можно использовать напрямую:

```bash
specify init <имя проекта>
specify check
```

Обновление инструмента:

```bash
uv tool install specify-cli --force --from git+https://github.com/github/spec-kit.git
```

#### Способ 2: Одноразовое использование

Не требуется установка, запускайте напрямую:

```bash
uvx --from git+https://github.com/github/spec-kit.git specify init <имя проекта>
```

### Инициализация проекта

Используйте команду `specify init` для инициализации проекта Spec-Kit:

```bash
# Создание нового проекта
specify init my-project

# Указание AI-агента
specify init my-project --ai claude

# Инициализация в текущем каталоге
specify init . --ai claude
# Или используйте флаг --here
specify init --here --ai claude

# Принудительное слияние в непустой каталог (пропустить подтверждение)
specify init . --force --ai claude
```

### Поддерживаемые AI-агенты

| AI-агент | Статус поддержки | Примечания |
|---------|-----------------|------------|
| [Claude Code](https://www.anthropic.com/claude-code) | ✅ | |
| [GitHub Copilot](https://code.visualstudio.com/) | ✅ | |
| [Gemini CLI](https://github.com/google-gemini/gemini-cli) | ✅ | |
| [Cursor](https://cursor.sh/) | ✅ | |
| [Windsurf](https://windsurf.com/) | ✅ | |
| [Qwen Code](https://github.com/QwenLM/qwen-code) | ✅ | |
| [opencode](https://opencode.ai/) | ✅ | |
| [Roo Code](https://roocode.com/) | ✅ | |

### Предварительные требования

- **Операционная система**: Linux/macOS (или Windows WSL2)
- **AI-агент**: Любой из поддерживаемых инструментов программирования AI
- **Python**: 3.11+
- **Менеджер пакетов**: [uv](https://docs.astral.sh/uv/)
- **Система контроля версий**: [Git](https://git-scm.com/downloads)

---

## 1. Основная концепция: Сущность разработки, управляемой спецификациями

### Что такое разработка, управляемая спецификациями?

**SDD (Spec-Driven Development)** — это революционная методология разработки программного обеспечения, основной идеей которой является:

> **Спецификации больше не служат коду, код служит спецификациям**

**Трудности традиционной разработки ПО**:
```
Документ с требованиями (Word) → Документ проектирования (Visio) → Кодирование → Тестирование → Запуск
    ↓               ↓                ↓      ↓
  Устарел         Не соответствует коду       Реальность   Исправление
```
Результат: Документация всегда отстает, в итоге «код — это документация»

**Цикл разработки, управляемый SDD**:
```
Конституция проекта → Спецификации функций → Уточняющие решения → Технический план → Декомпозиция задач
                                              ↓
                                          Контроль качества
                                              ↓
                                          Автоматическая реализация кода
  ↑                                           ↓
  └────── Обнаружение проблем, возврат к соответствующему уровню для изменения спецификаций ──────┘
```

### Почему сейчас необходим SDD?

**Три тенденции делают SDD неизбежным:**

1. **Прорыв в возможностях ИИ**: LLM, такие как GPT-4/Claude, могут понимать спецификации на естественном языке и генерировать исполняемый код.
2. **Взрывной рост сложности**: Современные системы интегрируют десятки компонентов, таких как Redis, MQ, микросервисы, и поддерживать их согласованность вручную становится все труднее.
3. **Ускорение изменений требований**: В условиях гибкой разработки требования меняются еженедельно. Традиционные методы изменения требований приводят к катастрофе, SDD требует только обновления спецификаций и повторной генерации.

**Ключевое понимание SDD**:

Традиционная разработка: Код — это истина, документация — это придаток → Код постоянно развивается, документация постепенно устаревает.

SDD меняет это соотношение: **Спецификация — это истина, код — это ее выражение на Java/Python/Go**.
- Поддержка ПО = Развитие спецификаций
- Отладка ошибок = Исправление логических ошибок в спецификациях
- Рефакторинг = Реорганизация структуры спецификаций

### SDD — это не линейный процесс, а рекурсивный цикл

**❌ Неправильное понимание: Однократное линейное выполнение**
```
Весь проект: Конституция → Спецификации → План → Задачи → Реализация (ручное написание 100 функций)
                                      ↑
                              Всегда ручное кодирование здесь
```

**✅ Правильное понимание: Многоуровневая рекурсия**
```
Уровень 1 - Весь проект:   Конституция → Спецификации (архитектура) → Выбор технологий
           ↓
Уровень 2 - Отдельная функция:   Спецификации → Уточнение → План → Задачи → Контроль качества → Реализация
           ↓
Уровень 3 - Функциональный модуль:   План → Задачи → Реализация
           ↓
Уровень 4 - Отдельная задача:   Реализация
```

**Полный цикл SDD может быть выполнен на каждом уровне!** В этом суть методологии.

---

## 2. Подробное описание семи шагов

### Основной поток команд

**Описание формата команды**:
- **Полный формат**: `/speckit.xxx` — официальный вариант написания с четко определенным пространством имен.
- **Сокращенный формат**: `/xxx` — удобный вариант, фактически выполняет то же самое.
- Для краткости в этом документе в большинстве примеров используется сокращенный формат.

SDD предоставляет следующие основные команды для выполнения полного процесса разработки:

```
1. /speckit.constitution (или /constitution)  →  Конституция проекта (высшие принципы, определяющие ДНК проекта)
2. /speckit.specify (или /specify)            →  Спецификации функций (единственный источник истины, определяющий ЧТО делать и ПОЧЕМУ)
3. /speckit.clarify (или /clarify)            →  Уточняющие решения (устранение неоднозначности, маркировка точек для подтверждения) [Необязательно, рекомендуется]
4. /speckit.plan (или /plan)                  →  Технический план (определение КАК делать, выбор технологического стека)
5. /speckit.tasks (или /tasks)                →  Декомпозиция задач (выполнимые шаги, обозначение параллельности)
6. /speckit.analyze (или /analyze)            →  Контроль качества (проверка согласованности, КРИТИЧЕСКИЕ проблемы обязательны к исправлению) [Необязательно, рекомендуется]
7. /speckit.implement (или /implement)        →  Выполнение реализации (генерация кода в стиле TDD)
```

**Дополнительные расширенные команды:**
- `/speckit.checklist` (или `/checklist`) — Генерация контрольного списка качества, специфичного для домена.
  - **Когда использовать**: Для областей с высоким риском (безопасность/производительность/соответствие требованиям/UX) генерируется подробный контрольный список.
  - **Время выполнения**: После `/plan` или `/tasks`, в качестве специализированного дополнения к `/analyze`.
  - **Отличие от analyze**: `analyze` — это общая автоматическая проверка, `checklist` — это целенаправленная проверка с точки зрения эксперта в данной области.

### Основные обязанности каждой команды

| Команда | Входные данные | Выходные данные | Ключевые ограничения |
|------|-----------------|-----------------|---------------------|
| `/speckit.constitution` | Идея проекта | `constitution.md` | Определение бескомпромиссных принципов |
| `/speckit.specify` | Описание функции | `spec.md` | Писать только ЧТО/ПОЧЕМУ, не КАК |
| `/speckit.clarify` | Документ спецификаций | Обновленный документ спецификаций | Принудительное решение всех точек для подтверждения |
| `/speckit.plan` | Спецификации + выбор технологий | `plan.md` + `data_model.md` | Должен пройти проверку конституции |
| `/speckit.tasks` | Технический план | `tasks.md` | Обозначение зависимостей и параллельности |
| `/speckit.analyze` | Спецификации + план + задачи | Отчет об анализе | **Только чтение**, не изменяет файлы |
| `/speckit.implement` | Список задач | Код + тесты | Строго TDD: сначала тесты, потом реализация |
| `/speckit.checklist` | Документ спецификаций | Контрольный список качества | Проверка полноты и согласованности требований |

### Механизм контроля качества семи шагов

```
Конституция ──→ Спецификации ──→ Уточнение ──→ План ──→ Задачи
         ↓         ↓        ↓        ↓
     [Маркировка неоднозначности] [Решение неоднозначности] [Контроль конституции] [Контроль задач]
                                     ↓
                                 Контроль качества ←── КРИТИЧЕСКИЕ проблемы блокируют
                                     ↓
                                   Реализация
```

**`/speckit.analyze` — ключевой механизм контроля качества**:
- **Принудительно запускается** после завершения `/speckit.tasks` и перед `/speckit.implement`.
- Обнаруживает 6 типов проблем: дублирование, неоднозначность, полнота покрытия, нарушение конституции, несогласованность, дрейф терминологии.
- Уровни: КРИТИЧЕСКИЙ (обязательно) / ВЫСОКИЙ (рекомендуется) / СРЕДНИЙ (улучшение) / НИЗКИЙ (необязательно).
- **При наличии КРИТИЧЕСКИХ проблем блокируется `/speckit.implement`**.

### Как применять семишаговый процесс на каждом уровне

| Уровень | Конституция | Спецификации | Уточнение | План | Задачи | Контроль качества | Реализация |
|------|-------------|--------------|-----------|------|--------|-------------------|------------|
| **Весь проект** | ✅ Однократно | ✅ Высокоуровневая архитектура | ✅ Ключевые решения | ✅ Выбор технологий | ✅ Список функций | ✅ Проверка архитектуры | - |
| **Отдельная функция** | Наследуется | ✅ Спецификации функций | ✅ Детали | ✅ План реализации | ✅ Задачи разработки | ✅ **Обязательно** | ✅ Генерация кода |
| **Функциональный модуль** | Наследуется | Наследуется | - | ✅ Проектирование модуля | ✅ Подзадачи | ✅ Необязательно | ✅ Код модуля |
| **Отдельная задача** | Наследуется | Наследуется | - | - | - | - | ✅ Код задачи |

---

## 3. Практический пример: Платформа онлайн-образования «Интеллектуальный класс»

### Предыстория проекта

- **Название проекта**: Интеллектуальный класс
- **Тип проекта**: Платформа онлайн-образования K12
- **Основные функции**: Управление курсами, проверка домашних заданий, онлайн-экзамены, анализ успеваемости.
- **Технологический стек**: Spring Boot 3.x + Vue 3 + MySQL 8.0 + Redis
- **Цель**: Демонстрация полного процесса SDD от нуля до рабочего приложения.

---

## Сценарий 1: Инициализация проекта — определение ДНК проекта с помощью Конституции

### Шаг 1: Создание Конституции проекта

```bash
/speckit.constitution Создать принципы проекта, фокусирующиеся на качестве кода, стандартах тестирования, соответствии требованиям образовательной сферы и производительности.
```

**Основные положения Конституции, сгенерированные ИИ**:

```markdown
# Конституция проекта «Интеллектуальный класс»

## Статья 1: Принцип приоритета модулей

Каждая функция должна сначала проектироваться как независимый модуль. Запрещается прямое внедрение бизнес-логики в основной код приложения, необходимо сначала абстрагировать ее в многократно используемый компонент уровня Service.

**Причина**: Принуждение к модульности, многократному использованию и тестируемости.

## Статья 2: Принцип четких интерфейсов

Все Service должны определять четкие интерфейсы:
- RESTful API: Единый формат ответа `Result<T>`
- Обработка ошибок: Бизнес-исключения `BusinessException`, системные исключения перехватываются единообразно.
- Поддержка формата JSON, имена полей в стиле camelCase.

**Причина**: Обеспечение согласованности интерфейсов между фронтендом и бэкендом, упрощение Mock-тестирования.

## Статья 3: Принцип приоритета тестирования (не подлежит обсуждению)

Запрещается писать реализационный код до завершения следующих шагов:
1. Контракты API определены (спецификация OpenAPI)
2. Написаны и прошли ревью тестовые сценарии
3. Тесты запущены и подтверждено их падение (стадия красного света TDD)

**Причина**: Предотвращение непроверяемого кода, обеспечение ясности требований.

## Статья 4: Принцип безопасности данных (соответствие требованиям образовательной сферы)

Персональные данные учащихся должны:
1. Храниться в зашифрованном виде (AES-256) для номеров телефонов/идентификационных номеров.
2. Отображаться с маскированием в логах (например, 135****1234).
3. Экспорт данных требует процедуры утверждения.
4. Соответствовать требованиям «Закона о защите персональной информации».

**Последствия нарушения**: Критический уровень, блокировка запуска.

## Статья 7: Уровень простоты

- Начальная версия максимум 3 модуля Maven: `common`, `service`, `web`.
- Запрещается добавлять зависимости, «которые могут понадобиться в будущем» (например, Elasticsearch, текущего MySQL достаточно).
- Принцип YAGNI: Вам это не понадобится.

## Статья 8: Уровень против чрезмерной абстракции

- Используйте MyBatis-Plus напрямую, не оборачивайте его дополнительным слоем `BaseMapper`.
- Единое представление модели: `Entity` напрямую используется для возврата из контроллера (для небольших проектов не требуется разделение DTO/VO).

## Статья 9: Приоритет интеграционных тестов

- Используйте реальный MySQL (docker-compose), а не H2 in-memory базу данных.
- Для тестирования контроллеров используйте `@SpringBootTest` для полного запуска приложения.
- Тестовые данные управляются с помощью SQL-скриптов (`src/test/resources/data.sql`).
```

**Почему Конституция важна?**

Конституция — это «ген» проекта, определяющий **бескомпромиссные принципы**. Все последующие планы, сгенерированные с помощью `/speckit.plan`, должны пройти эти проверки, иначе `/speckit.analyze` выдаст КРИТИЧЕСКУЮ ошибку, блокирующую реализацию.

---

## Сценарий 2: Полный процесс разработки функции — от спецификации до реализации

### Шаг 2: Определение спецификаций функции (писать только ЧТО делать, а не КАК)

```bash
/speckit.specify Разработать функцию "Проверка домашних заданий". Учитель может публиковать задания (вопрос + срок + вложение), ученик может отправлять задания (поддержка загрузки изображений/PDF), учитель может проверять их онлайн и ставить оценку (0-100 баллов + текстовый комментарий). Начальная версия: 3 учителя, 30 учеников, 2 класса. Статус задания: не отправлено, отправлено, проверено, требует исправления. Ученики могут просматривать результаты проверки и историю, учителя могут подсчитывать процент сданных работ и средний балл по классу. Задания, отправленные с опозданием, должны быть отмечены красным цветом. Контроль доступа: Ученики видят только свои задания, учителя видят только задания своих классов.
```

**Вывод**: `specs/001-zuoye-pigai/spec.md`

**Ключевое содержание**:

```markdown
## Обзор функции

**Что делается**: Система онлайн-отправки и проверки домашних заданий.
**Почему**: Замена традиционной бумажной отправки и проверки, повышение эффективности проверки, сохранение записей об обучении.

## Требования к функции

### Требование 1: Публикация заданий
Учитель может создавать задания, включая следующую информацию:
- Название задания (обязательное, ≤50 символов)
- Содержание задания (обязательное, Rich Text, поддержка вставки изображений)
- Срок выполнения (обязательный, не ранее текущего времени)
- Вложение (необязательное, поддержка PDF/Word, ≤10 МБ каждое)

### Требование 2: Отправка заданий учеником
```
```json
[
  {"filename": "spec-kit.md", "source-format": "md", "source-language": "auto", "target-language": "ru-RU", "line-fist": 335, "line-last": 712, "total-lines": 2496}
]
```
学生可以提交作业答案:
- 支持上传图片(jpg/png,单张≤5MB,最多9张)
- 支持上传PDF(≤10MB)
- 可在截止时间前修改提交内容
- 逾期提交需标记(显示红色"迟交"标签)

### 需求3: 教师批改
教师可以批改已提交的作业:
- 给分: 0-100整数
- 评语: 文字评价(≤500字)
- 批改时间自动记录

### 需求4: 状态管理
作业对学生有4种状态:
- 未提交: 学生未提交,截止时间内
- 已提交: 学生已提交,等待批改
- 已批改: 教师已批改并给分
- 需修改: 教师要求学生重新提交

### 需求5: 统计功能
教师可查看班级作业统计:
- 提交率: 已提交人数/班级总人数
- 平均分: 已批改作业的平均成绩
- 分数分布: 各分数段人数

### 需求6: 权限控制
- 学生: 只能看到自己提交的作业和批改结果
- 教师: 只能看到自己任教班级的所有学生作业

## 非功能需求

### 性能要求
- 作业列表加载时间 < 1秒(100个作业内)
- 文件上传速度: 5MB文件在10秒内完成

### 数据安全
- 学生姓名和学号符合《个人信息保护法》,日志脱敏
- 作业内容和批改记录保留1年

### 待确认点
- [待确认] 学生逾期是否还能提交? 还是直接锁定?
  - 方案A: 允许逾期提交,但标记"迟交",教师可酌情扣分
  - 方案B: 截止时间后禁止提交

- [待确认] 批改后学生是否可申诉?
  - 方案A: 不支持申诉,教师批改为最终结果
  - 方案B: 学生可发起申诉,教师重新批改

## 用户故事

### 用户故事1: 教师发布作业
**作为** 数学老师张老师
**我想要** 在系统中创建一个作业"第三章练习题"
**以便于** 学生在线提交,我可以集中批改

**验收标准**:
- 输入标题、内容、截止时间(2024-06-30 23:59)
- 上传附件"练习题.pdf"
- 点击"发布"后,2个班级(初一(1)班、初一(2)班)的学生都能看到

### 用户故事2: 学生提交作业
**作为** 初一(1)班学生小明
**我想要** 上传我的作业答案照片
**以便于** 老师批改

**验收标准**:
- 拍摄3张作业照片,上传成功
- 提交后状态变为"已提交"
- 如果在截止时间(2024-06-30 23:59)后提交,显示红色"迟交"标签

### 用户故事3: 教师批改作业
**作为** 张老师
**我想要** 批改小明的作业
**以便于** 给出成绩和反馈

**验收标准**:
- 查看小明上传的3张照片
- 给分: 85分
- 评语: "计算过程清晰,但第3题粗心算错了"
- 保存后,小明可以看到批改结果

## 边界情况

### 边界1: 截止时间恰好到达时提交
学生在2024-06-30 23:59:58提交,是否算逾期?
**决策**: 截止时间当分钟内提交都算准时(≤23:59:59)

### 边界2: 文件上传失败
学生上传5MB图片,网络超时失败。
**处理**: 前端显示"上传失败,请重试",已上传的其他图片保留

### 边界3: 教师误批
教师给小明打了58分,发现输错了,应该是85分。
**处理**: 教师可以重新批改,覆盖之前的成绩和评语
```

**注意**:
- ✅ 专注于做什么(功能需求)和为什么(业务目标)
- ✅ 标记了2个待确认点,等待`/speckit.clarify`解决
- ❌ 没有提及MySQL、Redis、MyBatis等技术细节

### 步骤3: 澄清待确认点

```bash
/speckit.clarify
```

**AI自动分析并提问**:

```markdown
## 待确认问题

### 问题1: 逾期提交策略(需求2相关)
当前规格不明确。可选方案:

**方案A: 允许逾期提交(推荐)**
- 优点: 灵活,教师可酌情给分
- 缺点: 可能被滥用
- 实现: 数据库加字段`is_late`标记

**方案B: 截止后禁止提交**
- 优点: 规则严格,培养时间观念
- 缺点: 学生忘记截止时间会投诉
- 实现: Controller判断时间,超时返回403

**建议**: 教育场景选方案A,给学生改正机会。

用户选择: 方案A
```

**AI更新规格文档**:

```markdown
### 需求2: 学生提交作业(已更新)

学生可以提交作业答案:
- 支持上传图片(jpg/png,单张≤5MB,最多9张)
- 支持上传PDF(≤10MB)
- 可在截止时间前修改提交内容
- **逾期提交策略**: 允许逾期提交,但前端显示红色"迟交"标签,教师可酌情扣分
```

**问题2: 批改后申诉机制**

```markdown
**方案A: 不支持申诉(推荐MVP)**
- 优点: 简单,减少争议
- 缺点: 教师误批无法纠正?
- 实现: 无需额外表设计

**方案B: 支持申诉流程**
- 优点: 公平,可纠错
- 缺点: 复杂,需要申诉表、通知机制
- 实现: 需要`homework_appeal`表 + 消息推送

**建议**: 初始版本选方案A,但教师可自行修改批改结果(等同简化版申诉)。

用户选择: 方案A,但允许教师修改
```

**澄清完成,所有待确认点已解决**。

### 步骤4: 制定技术方案(开始涉及怎么做)

```bash
/speckit.plan 使用Spring Boot 3.2 + MyBatis-Plus + MySQL 8.0 + Redis作为缓存。文件上传使用阿里云OSS,统计数据用Redis缓存5分钟。前端Vue3 + Element Plus,图片预览用viewerjs。
```

**输出**: `specs/001-zuoye-pigai/plan.md`, `data-model.md`, `contracts/api-spec.yaml`

**技术方案关键内容**:

```markdown
## 技术架构

### 技术选型
- **后端框架**: Spring Boot 3.2.5
- **ORM**: MyBatis-Plus 3.5.6(简化CRUD)
- **数据库**: MySQL 8.0
- **缓存**: Redis 7.0(缓存班级统计数据)
- **文件存储**: 阿里云OSS(存储作业附件和学生提交的图片)
- **前端**: Vue 3.3 + Element Plus + Axios
- **图片预览**: viewerjs

### 第0阶段: 实现前检查(宪法关卡)

#### 简单性关卡(第七条)
- [✅] 使用≤3个Maven模块?
  是: homework-common、homework-service、homework-web
- [✅] 无未来导向功能?
  是: 不引入Elasticsearch(当前MySQL够用)

#### 反过度抽象关卡(第八条)
- [✅] 直接使用框架?
  是: 用MyBatis-Plus BaseMapper,不再封装
- [⚠️] 单一模型表示?
  否: 分离Entity和VO(理由: Entity包含敏感字段如`student_id_card`,VO需要脱敏)
  **复杂度跟踪**: 已记录,用户审批

#### 测试先行关卡(第三条)
- [✅] 契约已定义?
  是: 见`contracts/api-spec.yaml`
- [⏳] 契约测试已写?
  待执行: 在`/speckit.tasks`阶段完成

### 核心实现阶段

#### 阶段1: 数据层搭建
1. 创建MySQL表: `homework`(作业表)、`homework_submission`(提交表)、`homework_review`(批改表)
2. 实现Entity: HomeworkEntity、HomeworkSubmissionEntity、HomeworkReviewEntity
3. MyBatis-Plus Mapper: HomeworkMapper、SubmissionMapper、ReviewMapper
4. 数据初始化: 3个教师、30个学生、2个班级

#### 阶段2: 业务层实现
1. HomeworkService: 发布作业、查询作业列表
2. SubmissionService: 提交作业、查询提交记录、判断逾期
3. ReviewService: 批改作业、修改批改
4. StatisticsService: 计算提交率、平均分(Redis缓存5分钟)

#### 阶段3: 接口层实现
1. HomeworkController: POST /api/homework(发布), GET /api/homework/list(列表)
2. SubmissionController: POST /api/submission(提交), GET /api/submission/:id(详情)
3. ReviewController: POST /api/review(批改), PUT /api/review/:id(修改)
4. FileController: POST /api/file/upload(OSS上传)

#### 阶段4: 前端页面
1. 教师端: 作业发布页、批改页、统计页
2. 学生端: 作业列表页、提交页、结果查看页
3. 公共组件: 文件上传组件、图片预览组件
```

**数据模型(data-model.md)**:

```markdown
## 数据表设计

### 作业表(homework)
```sql
CREATE TABLE homework (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '作业ID',
  title VARCHAR(50) NOT NULL COMMENT '作业标题',
  content TEXT NOT NULL COMMENT '作业内容(富文本)',
  teacher_id BIGINT NOT NULL COMMENT '发布教师ID',
  class_ids VARCHAR(200) NOT NULL COMMENT '班级ID列表(JSON数组)',
  deadline DATETIME NOT NULL COMMENT '截止时间',
  attachment_url VARCHAR(500) COMMENT '附件OSS地址',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_teacher_id (teacher_id),
  INDEX idx_deadline (deadline)
) COMMENT='作业表';
```

### 提交表(homework_submission)
```sql
CREATE TABLE homework_submission (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  homework_id BIGINT NOT NULL COMMENT '作业ID',
  student_id BIGINT NOT NULL COMMENT '学生ID',
  content TEXT COMMENT '提交内容(文字)',
  image_urls TEXT COMMENT '图片地址列表(JSON数组)',
  pdf_url VARCHAR(500) COMMENT 'PDF地址',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1未批改 2已批改 3需修改',
  is_late TINYINT NOT NULL DEFAULT 0 COMMENT '0准时 1逾期',
  submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_homework_student (homework_id, student_id),
  INDEX idx_student_id (student_id),
  INDEX idx_status (status)
) COMMENT='作业提交表';
```

### 批改表(homework_review)
```sql
CREATE TABLE homework_review (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  submission_id BIGINT NOT NULL COMMENT '提交ID',
  teacher_id BIGINT NOT NULL COMMENT '批改教师ID',
  score TINYINT NOT NULL COMMENT '分数0-100',
  comment VARCHAR(500) COMMENT '评语',
  reviewed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '批改时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_submission (submission_id),
  INDEX idx_teacher_id (teacher_id)
) COMMENT='批改表';
```
```

**API契约(contracts/api-spec.yaml)**:

```yaml
openapi: 3.0.0
info:
  title: 智慧课堂-作业批改API
  version: 1.0.0

paths:
  /api/homework:
    post:
      summary: 发布作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [title, content, classIds, deadline]
              properties:
                title:
                  type: string
                  maxLength: 50
                  example: "第三章练习题"
                content:
                  type: string
                  example: "<p>完成第45-50页习题</p>"
                classIds:
                  type: array
                  items:
                    type: integer
                  example: [1, 2]
                deadline:
                  type: string
                  format: date-time
                  example: "2024-06-30T23:59:59"
                attachmentUrl:
                  type: string
                  example: "https://oss.example.com/homework/xxx.pdf"
      responses:
        '200':
          description: 发布成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'

  /api/submission:
    post:
      summary: 提交作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [homeworkId]
              properties:
                homeworkId:
                  type: integer
                  example: 1
                content:
                  type: string
                  example: "我的答案是..."
                imageUrls:
                  type: array
                  items:
                    type: string
                  example: ["https://oss.example.com/sub/1.jpg", "https://oss.example.com/sub/2.jpg"]
                pdfUrl:
                  type: string
      responses:
        '200':
          description: 提交成功

  /api/review:
    post:
      summary: 批改作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [submissionId, score]
              properties:
                submissionId:
                  type: integer
                score:
                  type: integer
                  minimum: 0
                  maximum: 100
                  example: 85
```
```json
{
  "comment": {
    "type": "string",
    "maxLength": 500,
    "example": "计算过程清晰,但第3题粗心算错了"
  },
  "responses": {
    "200": {
      "description": "批改成功"
    }
  }
}
```

```json
{
  "components": {
    "schemas": {
      "Result": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "example": 200
          },
          "message": {
            "type": "string",
            "example": "操作成功"
          },
          "data": {
            "type": "object"
          }
        }
      }
    }
  }
}
```

### Шаг 5: Декомпозиция на исполняемые задачи

```bash
/speckit.tasks
```

**Вывод**: `specs/001-zuoye-pigai/tasks.md`

```markdown
## Декомпозиция задач

### Фаза 0: Создание каркаса и контрактов

#### Задача 001 [Параллельно] - Создание структуры проекта
- Инициализация проекта Spring Boot (maven)
- Создание 3 модулей: common, service, web
- Конфигурация зависимостей pom.xml (MyBatis-Plus, Redis, OSS SDK)
- **Результат**: Проект успешно компилируется

#### Задача 002 [Параллельно] - Определение контракта API
- Копирование `contracts/api-spec.yaml` в проект
- Генерация Java DTO с помощью swagger-codegen
- **Результат**: Классы DTO могут быть использованы в Controller

#### Задача 003 [Зависимость: Задача 002] - Написание контрактных тестов
- Тест: POST /api/homework возвращает 200
- Тест: POST /api/submission без homeworkId возвращает 400
- Тест: POST /api/review с score=101 возвращает 400
- **Результат**: Все тесты не пройдены (фаза TDD Red)

### Фаза 1: Слой данных (Параллельная группа A)

#### Задача 004 [Параллельно] [Зависимость: Задача 003] - Настройка MySQL
- Запуск MySQL 8.0 с помощью docker-compose
- Создание базы данных `classroom_db`
- Выполнение DDL скриптов (homework, homework_submission, homework_review)
- **Результат**: Структура таблиц создана

#### Задача 005 [Параллельно] [Зависимость: Задача 003] - Инициализация начальных данных
- Вставка 3 преподавателей: Учитель Чжан (Математика), Учитель Ли (Китайский), Учитель Ван (Английский)
- Вставка 30 студентов: Номера студентов 1001-1030, распределены по 2 классам
- Вставка 2 классов: Седьмой класс (1), Седьмой класс (2)
- **Результат**: Начальные данные доступны для запросов

### Фаза 2: Реализация бизнес-логики (Зависимость: Фаза 1)

#### Задача 006 [Зависимость: Задача 004] - Реализация HomeworkService
- Создание HomeworkMapper (MyBatis-Plus)
- Реализация публикации задания: `publishHomework(HomeworkDTO dto)`
- Реализация запроса списка: `listHomework(Long teacherId)`
- **Результат**: Тест POST /api/homework из Задачи 003 пройден (стал Green)

#### Задача 007 [Зависимость: Задача 004] - Реализация SubmissionService
- Создание SubmissionMapper
- Реализация подачи задания: `submitHomework(SubmissionDTO dto)`
- Реализация определения просрочки: `isLate(Long homeworkId, LocalDateTime submitTime)`
- Реализация запроса: `getSubmission(Long submissionId)`
- **Результат**: Тест POST /api/submission пройден

#### Задача 008 [Зависимость: Задача 004] - Реализация ReviewService
- Создание ReviewMapper
- Реализация оценки: `reviewHomework(ReviewDTO dto)`
- Реализация изменения оценки: `updateReview(Long reviewId, ReviewDTO dto)`
- **Результат**: Тест POST /api/review пройден

### Фаза 3: Слой интерфейсов (Параллельная группа B)

#### Задача 009 [Параллельно] [Зависимость: Задача 006] - HomeworkController
- Создание Controller, внедрение HomeworkService
- Реализация POST /api/homework
- Реализация GET /api/homework/list?teacherId=1
- Проверка прав: только преподаватели могут публиковать
- **Результат**: Тесты Postman пройдены

#### Задача 010 [Параллельно] [Зависимость: Задача 007] - SubmissionController
- Реализация POST /api/submission
- Реализация GET /api/submission/:id
- Проверка прав: студенты могут запрашивать только свои подачи
- **Результат**: Фронтенд может вызывать API

#### Задача 011 [Зависимость: Задача 008] - ReviewController
- Реализация POST /api/review
- Реализация PUT /api/review/:id (изменение оценки)
- Проверка прав: преподаватели могут оценивать только задания студентов своего класса
- **Результат**: Полный процесс оценки завершен

#### Задача 012 [Параллельно] - FileController загрузка файлов
- Интеграция Aliyun OSS SDK
- Реализация POST /api/file/upload (поддержка изображений/PDF)
- Проверка размера файла: изображения ≤ 5MB, PDF ≤ 10MB
- Возврат адреса OSS
- **Результат**: Фронтенд может загружать файлы и получать URL

#### Задача 013 [Зависимость: Задача 007] - StatisticsService функции статистики
- Реализация расчета коэффициента сдачи: `calcSubmitRate(Long homeworkId)`
- Реализация расчета средней оценки: `calcAvgScore(Long homeworkId)`
- Кэширование Redis на 5 минут (ключ: `stats:homework:{id}`)
- **Результат**: GET /api/statistics/:homeworkId возвращает данные статистики

### Фаза 4: Страницы фронтенда

#### Задача 014 [Зависимость: Задача 009] - Страница публикации задания преподавателем
- Компонент Vue: HomeworkPublish.vue
- Форма: Заголовок, редактор Rich Text, выбор срока выполнения
- Вызов POST /api/homework
- **Результат**: Преподаватель может публиковать задания

#### Задача 015 [Зависимость: Задача 010, Задача 012] - Страница подачи задания студентом
- Компонент Vue: HomeworkSubmit.vue
- Компонент загрузки изображений (до 9)
- Компонент загрузки PDF
- Подсказка о просрочке (красная метка "Просрочено")
- **Результат**: Студент может подавать задания

#### Задача 016 [Зависимость: Задача 011] - Страница оценки задания преподавателем
- Компонент Vue: HomeworkReview.vue
- Предварительный просмотр изображений (viewerjs)
- Поле ввода оценки (0-100)
- Текстовое поле для комментариев
- **Результат**: Преподаватель может оценивать задания

### Фаза 5: Интеграционное тестирование и подготовка к запуску

#### Задача 017 - Сквозное тестирование
- Сценарий 1: Учитель Чжан публикует задание → Сяо Мин сдает (вовремя) → Учитель Чжан оценивает на 85 баллов
- Сценарий 2: Сяо Хун сдает задание с опозданием → Отображается красная метка
- Сценарий 3: Учитель Чжан изменяет оценку Сяо Мина на 90 баллов
- **Результат**: Все сценарии пройдены

#### Задача 018 - Проверка производительности
- Загрузка списка из 100 заданий, проверка времени отклика (цель < 1 секунды)
- Загрузка файла размером 5MB, проверка времени загрузки (цель < 10 секунд)
- **Результат**: Нефункциональные требования выполнены

## План выполнения

### Неделя 1
- Параллельные группы: Задачи 001, 002, 004, 005
- Последовательно: Задача 003 (написание контрактных тестов завершено)

### Неделя 2
- Последовательно: Задача 006 → Задача 007 → Задача 008 (слой бизнес-логики)
- Параллельный запуск: Задача 012 (загрузка файлов, независимо)

### Неделя 3
- Параллельная группа B: Задачи 009, 010 (слой Controller)
- Последовательно: Задача 011, 013

### Неделя 4
- Фронтенд: Задача 014 → Задача 015 → Задача 016
- Завершение: Задачи 017, 018 (тестирование и проверка)

## Статистические показатели
- Общее количество задач: 18
- Ожидаемая продолжительность: 4 недели
- Параллельных задач: 7
- Критический путь: Задача 002 → Задача 003 → Задача 004 → Задача 006 → Задача 009 → Задача 014 → Задача 017
```

### Шаг 6: Выполнение проверки качества (Критически важно!)

```bash
/speckit.analyze
```

**AI-выполненные проверки**:

```markdown
# Отчет об анализе спецификации

## Сводка выполнения
- Общее количество функциональных требований: 6
- Общее количество нефункциональных требований: 2
- Общее количество задач: 18
- Покрытие: 100% (8/8 требований имеют соответствующие задачи)
- **КРИТИЧЕСКИЕ проблемы: 1**
- ВЫСОКИЕ проблемы: 2
- СРЕДНИЕ проблемы: 3
- НИЗКИЕ проблемы: 1

## ❌ КРИТИЧЕСКИЕ проблемы (должны быть исправлены перед /implement)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Рекомендация |
|----|-----------|-------------|----------------|-------------------|--------------|
| C1 | Нарушение конституции | CRITICAL | Фаза 2 задач.md | Нарушение «Принципа тестирования в первую очередь» (третья статья): Задача 006 «Реализация HomeworkService» выполняется до задачи 003 «Контрактное тестирование» | Изменить зависимость: Задача 003 должна выполняться до задач 004-005, чтобы гарантировать реализацию после неудачного теста |

## ⚠️ ВЫСОКИЕ проблемы (настоятельно рекомендуется исправить)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Рекомендация |
|----|-----------|-------------|----------------|-------------------|--------------|
| H1 | Отсутствие покрытия | HIGH | Требование 4 spec.md | Для статуса «требуется изменение» нет соответствующей задачи | Добавить метод `setNeedRevision()` в ReviewService |
| H2 | Неоднозначность | HIGH | План.md Фаза 3 | «Проверка прав» не указывает, какой код ошибки возвращается при сбое | Указать: Отсутствие прав возвращает 403 с сообщением «Нет доступа» |

## 📊 Детализация покрытия

| Требование | Есть задача? | ID задачи | Примечание |
|------------|-------------|-----------|------------|
| Требование 1: Публикация задания | ✅ | Задача 006, Задача 009 | Полное покрытие |
| Требование 2: Студентская подача | ✅ | Задача 007, Задача 010 | Полное покрытие |
| Требование 3: Оценка преподавателем | ✅ | Задача 008, Задача 011 | Полное покрытие |
| Требование 4: Управление статусом | ⚠️ | Задача 007 (частично) | Отсутствует обработка статуса «требуется изменение», см. H1 |
| Требование 5: Статистика | ✅ | Задача 013 | Полное покрытие |
| Требование 6: Контроль доступа | ✅ | Задачи 009-011 | Каждый Controller имеет проверку |
| Нефункциональное 1: Производительность | ✅ | Задача 018 | Полное покрытие |
| Нефункциональное 2: Безопасность данных | ✅ | Четвертая статья конституции, автоматическое выполнение | Полное покрытие |

## 🚨 Проблемы соответствия конституции

### Нарушение третьей статьи (CRITICAL)
**Местоположение**: Фаза 2 задач.md
**Проблема**: Задача 006 "Реализация HomeworkService" зависит от Задачи 004 (база данных), но должна зависеть от Задачи 003 (неудачный контрактный тест).
**Оригинал статьи**: «Запрещается писать код реализации до тех пор, пока не подтверждено, что тест провалился».
**Исправление**: Изменить порядок зависимостей задач на: Задача 003 → Задача 004 → Задача 006

## 📈 Статистические показатели
- Коэффициент покрытия требований: 100% (8/8)
- Коэффициент отображения задач: 94% (17/18, Задача 001 — базовая настройка)
- Количество неоднозначностей: 1 (H2)
- Количество дубликатов: 0
- КРИТИЧЕСКИЕ проблемы: 1

## ⚙️ Следующие шаги

### ❌ Блокировка: Невозможно выполнить /implement
**Причина**: 1 КРИТИЧЕСКАЯ проблема (нарушение конституции)

### Необходимо исправить:
1. **Исправить C1**: Изменить порядок зависимостей задач в tasks.md
   - Изменение: Зависимость Задачи 006 изменить с `[Зависимость: Задача 004]` на `[Зависимость: Задача 003]`
   - Обоснование: Контрактные тесты должны сначала завершиться неудачно, прежде чем начинать реализацию.

2. **Решить H1**: Добавить обработку статуса «требуется изменение»
   - В Задаче 008 добавить подзадачу: «Реализовать метод `setNeedRevision()`»

### После исправления:
Снова запустить `/speckit.analyze`, чтобы убедиться, что CRITICAL=0, затем выполнить `/speckit.implement`.
```

**Ответ пользователя**:

```
Исправить C1 и H1
```

**Автоматическое исправление tasks.md AI**:

```markdown
#### Задача 003 [Зависимость: Задача 002] - Написание контрактных тестов
(Содержание без изменений)

#### Задача 004 [Зависимость: Задача 003] - Настройка MySQL  ← Изменение: добавлена зависимость от задачи 003
- docker-compose启动MySQL 8.0
- ...

#### Задача 006 [Зависимость: Задача 004, Задача 003] - Реализация HomeworkService  ← Изменение: явно указана зависимость от 003
- ...

#### Задача 008 [Зависимость: Задача 004] - Реализация ReviewService
- Создание ReviewMapper
- Реализация оценки: `reviewHomework(ReviewDTO dto)`
- Реализация изменения оценки: `updateReview(Long reviewId, ReviewDTO dto)`
- **Новое: Реализация установки статуса «требуется изменение»: `setNeedRevision(Long submissionId, String reason)`**  ← Добавлено
- **Результат**: Тест POST /api/review пройден
```

**Повторный запуск `/speckit.analyze`**:

```bash
/speckit.analyze
```

```markdown
# Отчет об анализе спецификации

## Сводка выполнения
- **КРИТИЧЕСКИЕ проблемы: 0** ✅
- ВЫСОКИЕ проблемы: 1 (H2 - спецификация кода ошибки)
- СРЕДНИЕ проблемы: 3
- НИЗКИЕ проблемы: 1

## ⚙️ Следующие шаги
✅ **Готовность**: Нет КРИТИЧЕСКИХ проблем. Проблемы HIGH/MEDIUM являются улучшениями и не блокируют реализацию.

Можно выполнить: `/speckit.implement`
```

### Шаг 7: Выполнение реализации (Генерация кода в стиле TDD)

```bash
/speckit.implement
```

**AI-выполненный процесс** (строго TDD):

```
[Задача 001] Создание структуры проекта...
✅ Создан Maven-проект, 3 модуля компилируются

[Задача 002] Определение контракта API...
✅ DTO сгенерированы из api-spec.yaml: HomeworkDTO, SubmissionDTO, ReviewDTO

[Задача 003] Написание контрактных тестов...
```java
@SpringBootTest
@AutoConfigureMockMvc
class HomeworkControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void testPublishHomework_успешно() throws Exception {
        HomeworkDTO dto = new HomeworkDTO()
            .setTitle("Упражнения третьей главы")
            .setContent("<p>Завершить страницы 45-50</p>")
            .setClassIds(Arrays.asList(1L, 2L))
            .setDeadline(LocalDateTime.of(2024, 6, 30, 23, 59));

        mockMvc.perform(post("/api/homework")
                .contentType(MediaType.APPLICATION_JSON)
                .content(JsonUtil.toJson(dto)))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200));
    }

    @Test
    void testPublishHomework_заголовок_пустой_возвращает_400() throws Exception {
        HomeworkDTO dto = new HomeworkDTO()
            .setContent("Содержание")
            .setDeadline(LocalDateTime.now().plusDays(1));

        mockMvc.perform(post("/api/homework")
                .contentType(MediaType.APPLICATION_JSON)
                .content(JsonUtil.toJson(dto)))
            .andExpect(status().isBadRequest());
    }
}
```
❌ Тест не пройден (ожидается) - Controller еще не реализован

[Задача 004] Настройка MySQL...
✅ Контейнер Docker запущен, структура таблиц создана

[Задача 005] Инициализация начальных данных...
✅ Вставлены 3 преподавателя, 30 студентов, 2 класса

[Задача 006] Реализация HomeworkService...
```java
@Service
public class HomeworkServiceImpl implements HomeworkService {

    @Autowired
    private HomeworkMapper homeworkMapper;

    @Override
    public Long publishHomework(HomeworkDTO dto) {
        HomeworkEntity entity = new HomeworkEntity();
        BeanUtils.copyProperties(dto, entity);
        entity.setCreatedAt(LocalDateTime.now());
```
```java
        homeworkMapper.insert(entity);
        return entity.getId();
    }

    @Override
    public List<HomeworkVO> listHomework(Long teacherId) {
        return homeworkMapper.selectList(
            new QueryWrapper<HomeworkEntity>()
                .eq("teacher_id", teacherId)
                .orderByDesc("created_at")
        ).stream()
         .map(this::toVO)
         .collect(Collectors.toList());
    }
}
```

[Задача 009] Реализация HomeworkController...
```java
@RestController
@RequestMapping("/api/homework")
public class HomeworkController {

    @Autowired
    private HomeworkService homeworkService;

    @PostMapping
    public Result<Long> publishHomework(@Validated @RequestBody HomeworkDTO dto,
                                        @RequestAttribute Long teacherId) {
        Long id = homeworkService.publishHomework(dto);
        return Result.success(id);
    }

    @GetMapping("/list")
    public Result<List<HomeworkVO>> listHomework(@RequestAttribute Long teacherId) {
        List<HomeworkVO> list = homeworkService.listHomework(teacherId);
        return Result.success(list);
    }
}
```
✅ Тест для задачи 003 пройден — цикл TDD завершен

... (аналогичные циклы TDD для задач 007-018)

[Задача 018] Проверка производительности...
✅ Загрузка списка из 100 домашних заданий заняла: 0.8 сек (цель < 1 сек)
✅ Загрузка изображения размером 5 МБ заняла: 7 сек (цель < 10 сек)

🎉 Все 18 задач выполнены. Функционал готов к тестированию.
```

**Финальный результат**:
- ✅ Полностью рабочий функционал "Проверка домашних заданий"
- ✅ Все 18 задач выполнены, все тесты пройдены
- ✅ Соответствие всем конституционным принципам (модульность, TDD, безопасность данных)
- ✅ Интеграция фронтенда и бэкенда, реальное использование учителями и учениками

---

## Сценарий 3: Реальный пример обнаружения проблем с помощью /analyze

### Пример: Обнаружение нарушения безопасности данных

Предположим, при запуске `/speckit.analyze` на шаге 6 было обнаружено:

```markdown
| ID | Категория | Серьезность | Расположение | Описание проблемы | Рекомендация |
|----|-----------|-------------|--------------|-------------------|--------------|
| C2 | Нарушение конституции | CRITICAL | Модель данных plan.md | Нарушение статьи 4 "Принцип безопасности данных": поле student_id_card не зашифровано | Добавить поле student_id_card_encrypted, хранящее зашифрованные AES данные |
```

**Процесс исправления**:

**Шаг 1: Определение уровня проблемы**

Это проблема уровня `/speckit.plan` (проектирование модели данных), необходимо вернуться к `/speckit.plan`.

**Шаг 2: Обновление data-model.md**

```markdown
### Таблица студентов (student) - Исправлено

```sql
CREATE TABLE student (
  id BIGINT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  student_no VARCHAR(20) NOT NULL COMMENT 'Номер студента',
  -- До исправления: id_card VARCHAR(18) COMMENT 'Номер удостоверения личности'
  id_card_encrypted VARCHAR(200) COMMENT 'Номер удостоверения личности (AES-256 зашифровано)',  ← Исправлено
  phone_encrypted VARCHAR(200) COMMENT 'Номер телефона (AES-256 зашифровано)',     ← Исправлено
  class_id BIGINT NOT NULL,
  ...
);
```
```

**Шаг 3: Обновление tasks.md**

```markdown
#### Задача 005 - Инициализация начальных данных (Обновлено)
- Вставить 30 записей студентов
- **Новое**: Шифровать номера удостоверений личности и телефонов с помощью AESUtil перед сохранением
- **Новое**: Настроить ключ шифрования (читать из переменной окружения, не коммитить в Git)
```

**Шаг 4: Повторный запуск `/speckit.analyze`**

```bash
/analyze
```

```markdown
## Сводка выполнения
- **CRITICAL проблемы: 0** ✅
- Соответствие статье 4 Конституции: Соответствует

✅ Готово к выполнению `/speckit.implement`
```

**Ключевой момент**: `/speckit.analyze` действует как компилятор, выявляя потенциальные угрозы безопасности перед "выполнением".

---

## Сценарий 4: Быстрое реагирование на изменения требований

### Изменение требований

Менеджер продукта предлагает:

```
Изменение требований: Добавить функцию "Демонстрация лучших работ" для домашних заданий. Учителя могут помечать работы с оценкой ≥ 90 как "Лучшие", чтобы они отображались на доске объявлений класса. Другие ученики могут просматривать их для обучения (без отображения имен учеников, только "Лучшая работа").
```

**Процесс обработки SDD**:

**Шаг 1: Определение уровня изменения**

| Тип изменения | Уровень влияния | Необходимо вернуться к |
|---------------|-----------------|------------------------|
| Изменение цвета кнопки | Детали реализации | `/speckit.implement` |
| Добавление поля "is_excellent" | Модель данных | `/speckit.plan` |
| Новая функция "Демонстрация" | Определение функционала | `/speckit.specify` |
| Изменение архитектуры проекта | ДНК проекта | `/speckit.constitution` |

**Текущее изменение**: Добавление новой функции → Возврат к `/speckit.specify`.

**Шаг 2: Обновление spec.md**

```markdown
### Требование 7: Демонстрация лучших работ (Новое)

Учителя могут помечать домашние задания с оценкой ≥ 90 как "Лучшие работы", которые будут отображаться на доске объявлений класса.

**Детали функции**:
- При проверке учитель может выбрать опцию "Отметить как лучшую работу".
- На доске объявлений класса отображается список лучших работ (в обратном хронологическом порядке).
- Ученики могут просматривать содержание лучших работ, но имя отправителя не отображается (отображается "Демонстрация лучшей работы").
- Учителя могут отменить пометку "Лучшая работа".

**Критерии приемки**:
- Учитель Иван проверяет работу Петра и ставит оценку 95, выбирает опцию "Лучшая работа".
- Ученица Мария из 7 "А" класса видит эту работу на доске объявлений, отображается как "Демонстрация лучшей работы".
- Мария может просмотреть детали работы, но не видит, кто ее отправил.
```

**Шаг 3: Повторное выполнение последующих шагов**

```bash
/clarify  # AI может спросить: Может ли одна работа быть помечена как несколько лучших демонстраций?
/plan     # AI обновляет plan.md, добавляет поле is_excellent в таблицу homework_submission
/tasks    # AI автоматически вставляет новые задачи
```

**Новые задачи, сгенерированные AI**:

```markdown
#### Задача 008.1 [Зависимость: Задача 008] - Функция маркировки лучших работ
- Добавить метод `markAsExcellent(Long submissionId)` в сервис ReviewService
- Добавить поле is_excellent (0 - нет, 1 - да) в таблицу homework_submission
- **Результат**: Учитель может помечать лучшие работы

#### Задача 019 [Зависимость: Задача 008.1] - API для демонстрации лучших работ
- Реализовать GET /api/excellent-homework/list?classId=1
- Деанонимизация данных: поле studentName заменить на "Демонстрация лучшей работы"
- **Результат**: Фронтенд может получать список лучших работ

#### Задача 020 [Зависимость: Задача 019] - Страница доски объявлений на фронтенде
- Компонент Vue: ExcellentHomeworkList.vue
- Отображение лучших работ (без информации об учениках)
- Возможность просмотра деталей
- **Результат**: Ученики могут просматривать лучшие работы
```

**Шаг 4: Запуск `/analyze`**

```bash
/analyze
```

```markdown
## Сводка выполнения
- **CRITICAL проблемы: 0** ✅
- Охват новых требований: 100% (3 задачи покрывают требование 7)

✅ Готово: `/speckit.implement`
```

**Шаг 5: Инкрементальная реализация**

```bash
/implement
```

AI генерирует только новые задачи 008.1, 019, 020, а не перегенерирует весь проект.

**Сравнение времени выполнения**:

| Этап | Традиционная разработка | Метод SDD |
|------|-------------------------|-----------|
| Обновление PRD | 1 час | 5 минут (редактирование spec.md) |
| Обзор дизайна | 2 часа | 0 минут (автоматически) |
| Изменение кода | 4 часа | 15 минут (/implement) |
| Проверка тестами | 2 часа | Автоматически (TDD) |
| **Итого** | **9 часов** | **20 минут** |
| **Коэффициент ускорения** | - | **27x** |

---

## Четыре. Глубокий анализ трех ключевых механизмов

### 4.1 Конституция: Как автоматически ограничивать поведение LLM

#### Девять категорий принципов Конституции (на примере "Умного класса")

| Статья | Содержание | Как обнаружить | Последствия нарушения |
|--------|------------|---------------|-----------------------|
| **Статья 1: Приоритет модулей** | Функции должны быть реализованы как отдельные сервисы | `/speckit.analyze` проверяет наличие бизнес-логики непосредственно в контроллере | Ошибка CRITICAL |
| **Статья 2: Четкость интерфейсов** | Единый формат возвращаемого значения Result<T> | `/speckit.analyze` проверяет тип возвращаемого значения контроллера | Предупреждение HIGH |
| **Статья 3: Приоритет тестирования** | Сначала пишем тесты, потом реализуем | `/speckit.implement` проверяет порядок задач | Отказ в генерации кода |
| **Статья 4: Безопасность данных** | Шифрование конфиденциальной информации при хранении | `/speckit.analyze` проверяет наличие полей `_encrypted` | Ошибка CRITICAL |
| **Статья 7: Простота** | ≤ 3 Maven модулей | Проверяется при генерации `/speckit.plan` | Требуется письменное обоснование |
| **Статья 8: Предотвращение чрезмерной абстракции** | Прямое использование MyBatis-Plus | `/speckit.analyze` проверяет наличие лишних Wrapper | Требуется обоснование |
| **Статья 9: Интеграционное тестирование** | Тестирование с использованием реальной базы данных MySQL | Проверяется при `/speckit.implement` | Пакет тестов не проходит |

#### Как Конституция применяется автоматически при `/implement`

**Пример: Применение Статьи 3 "Приоритет тестирования"**

1. **Пользователь запускает `/speckit.implement`**
2. **AI читает Статью 3 Конституции**:
   ```
   Запрещается писать код реализации до завершения следующих шагов:
   1. Написаны контрактные тесты
   2. Тесты прошли проверку пользователя
   3. Тесты запущены и подтверждено их падение
   ```
3. **AI принудительно выполняет процесс TDD**:
   ```
   [Задача 003] Написание контрактных тестов...

   @Test
   void testPublishHomework() {
       // Вызов API
       Result<Long> result = homeworkController.publishHomework(dto, 1L);
       // Проверка утверждений
       assertEquals(200, result.getCode());
   }

   ❌ Тест не пройден (ожидается) - HomeworkService еще не реализован

   [Ожидание подтверждения пользователя...]

   Пользователь: "Тесты написаны хорошо, продолжайте"

   // Только после этого AI генерирует код реализации
   [Задача 006] Реализация HomeworkService...
   ```

**Традиционное кодирование AI** vs **AI-кодирование с ограничениями Конституции**:

| Аспект | Традиционный AI | AI с ограничениями Конституции |
|--------|-----------------|------------------------------|
| Тестирование | Добавление тестов постфактум (или без них) | Принудительный приоритет тестирования |
| Архитектура | Произвольное создание модулей | ≤ 3 модулей, превышение требует обоснования |
| Безопасность данных | Возможно хранение в открытом виде | Конфиденциальные поля должны быть зашифрованы, иначе CRITICAL |
| Качество | Зависит от ручного ревью | `/speckit.analyze` автоматически обнаруживает нарушения |

#### Как настроить Конституцию для собственного проекта

**Шаг 1: Определите неприемлемые принципы**

Спросите себя:
- Какие технические решения могут привести к провалу проекта?
- Какие стандарты качества кода должны соблюдаться на 100%?
- Какими архитектурными принципами нельзя жертвовать ради сроков?

**Пример: Конституция для финансового платежного проекта**

```markdown
# Конституция проекта платежной системы

## Статья 1: Принцип идемпотентности (неприемлемо)

Все API для операций записи должны:
1. Принимать заголовок idempotency-key
2. Повторные запросы должны возвращать тот же результат, без повторного списания средств
3. Ключ идемпотентности хранится в Redis в течение 24 часов

Нарушение = CRITICAL, блокирует развертывание.

## Статья 2: Обязательное ведение аудиторских журналов

Все изменения статуса должны:
1. Регистрировать оператора, время, значения до и после изменения
2. Записываться в таблицу audit_log (только добавление)
3. Храниться 7 лет (требование регулятора)

Нарушение = CRITICAL, не проходит проверку соответствия.

## Статья 3: Точность денежных сумм

Все расчеты денежных сумм должны:
1. Использовать BigDecimal, запрещено использование float/double
2. Округление до копеек (2 знака после запятой)
3. Юнит-тесты должны покрывать граничные значения (0.01, -0.01, Max)

Нарушение = HIGH, требует исправления.

## Статья 4: Бюджет производительности

Все API должны:
1. P95 задержка < 200 мс
2. P99 задержка < 500 мс
3. Поддержка параллельной обработки 1000 QPS

Нарушение = HIGH, требует оптимизации производительности.
```

**Шаг 2: Определите контрольные точки проверки на этапе `/plan`**

```markdown
### Этап 0: Проверка перед реализацией

#### Контрольная точка идемпотентности (Статья 1)
- [ ] Все POST/PUT API принимают idempotency-key?
- [ ] Конфигурация Redis готова?
- [ ] Написаны тестовые случаи для повторных запросов?

#### Контрольная точка аудита (Статья 2)
- [ ] Создана таблица audit_log?
- [ ] Настроен AOP-срез?

#### Контрольная точка точности денежных сумм (Статья 3)
- [ ] В pom.xml запрещено использование Lombok (который генерирует builder с float)?
- [ ] Тип всех полей для сумм - BigDecimal?
```

**Шаг 3: Автоматическая проверка `/analyze`**

```bash
/analyze
```

AI автоматически сканирует:
```markdown
| ID | Категория | Серьезность | Расположение | Проблема | Рекомендация |
|----|-----------|-------------|--------------|----------|--------------|
| C1 | Нарушение конституции | CRITICAL | PaymentService.java:45 | Нарушение Статьи 3: Использование типа double для расчета сумм | Заменить на BigDecimal |
| C2 | Нарушение конституции | CRITICAL | tasks.md | Нарушение Статьи 2: Отсутствует задача аудита | Добавить задачу: Реализация AOP для аудита |
```

### 4.2 Шаблон: Руководство LLM для генерации качественных спецификаций

#### Как Шаблон ограничивает вывод LLM

**Проблема**: Прямой запрос к LLM "Напиши PRD для функции входа" приведет к расплывчатому результату.

**Традиционный Prompt** (низкое качество):
```
Пользователь: Напиши мне документ с требованиями для функции отправки домашних заданий студентами

AI: Функция отправки домашних заданий студентами включает:
1. Студенты могут загружать домашние задания после входа в систему
2. Поддерживается загрузка файлов
3. После отправки учитель может их увидеть

(Проблема: Слишком расплывчато, нет граничных условий, нет обработки ошибок)
```

**Ограничение с помощью Шаблона** (высокое качество):
```
Пользователь: /specify Функция отправки домашних заданий студентами

AI: (Читает spec-template.md)

Шаблон требует:
- ✅ Сосредоточиться на "что" и "почему", а не на "как"
- ✅ Использовать маркер [Требует уточнения] для неясных моментов
- ✅ Включить граничные случаи
- ✅ Определить измеримые критерии приемки

Сгенерированный spec.md:

## Обзор функции
**Что**: Студенты отправляют ответы на домашние задания онлайн
**Почему**: Замена бумажной подачи, облегчение хранения и проверки

## Требования к функции

### Требование 1: Загрузка файлов
Студенты могут загружать файлы с домашними заданиями.

[Требует уточнения: Какие форматы файлов поддерживаются? Изображения, PDF или Word?]
[Требует уточнения: Ограничение размера файла? 5 МБ или 10 МБ?]

## Граничные случаи

### Граничный случай 1: Превышение времени ожидания загрузки
Студент загружает файл размером 5 МБ, но сеть медленная, и загрузка не завершается за 30 секунд.
**Обработка**: Интерфейс пользователя отображает индикатор выполнения "Загрузка...", по истечении 30 секунд выводится сообщение "Пожалуйста, проверьте ваше интернет-соединение".
```
```markdown
### 边界2: 重复提交
学生提交后发现错误,想重新提交。
[待确认: 允许修改吗? 还是一次提交后锁定?]

## 非功能性需求

### Производительность
- Загрузка файла размером 5 МБ должна завершаться в течение 10 секунд (при нормальной сети)
- Поддержка одновременной загрузки 50 студентами

### Безопасность данных
- Файлы заданий хранятся в OSS с контролем доступа
- Студенты могут получить доступ только к своим заданиям, но не к чужим
```

**Сравнение**: Шаблон заставил ИИ задуматься:
1. ✅ Основные функции (требование 1)
2. ✅ Пограничные случаи (тайм-аут, повторная отправка)
3. ✅ Маркировка неоднозначности (2 пункта, требующие подтверждения)
4. ✅ Показатели производительности (конкретные цифры: 10 секунд, 50 человек)
5. ✅ Безопасность данных (контроль доступа)
6. ✅ Тестируемость (четкие критерии приемки)
7. ✅ Отсутствие технических реализаций (не упоминается OSS, MySQL)

#### [Требуется подтверждение] Механизм: Принудительное признание неопределенности ИИ

**Проблема**: LLM склонны «угадывать» недостающую информацию, что приводит к ошибочным предположениям.

**Решение**: Шаблон принудительно маркирует:

```markdown
Правила создания спецификаций:
1. **Отмечайте все неоднозначные моменты**: Используйте [Требуется подтверждение: конкретный вопрос]
2. **Не угадывайте**: Если в запросе не указано, отметьте это
3. **Предоставляйте варианты**: Предложите 2-3 альтернативных варианта
```

**Практический пример**:

Пользовательский запрос:
```
/specify Разработать функцию загрузки файлов
```

Сгенерированный ИИ (с маркировкой «Требуется подтверждение»):
```markdown
## Требование 1: Загрузка файлов

Пользователи могут загружать файлы.

[Требуется подтверждение: Какие типы файлов поддерживаются?]
- Вариант A: Только изображения (jpg, png) - подходит для сдачи заданий
- Вариант B: Документы (pdf, docx) - подходит для обмена материалами
- Вариант C: Любые файлы (высокий риск безопасности)

[Требуется подтверждение: Ограничение размера файла?]
- Вариант A: 5 МБ (стандарт для веб) - подходит для изображений
- Вариант B: 10 МБ - подходит для PDF
- Вариант C: 100 МБ - подходит для видео (требуется поддержка CDN)

[Требуется подтверждение: Где хранить?]
- Вариант A: Локальный серверный диск - просто, но трудно масштабировать
- Вариант B: Alibaba Cloud OSS/Tencent Cloud COS - рекомендуется, надежно
- Вариант C: Поле BLOB в базе данных - не рекомендуется, низкая производительность
```

**Пользователь решает на этапе `/speckit.clarify`**:
```
Пользователь: Выбрать вариант A для типов файлов (только изображения), вариант A для размера (5 МБ), вариант B для хранения (OSS)
```

Обновленная спецификация ИИ:
```markdown
### Требование 1: Загрузка файлов (уточнено)

Пользователи могут загружать файлы изображений (форматы jpg, png), размером до 5 МБ каждый, хранящиеся в Alibaba Cloud OSS.
```

#### Контрольные точки Phase Gates: Автоматическая проверка качества

**Определение**: При генерации `/speckit.plan` ИИ должен пройти контрольные точки, определенные в конституции.

**Фрагмент plan-template.md**:
```markdown
### Этап 0: Предварительная проверка реализации

#### Контрольная точка простоты (пункт седьмой)
- [ ] Использовать ≤ 3 модуля Maven?
  - Если нет: Указать причину в разделе «Отслеживание сложности»

#### Контрольная точка против чрезмерной абстракции (пункт восьмой)
- [ ] Использовать фреймворк напрямую?
  - Если нет: Объяснить, почему требуется обертка

#### Контрольная точка «Тестирование в первую очередь» (пункт третий)
- [ ] Контрактное тестирование выполняется до реализации?
  - Должно быть на этапе 0 в tasks.md
```

**Процесс выполнения ИИ `/speckit.plan`**:

```
[ИИ] Чтение конституции...
[ИИ] Пункт седьмой: Максимум 3 модуля Maven
[ИИ] Проверка плана...
[ИИ] Обнаружено: common, service, web, admin = 4 модуля
[ИИ] ❌ Контрольная точка простоты не пройдена
[ИИ] Запись в plan.md:

### Этап 0: Предварительная проверка реализации

#### Контрольная точка простоты (пункт седьмой)
- [❌] Использовать ≤ 3 модуля Maven?
  **Статус**: Не пройдено (4 модуля)
  **Причина**: Модуль admin требует отдельного контроля доступа и не может быть объединен с модулем web
  **Утверждение**: Ожидает подтверждения пользователя

[Ожидание проверки пользователем...]

Пользователь: Удалить модуль admin, начальная версия не будет включать админ-панель

[ИИ] ✅ Обновляет plan.md, удаляет модуль admin, контрольная точка простоты пройдена
```

### 4.3 Анализ качества: Шесть проверок + Четыре уровня серьезности

#### Шесть типов проверок `/analyze`

**1. Проверка на дублирование (Duplication)**

Обнаруживает похожие или повторяющиеся требования.

**Пример**:
```markdown
spec.md:
Требование 1: Студент может загружать изображение задания
Требование 5: Система поддерживает загрузку студентами изображений заданий

/analyze отчет:
| D1 | Дублирование | HIGH | Требование 1 vs Требование 5 | Оба требования описывают одну и ту же функцию | Объединить в Требование 1, удалить Требование 5 |
```

**2. Проверка на неоднозначность (Ambiguity)**

Обнаруживает расплывчатые прилагательные и неизмеримые критерии.

**Пример**:
```markdown
spec.md:
Нефункциональное требование 1: Система должна быстро реагировать

/analyze отчет:
| A1 | Неоднозначность | HIGH | Нефункциональное требование 1 | «Быстро» неизмеримо | Заменить на «Время отклика API P95 < 200 мс» |
```

**Распространенные неоднозначные слова**: быстро, медленно, хорошо, стабильно, безопасно, плавно, интуитивно

**3. Недостаточная спецификация (Underspecification)**

Обнаруживает требования, в которых отсутствуют объекты или результаты.

**Пример**:
```markdown
spec.md:
Требование 3: Учитель может удалить

/analyze отчет:
| U1 | Недостаточная спецификация | MEDIUM | Требование 3 | Отсутствует объект: что удалить? | Заменить на «Учитель может удалить опубликованные им задания» |
```

**4. Соответствие конституции (Constitution Alignment)**

Обнаруживает нарушения принципов конституции.

**Пример**:
```markdown
constitution.md:
Пункт третий: Принцип «Тестирование в первую очередь» (не подлежит обсуждению)

tasks.md:
Этап 1: Задача 001 - Реализовать HomeworkService
Этап 2: Задача 010 - Написать тесты для HomeworkService

/analyze отчет:
| C1 | Нарушение конституции | CRITICAL | Этап 1 tasks.md | Нарушение пункта третьего: Реализация до тестирования | Изменить порядок: Задача 010 должна идти перед Задачей 001 |
```

**5. Пробел в покрытии (Coverage Gap)**

Обнаруживает требования без соответствующих задач или задачи без соответствующих требований.

**Пример**:
```markdown
spec.md:
Нефункциональное требование 2: Система должна поддерживать одновременную отправку заданий 100 студентами

tasks.md:
(Задача для тестирования параллелизма не найдена)

/analyze отчет:
| G1 | Пробел в покрытии | CRITICAL | Нефункциональное требование 2 | Отсутствие покрытия задачами | Добавить задачу 020: «Нагрузочное тестирование JMeter для 100 параллельных пользователей» |
```

**6. Проверка на несоответствие (Inconsistency)**

Обнаруживает дрейф терминологии, конфликты в моделях данных.

**Пример**:
```markdown
spec.md:
Используется термин "статус задания" (не отправлено, отправлено, оценено)

data-model.md:
Имя поля: homework_state (enum)

api-spec.yaml:
Имя параметра: homeworkStatus (string)

/analyze отчет:
| I1 | Несоответствие | MEDIUM | spec/plan/contracts | Дрейф терминологии: "статус" vs "state" vs "Status" | Унифицировать до "status" (база данных, API, документация) |
```

#### Четыре уровня серьезности

| Уровень | Определение | Типичные проблемы | Как обрабатывать |
|---------|-------------|-------------------|-----------------|
| **CRITICAL** | Нарушение обязательных пунктов конституции или полное отсутствие покрытия основных функций | Несоблюдение принципа «Тестирование в первую очередь», нарушения безопасности/производительности, отсутствие задач для основных функций | **Блокирует `/speckit.implement`**, требует исправления |
| **HIGH** | Повторяющиеся/конфликтующие требования, неоднозначность требований безопасности/производительности | Два требования описывают одну и ту же функцию, отсутствие метрик для нефункциональных требований | Настоятельно рекомендуется исправить, продолжение работы сопряжено с риском |
| **MEDIUM** | Дрейф терминологии, неполное покрытие нефункциональных требований | Несоответствие status vs state, различие в терминологии между документацией и кодом | Рекомендуется исправить, не влияет на функциональность |
| **LOW** | Улучшения стиля/формулировок | Несоответствие формата идентификатора задачи (T1 vs T001), неформальные комментарии | Необязательные улучшения, не влияют на качество |

#### Типичная структура вывода `/analyze`

```markdown
# Отчет об анализе спецификаций

## Краткое резюме
- Функциональные требования: 6
- Нефункциональные требования: 2
- Общее количество задач: 18
- Покрытие: 100% (8/8 требований имеют задачи)
- **CRITICAL проблемы: 1**
- HIGH проблемы: 2
- MEDIUM проблемы: 3
- LOW проблемы: 1

## ❌ CRITICAL проблемы (требуют обязательного исправления)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Предложение |
|----|-----------|-------------|----------------|-------------------|-------------|
| C1 | Нарушение конституции | CRITICAL | Этап 2 tasks.md | Нарушение пункта третьего: Задача 006 реализована до задачи 003 | Изменить порядок зависимостей |

## ⚠️ HIGH проблемы (настоятельно рекомендуются)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Предложение |
|----|-----------|-------------|----------------|-------------------|-------------|
| H1 | Дублирование | HIGH | Требование 2 vs Требование 7 | Оба описывают "студент отправляет задание" | Объединить в Требование 2 |
| H2 | Неоднозначность | HIGH | Нефункциональное требование 1 | "Система должна быть безопасной" без стандартов | Конкретизировать: "Пройти сертификацию безопасности уровня 3" |

## 📊 Детализация покрытия

| Требование | Есть задача? | ID задачи | Примечание |
|------------|-------------|-----------|------------|
| Требование 1: Публикация задания | ✅ | Задача 006, Задача 009 | Полное покрытие |
| Требование 2: Студент отправляет задание | ✅ | Задача 007, Задача 010 | Полное покрытие |
| ...
| Нефункциональное требование 2: Параллельная производительность | ❌ | Нет | **Отсутствует** - см. G1 |

## 🚨 Проблемы соответствия конституции

### Нарушение пункта третьего (CRITICAL)
- ❌ Задача 006 "Реализовать Service" до задачи 003 "Тестировать"
- ✅ Другие задачи соответствуют порядку TDD

## 📈 Статистика
- Коэффициент покрытия требований: 88% (7/8)
- Коэффициент сопоставления задач: 94% (17/18)
- Количество неоднозначностей: 1
- CRITICAL проблемы: 1

## ⚙️ Следующие шаги

### ❌ Блокировка: Невозможно выполнить /implement
**Причина**: 1 CRITICAL проблема

### Требуется исправить:
1. **C1**: Изменить зависимости задач в tasks.md
2. **G1**: Добавить задачу для тестирования параллелизма

### После исправления:
Повторно запустить `/speckit.analyze`, убедиться, что CRITICAL = 0, затем выполнить `/speckit.implement`.
```

---

## V. Часто задаваемые вопросы и ответы

### В1: Сгенерированный ИИ код отклоняется от требований, как обновить спецификацию?

**Сценарий**: После запуска `/speckit.implement` обнаружено, что сгенерированная ИИ страница проверки оценок не имеет функции «Массовая проверка», и теперь ее нужно добавить.

**❌ Неправильный подход**:
```
Напрямую сказать ИИ: «Добавь кнопку массовой проверки»
→ ИИ добавит, но spec.md/plan.md не обновятся
→ При следующем перегенерации она снова исчезнет
```

**✅ Правильный подход**:

**Шаг 1: Определить уровень изменения**

«Массовая проверка» — это новое функциональное требование → влияет на уровень `/speckit.specify`

**Шаг 2: Вернуться к `/speckit.specify` и обновить spec.md**

```markdown
### Требование 8: Массовая проверка (новое)

Учителя могут одновременно оценивать задания нескольких студентов, повышая эффективность.

**Детали функции**:
- На странице списка заданий учитель может выбрать несколько заданий со статусом «Отправлено».
- Нажать кнопку «Массовая проверка» для входа в режим массовой проверки.
- Отображать задания по одному, учитель быстро назначает оценку и оставляет комментарий.
- Поддержка горячих клавиш: Enter для перехода к следующему, Ctrl+S для сохранения.

**Критерии приемки**:
- Учитель Чжан выбирает 5 заданий, входит в режим массовой проверки.
- Оценивает каждое задание по 10 секунд.
- После оценки 5 заданий, все они получают статус «Оценено».
```

**Шаг 3: Повторно выполнить последующие процессы**

```bash
/clarify  # ИИ может спросить: Можно ли пропустить задание при массовой проверке?
/plan     # ИИ обновляет BatchReviewService
/tasks    # ИИ автоматически вставляет новые задачи
/analyze  # Проверка на соответствие
/implement  # Генерация функции массовой проверки
```

**Ключевой принцип**:

| Тип изменения | Вернуться к | Пример |
|---------------|-------------|--------|
| Стиль UI | `/speckit.implement` | Изменить цвет кнопки на синий |
| Добавление поля | `/speckit.plan` | Добавить поле difficulty в таблицу заданий |
| Новая функция | `/speckit.specify` | Добавить массовую проверку |
| Изменение основной логики | `/speckit.specify` | Изменить оценку на автоматическую оценку ИИ |
| Архитектурное изменение | `/speckit.constitution` | Перейти на микросервисную архитектуру |

### В2: Что делать, если `/analyze` обнаруживает CRITICAL проблемы?

**Сценарий**: Запуск `/speckit.analyze` показывает:

```markdown
## CRITICAL проблемы

| C1 | Нарушение конституции | CRITICAL | tasks.md | Нарушение пункта третьего: Задача 010 реализована до задачи 009 |
```

**Процесс обработки**:

**Шаг 1: Понять значение CRITICAL**

CRITICAL = проблема, **блокирующая `/speckit.implement`**, требующая обязательного исправления, иначе:
- Нарушение конституции проекта (не подлежащие обсуждению принципы)
- Или невозможность реализации основной функции

**Шаг 2: Оценить область влияния**

```
Задача 009 - Написать модульные тесты для HomeworkService
Задача 010 - Реализовать HomeworkService  ← Неправильный порядок
```

Влияние: Реализация до тестирования нарушает принцип TDD → пункт третий конституции.

**Шаг 3: Исправить tasks.md**

**До исправления**:
```markdown
Этап 1: Бизнес-логика
- Задача 009 [параллельно] - Написать модульные тесты для HomeworkService
- Задача 010 [параллельно] - Реализовать HomeworkService  ← Ошибка!
```

**После исправления**:
```markdown
Этап 1: Бизнес-логика
- Задача 009 [параллельно] - Написать модульные тесты для HomeworkService
- Задача 010 [зависимость: Задача 009] - Реализовать HomeworkService  ← Добавлена зависимость
```

**Шаг 4: Повторно запустить `/speckit.analyze`**

```bash
/analyze
```

```markdown
## Краткое резюме
- **CRITICAL проблемы: 0** ✅
- HIGH проблемы: 2

✅ Готово к выполнению: `/speckit.implement`
```

**Ключевое**:
- ❌ Не пропускайте CRITICAL проблемы и не переходите к реализации напрямую.
- ✅ После исправления обязательно повторно запустите `/speckit.analyze` для подтверждения.
- ✅ Нарушения конституции всегда являются CRITICAL и не подлежат обсуждению.

### В3: Требования часто меняются, как быстро реагировать?

**Сценарий**: Менеджер продукта каждую неделю меняет требования, что доставляет много хлопот традиционной разработке.

**Решение SDD: Спецификация как единый источник истины**

**Проблемы традиционной разработки**:
```
Изменение требований → Обновить PRD → Уведомить разработчиков → Вручную изменить код → Повторно протестировать → Обновить документацию (часто забывают)
              ↓          ↓           ↓
           Всегда устаревает   Пропуск одного изменения   Несоответствие документации и кода
```

**Подход SDD**:
```
Изменение требований → Обновить spec.md → /plan → /tasks → /analyze → /implement
           (единый источник истины)                               ↓
                                                 Автоматическая регенерация кода
```

**Практический пример: Изменение требований к «Умному классу»**

**Неделя 1**: Первоначальные требования
```
/specify Срок сдачи задания - фиксированное время
```

**Неделя 2**: Продукт говорит, что нужно разрешить отсрочку
```
# Редактировать spec.md
```
```markdown
# 需求9: 截止时间延期 (新增)

教师可以延长作业的截止时间。

# 重新执行
/plan    # AI 自动更新 HomeworkService.extendDeadline()
/tasks   # AI 自动添加任务: "实现延期功能"
/analyze
/implement  # 只重新生成 HomeworkService，其他不变
```

**耗时**: 8分钟

**第3周**: 产品又说要支持针对单个学生延期
```
# 编辑 spec.md

### 需求9: 截止时间延期 (更新)

教师可以延长作业的截止时间:
- 全班延期: 所有学生的截止时间统一延长
- 单个学生延期: 为特定学生（如请假）单独延长

# 重新执行
/plan    # AI 添加 student_id 参数
/tasks   # AI 添加任务: "支持学生级延期"
/analyze
/implement
```

**耗时**: 10分钟

**关键优势**:
1. **单一事实来源**: spec.md 永远最新，代码从规格生成
2. **增量更新**: `/speckit.implement` 只重新生成受影响的部分
3. **自动一致性**: `/speckit.analyze` 确保规格 + 方案 + 任务 + 代码一致
4. **版本控制**: spec.md 用 Git 跟踪，变更历史清晰

**对比耗时**:

| 任务 | 传统开发 | SDD 方式 | 加速比 |
|------|---------|---------|-------|
| 添加延期功能 | 2 小时 | 8 分钟 | 15x |
| 支持学生级延期 | 3 小时 | 10 分钟 | 18x |
| 确保文档同步 | 1 小时 (常忘) | 0 分钟 (自动) | ∞ |

### Q4: 如何确保测试先行 (Test-First)?

**场景**: 希望团队严格遵守 TDD，但总有人先写代码。

**SDD 解决方案: 宪法 + /analyze 双重保障**

**机制 1: 宪法强制**

```markdown
# constitution.md

## 第三条: 测试先行原则 (不可妥协)

禁止在以下步骤完成前编写实现代码:
1. 契约测试已编写
2. 测试已通过评审
3. 测试已运行并确认失败 (TDD 红灯)

违规后果:
- /analyze 报 CRITICAL 错误
- /implement 拒绝生成代码
```

**机制 2: tasks.md 强制顺序**

```markdown
## 第 0 阶段: 契约和测试 (永远最先)

#### 任务 001 - 定义 API 契约
- 创建 OpenAPI 规范
- **交付物**: api-spec.yaml

#### 任务 002 [依赖: 任务 001] - 编写契约测试
- 测试所有端点
- **交付物**: 所有测试失败 (红灯) ← 明确要求失败

#### 任务 003 [依赖: 任务 002] - 用户审查检查点
- 用户审查测试质量
- **交付物**: 用户明确批准

## 第 1 阶段: 实现 (测试通过关卡后)

#### 任务 004 [依赖: 任务 003] - 实现 API
- 让任务 002 的测试通过
- **交付物**: 所有测试变绿
```

**机制 3: /implement 执行逻辑**

```
AI 内部逻辑:

def implement_task(task_id):
    if task_id == "任务004":  # 实现任务
        # 检查依赖
        if not is_completed("任务003"):
            raise Error("不能实现: 任务003 (测试审查) 未完成")

        # 检查测试状态
        test_results = run_tests("任务002")
        if test_results.status != "FAILED":
            raise Error("不能实现: 测试必须先失败 (TDD 红灯)")

        # 生成实现代码
        generate_implementation()

        # 验证测试变绿
        test_results = run_tests("任务002")
        if test_results.status != "PASSED":
            raise Error("实现不完整: 测试仍失败")

        return "✅ 任务004 完成: 测试现在通过"
```

**实际执行流程**:

```bash
/implement

[任务001] 定义 API 契约...
✅ 创建 api-spec.yaml

[任务002] 编写契约测试...
```java
@Test
void testPublishHomework_成功() {
    // 调用 API
    Result<Long> result = client.post("/api/homework", dto);
    // 断言
    assertEquals(200, result.getCode());
}
```
运行测试...
❌ 10/10 测试失败 (预期 - TDD 红灯)

[任务003] 等待用户审查...

用户: "测试写得很全面, 批准"

[任务004] 实现 API...
```java
@RestController
public class HomeworkController {
    @PostMapping("/api/homework")
    public Result<Long> publishHomework(@RequestBody HomeworkDTO dto) {
        Long id = homeworkService.publish(dto);
        return Result.success(id);
    }
}
```

运行测试...
✅ 10/10 测试通过 (TDD 绿灯)
```

**如果有人试图跳过测试**:

```bash
/implement

[检查前置条件...]
❌ 错误: 宪法第三条违规

tasks.md 显示:
- 任务010 [可并行] - 实现 HomeworkService  ← 无测试依赖!

要求的结构:
- 任务009 - 编写 HomeworkService 测试
- 任务010 [依赖: 任务009] - 实现 HomeworkService

必须: 修复 tasks.md 强制 TDD 顺序

运行 /analyze 查找所有违规。
```

---

## 六、最佳实践

### 1. 规格应该写到什么粒度?

**判断标准**:
- ✅ 可测试 (testable)
- ✅ 无歧义 (unambiguous)
- ❌ 不写实现 (no HOW)

**粒度对比**:

| 粒度 | ❌ 太粗 (不可测) | ✅ 恰当 (可测试) | ❌ 太细 (实现细节) |
|------|----------------|----------------|------------------|
| **功能需求** | "系统要快" | "API 响应 P95 < 200ms" | "用 Redis 缓存查询结果" |
| **用户操作** | "学生可提交作业" | "学生可上传 jpg/png, ≤ 5MB" | "前端用 axios POST 到 /api/submission" |
| **错误处理** | "系统要健壮" | "网络超时 30 秒后提示重试" | "使用 axios 的 timeout 配置 30000ms" |

**实战案例: 文件上传功能**

**❌ 太粗**:
```markdown
需求1: 学生可以上传文件
```
问题: 什么文件? 多大? 存哪? 无法写测试。

**✅ 恰当**:
```markdown
需求1: 学生可上传作业图片

**功能细节**:
- 支持格式: jpg、png
- 文件大小: 单张 ≤ 5MB, 最多 9 张
- 上传时限: 10 秒内完成 (正常网络)
- 成功后返回 OSS 地址

**验收标准**:
- 上传 1 张 3MB 的 jpg 图片 → 返回 URL
- 上传 6MB 的图片 → 提示 "文件过大"
- 上传 .docx 文件 → 提示 "格式不支持"
```
可以写自动化测试了!

**❌ 太细**:
```markdown
需求1: 学生通过 multipart/form-data POST 到 /api/file/upload 上传图片

**实现细节**:
- 后端用 MultipartFile 接收
- 调用 OSSUtil.upload() 上传到阿里云
- 返回 JSON: {"code":200,"data":"https://..."}
```
问题: 这是 `/speckit.plan` 的内容，不属于规格。

**判断方法**:

1. **能写测试吗?** 如果不能, 太粗。
2. **有多种实现吗?** 如果只有一种, 太细。
3. **换技术栈成立吗?** 如果不成立, 太细。

### 2. 何时必须使用 /clarify?

**必须使用**:
- ✅ spec.md 有 `[待确认]` 标记
- ✅ AI 生成的规格明显遗漏关键决策
- ✅ 在 `/speckit.plan` 之前强制执行

**不需要使用**:
- ❌ 规格已足够清晰 (零 `[待确认]`)
- ❌ 只是改改措辞 (直接编辑 spec.md)

**实战示例**:

```bash
# 步骤 1: /specify 生成规格
/specify 开发搜索功能, 支持按关键词查找作业

# AI 生成的规格包含:
[待确认: 搜索算法 - 精确匹配还是模糊搜索?]
[待确认: 搜索范围 - 只搜标题还是包括内容?]

# 步骤 2: 必须运行 /clarify
/clarify

AI: 发现 2 个待确认点。

问题 1: 搜索算法
方案 A: 精确匹配 (LIKE '关键词') - 简单, 但不友好
方案 B: 模糊搜索 (LIKE '%关键词%') - 推荐
方案 C: 全文搜索 (MySQL FULLTEXT 或 ES) - 复杂

用户选择: 方案 B

AI: ✅ 更新规格 → "使用 SQL 模糊匹配 (LIKE %keyword%)"

问题 2: 搜索范围
方案 A: 仅搜索标题 - 快
方案 B: 标题 + 内容 - 推荐, 体验好

用户选择: 方案 B

AI: ✅ 更新规格 → "搜索字段: title、content"

所有待确认点已解决。可以执行 /plan。
```

### 3. /analyze 的最佳使用时机

**强制运行**:
1. **After `/speckit.tasks`, before `/speckit.implement`** (最重要!)
2. **需求变更后** - 更新 spec.md 后运行
3. **Code review 前** - 确保规格与代码一致

**可选运行**:
- After `/speckit.plan`: 检查方案是否覆盖所有需求
- 每周定期: 检查规格漂移

**实战案例 1: 发现隐藏的覆盖度缺失**

```bash
# 你以为任务全覆盖了
/tasks

# 运行 analyze
/analyze

报告:
| G1 | 覆盖度缺失 | CRITICAL | 非功能需求 2 | "数据安全: 敏感信息加密" 无对应任务 |

# 你意识到: 哦对, 加密忘了!
# 添加任务
任务025 - 实现 AES-256 加密工具类 EncryptUtil

# 重新 analyze
/analyze
✅ 覆盖率: 100%
```

**实战案例 2: 早期发现术语不一致**

```bash
/analyze

报告:
| I1 | 不一致 | MEDIUM | spec vs plan | spec 用 "作业", plan 用 "homework" |

# 早期发现, 容易修复
# 如果等到代码写完, 改动范围巨大 (表名、API、变量名...)
```

### 4. 何时使用 /checklist

**定位**: 领域特定的深度质量检查，验证规格在特定领域的完整性。

**典型使用场景**:
```bash
# 高风险领域：支付/安全/合规
/plan → /checklist 支付安全 → /tasks → /analyze → /implement

# 特定领域：UX/性能/API
/specify → /checklist ux → /clarify → /plan
```

**与 /analyze 的关系**:
- `/analyze` - 必须运行，通用质量检测（重复、歧义、覆盖度等）
- `/checklist` - 可选运行，领域专家视角检查（如 "幂等性要求是否明确？"）
- 配合使用：先 `/checklist` 做深度检查，再 `/analyze` 做通用验证

**使用决策**: 高风险/关键领域（支付、安全、合规）→ 必须用；普通功能 → 不需要

### 5. 如何制定好的宪法 (Constitution)

**原则 1: 不超过 10 条**

太多原则 = 没有原则。

**原则 2: 每条都可自动检测**

如果 `/speckit.analyze` 检测不了, 不是好原则。

**❌ 不可检测**:
```markdown
第五条: 代码应该优雅且易维护
```
问题: "优雅" 和 "易维护" 无法量化。

**✅ 可检测**:
```markdown
第五条: 代码复杂度限制

所有方法必须:
- 圈复杂度 ≤ 10
- 最大嵌套层级 ≤ 3
- 方法长度 ≤ 50 行

检测方式: /analyze 阶段运行代码复杂度检查工具。
```

**原则 3: 违规后果明确**

每条原则标注违规严重性。

**宪法模板**:

```markdown
## 第 [N] 条: [原则名称]

### 规则
[具体的、可测量的要求]

### 理由
[为什么有这个原则]

### 违规处理
- 严重性: CRITICAL / HIGH / MEDIUM
- 检测方式: /analyze 如何检测
- 后果: 阻塞/警告/记录

### 例外情况
[什么情况可违反, 需要什么审批]
```

**示例: 金融系统宪法**

```markdown
## 第一条: 金额精度原则

### 规则
所有金额计算必须:
1. 使用 BigDecimal 类型, 禁止 float/double
2. 四舍五入到分 (setScale(2, RoundingMode.HALF_UP))
3. 单元测试覆盖边界值 (0.01、-0.01、Long.MAX_VALUE)

### 理由
float/double 存在精度丢失, 可能导致资金差额, 引发对账问题。

### 违规处理
- 严重性: CRITICAL
- 检测方式: /analyze 扫描代码中的 float/double 字段
- 后果: 阻塞上线, 必须修复

### 例外情况
无例外。金额精度不可妥协。
```

---

## 七、总结: SDD 的核心价值

### 传统开发 vs SDD 对比

| 维度 | 传统开发 | SDD 方式 | 提升 |
|------|---------|---------|------|
| **真相源** | 代码 (文档过时) | 规格文档 | 单一真相 |
| **需求变更** | 手工改代码 + 文档 | 更新规格重新生成 | 20-30x 加速 |
| **质量保证** | 人工 Code Review | 宪法 + /analyze 自动检测 | 自动化 |
| **测试先行** | 依赖自觉 | 强制 TDD 流程 | 100% 遵守 |
| **一致性** | 经常不一致 | /analyze 强制检测 | 0 不一致 |
| **新人上手** | 需数月 | 遵循模板即可 | 周级上手 |

### SDD 适合的项目

✅ **理想场景**:
- 新项目 (从零开始)
- 需求频繁变更
- 团队 3-20 人
- 质量要求高 (金融、医疗、教育)
- 需要快速试错

⚠️ **需要调整**:
- 遗留系统改造 - 需先 "规格化" 现有代码
- 超大型项目 (>50 人) - 需分层宪法

❌ **不适合**:
- 一次性脚本
- 纯前端 UI 调试

### 开始你的 SDD 之旅

**第 1 步: 安装 Spec-Kit**

```bash
# 使用 uv 安装 (推荐)
uv tool install specify-cli --from git+https://github.com/github/spec-kit.git

# 或使用 uvx 临时运行
uvx --from git+https://github.com/github/spec-kit.git specify init 我的项目
```

**第 2 步: 初始化项目**

```bash
specify init 智慧课堂 --ai claude
# 选择: 使用 Claude Code 作为 AI 助手
```

**第 3 步: 建立宪法**

```
```
/constitution Принципы, ориентированные на качество кода, стандарты тестирования и соответствие требованиям в образовательной сфере
```

**Шаг 4: Разработка первой функции**

```bash
/specify Разработать функцию для сдачи студенческих работ с поддержкой загрузки изображений и PDF
/clarify
/plan Использовать Spring Boot + MyBatis-Plus + MySQL + Alibaba Cloud OSS
/tasks
/analyze  # Ключевой шаг!
/implement
```

**Шаг 5: Присоединяйтесь к сообществу**

- GitHub: https://github.com/github/spec-kit
- Отправляйте Issue с вашим опытом использования
- Участвуйте в обсуждении улучшений методологии SDD

---

## Запомните четыре ключевых принципа SDD

1. **Спецификация — это истина, код — это выражение**
   - Поддержка ПО = развитие спецификаций
   - Отладка = исправление логики спецификаций
   - Рефакторинг = реструктуризация спецификаций

2. **Конституция — это гены, не подлежит обсуждению**
   - Определите ≤10 ключевых принципов
   - Каждый принцип должен поддаваться автоматической проверке
   - Нарушение = CRITICAL, блокирует реализацию

3. **/analyze — это врата качества, CRITICAL обязателен**
   - 6 проверок: Повторение, Неоднозначность, Полнота, Конституция, Согласованность, Терминология
   - 4 уровня серьезности: CRITICAL блокирует, HIGH — рекомендация, MEDIUM — улучшение, LOW — опционально
   - Обязателен между /tasks и /implement

4. **SDD — это не линейный, а рекурсивный цикл**
   - На уровне проекта/функции/модуля/задачи
   - Каждый уровень может выполнять полный цикл SDD
   - При обнаружении проблем возвращайтесь на соответствующий уровень, а не начинайте заново

---

**Начните разрабатывать ваш следующий проект с SDD!** 🚀

> Данное руководство основано на проекте Spec-Kit и написано для китайских разработчиков.
> Последнее обновление: Январь 2025 г.
> Добро пожаловать с вашими отзывами: https://github.com/github/spec-kit/issues