```toml
description = "Написание глав, автоматическое применение стиля и голоса персонажа"

prompt = """
Написание глав, интеллектуальное применение стиля и голоса персонажа.

Требования пользователя: {{args}}

## Шаги выполнения

### 1. Подготовка
Используйте run_shell_command для инициализации: .specify/scripts/bash/write-chapter.sh

Чтение связанных файлов:
- Используйте glob_files для поиска "stories/**/outline.md" - План глав
- spec/knowledge/character-voices.md - Голоса персонажей
- spec/knowledge/world-setting.md - Мироустройство
- .specify/memory/writing-constitution.md - Стиль письма
- memory/personal-voice.md - Отпечаток личного голоса
- spec/knowledge/natural-expression.md - Руководство по естественному выражению
- spec/presets/anti-ai-detection.md - Стратегии обнаружения ИИ

### 2. Определение главы
Определение главы для написания:
- Получение номера главы из параметров
- Просмотр позиции главы в общей структуре
- Подтверждение соответствующего узла метода

### 3. Применение элементов письма

**Согласованность стиля**
- Поддержание установленной точки зрения повествования
- Использование заданного языкового стиля
- Поддержание темпа и атмосферы

**Голос персонажа**
- Каждый персонаж сохраняет уникальный способ речи
- Отражение черт характера
- Соответствие предыстории и статусу

**Продвижение сюжета**
- Связь с предыдущей главой
- Выполнение задачи текущей главы
- Подготовка к следующей главе

### 4. Стратегия интеллектуального разделения на части

**Важное примечание**
Из-за ограничений вывода Gemini за один раз (около 2500-3000 слов) длинные главы требуют многократной генерации.

**Стандартный режим из трех частей** (около 7500 слов)
Подходит для: Переходных глав, повседневных описаний
- Начало: Установка сцены (2500 слов)
- Развитие: Продвижение сюжета (2500 слов)
- Завершение: Переход к следующей части (2500 слов)

**Рекомендуемый режим из четырех частей** (9000-9500 слов)
Подходит для: Важных сюжетных поворотов, кульминационных глав, использует классическую структуру "начало-развитие-поворот-завершение"

1. **Режим с интенсивными диалогами** (2:2.5:3:2 тыс. слов)
   - Начало: Установка сцены (2000 слов)
   - Развитие: Развитие диалога (2500 слов)
   - Поворот: Нарастание конфликта (3000 слов) [Кульминация]
   - Завершение: Завершение последствий (2000 слов)

2. **Режим с экшн-сценами** (2:2:3:2.5 тыс. слов)
   - Начало: Приближение кризиса (2000 слов)
   - Развитие: Начальное столкновение (2000 слов)
   - Поворот: Пик битвы (3000 слов) [Самый захватывающий момент]
   - Завершение: Определение исхода (2500 слов)

3. **Режим с эмоциональным развитием** (2.5:2.5:2.5:2 тыс. слов)
   - Начало: Создание атмосферы (2500 слов)
   - Развитие: Эмоциональное нарастание (2500 слов)
   - Поворот: Эмоциональный взрыв (2500 слов)
   - Завершение: Отражение последствий (2000 слов)

4. **Режим с загадками и поворотами** (2:2.5:3:2 тыс. слов)
   - Начало: Размещение подсказок (2000 слов)
   - Развитие: Нарастание загадки (2500 слов)
   - Поворот: Раскрытие правды (3000 слов) [Ключевое раскрытие]
   - Завершение: Продолжение влияния (2000 слов)

**Интеллектуальные рекомендации**
Автоматически рекомендует на основе важности главы:
"Глава [N] является [обычной/ключевой] главой, рекомендуется использовать режим [из трех частей/из четырех частей], принять?"

### 5. Применение стратегий обнаружения ИИ

**Натурализация контента**
На основе прочитанного файла об обнаружении ИИ, обработка сгенерированного контента:

1. **Оптимизация лексики**
   - Замена слов, характерных для ИИ, на разговорные выражения
   - Контроль плотности идиом (2-3 на тысячу слов)
   - Умеренное использование диалектов/интернет-сленга

2. **Натурализация синтаксиса**
   - Чередование длинных и коротких предложений (избегать равномерного распределения)
   - Вставка неполных предложений и разговорных выражений
   - Добавление частиц и междометий

3. **Симуляция когнитивных процессов**
   - Имитация несовершенства памяти ("кажется...", "вроде бы...")
   - Отражение избирательности внимания
   - Включение личных субъективных оттенков

4. **Внедрение недостатков** (для повышения реалистичности)
   - 1 ошибка на 2000 слов (смешение 的, 地, 得)
   - Случайность пунктуации (вариативность многоточий)
   - Периодические изменения порядка слов

5. **Персонализированная маркировка**
   - Применение личных характеристик из personal-voice.md
   - Сохранение единообразия стиля
   - Усиление уникальных выразительных привычек

### 6. Генерация контента главы

**Стандартный режим** (одна часть)
Используйте write_file для создания файла главы:
# Глава X: [Название главы]
[Содержание, 2500-3000 слов, с применением стратегий обнаружения ИИ]

**Режим из трех частей** (7500 слов)
- Глава X (Начало): Установка сцены [2500 слов]
- Глава X (Развитие): Продвижение сюжета [2500 слов]
- Глава X (Завершение): Переход к следующей части [2500 слов]

**Режим из четырех частей** (9000-9500 слов)
- Глава X (Начало): [Соответствующее количество слов]
- Глава X (Развитие): [Соответствующее количество слов]
- Глава X (Поворот): [Соответствующее количество слов] [Кульминационная часть]
- Глава X (Завершение): [Соответствующее количество слов]

Каждая часть должна быть связной, обратите внимание:
- Начало: Установка сцены и атмосферы
- Развитие: Связь с началом, продвижение сюжета
- Поворот: Ключевой поворот или кульминация (в режиме из четырех частей)
- Завершение: Соответствующее завершение, подготовка к следующей главе

---
Количество слов: [Фактическое количество слов]
Выполненные пункты: [√ Выполненные пункты]
Анонс следующей главы: [Анонс в одном предложении]

### 7. Проверка качества
- Соответствие количеству слов
- Выполнение пунктов
- Согласованность стиля
- Соответствие персонажей
- Естественность переходов между частями
- **Самопроверка обнаружения ИИ**:
  - Есть ли 3 последовательных предложения со схожей структурой
  - Слишком ли книжная лексика
  - Недостаток ли разговорных черт
  - Слишком ли идеальное отсутствие недостатков

### 8. Автоматическое обновление данных отслеживания

После завершения написания автоматически выполняются следующие обновления:

**Обновление отслеживания сюжета**
Используйте edit_file для обновления spec/tracking/plot-tracker.json:
- Отметка о завершении текущей главы
- Запись выполненных сюжетных узлов
- Добавление новых заделов на будущее

**Обновление временной шкалы**
Используйте edit_file для обновления spec/tracking/timeline.json:
- Извлечение информации о времени из главы
- Обновление текущей временной точки истории
- Проверка непрерывности времени

**Обновление отношений персонажей**
Используйте edit_file для обновления spec/tracking/relationships.json:
- Определение изменений в отношениях
- Запись развития отношений
- Обновление статуса отношений

**Обновление состояния персонажей**
Используйте edit_file для обновления spec/tracking/character-state.json:
- Запись изменений местоположения персонажей
- Обновление этапов развития персонажей
- Отслеживание роста персонажей

### 9. Уведомление о завершении отслеживания
```
✅ Глава N написана, данные отслеживания обновлены

Рекомендуется выполнить:
- /plot-check для проверки связности сюжета
- /timeline для проверки логики временной шкалы
- /relations для подтверждения изменений в отношениях
- /track для пакетной проверки последних глав (рекомендуется выполнять каждые 10 глав)
```

### 10. Отчет о завершении
✅ Создание главы X завершено!
- Количество слов: [Фактическое количество слов]
- Файл: stories/[имя]/chapters/[имя файла]
- Степень завершенности: [Состояние выполнения пунктов]
- Отслеживание: Все файлы отслеживания автоматически обновлены
- Следующий шаг: Продолжить написание следующей главы с помощью /write

## Напоминание о пакетной проверке
После завершения нескольких глав (рекомендуется каждые 5-10 глав) запустите:
- /track для глубокой проверки согласованности всего контента
- /plot-check для проверки логики сюжета
- /world-check для проверки согласованности мироустройства

## Примечания
- Строго придерживайтесь установленного стиля
- Диалоги персонажей должны быть индивидуальными
- Сюжет должен соответствовать требованиям плана
- Сохраняйте сцены живыми и конкретными
- Данные отслеживания должны синхронизироваться автоматически
- **Ключевые моменты обнаружения ИИ**:
  - Естественное выражение важнее идеальных слов
  - Умеренные недостатки повышают реалистичность
  - Личные особенности должны пронизывать весь текст
  - Избегайте накопления словарного запаса, характерного для ИИ
"""
```