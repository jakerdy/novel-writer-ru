# Руководство по статистике подсчета китайских слов

## Контекст проблемы

### Почему нельзя использовать `wc -w`?

Команда `wc -w` подсчитывает «количество слов» (word count), используя пробелы, табуляцию и символы новой строки в качестве разделителей.

**Проблемы с китайским текстом**:
- В китайском языке обычно нет пробелов для разделения слов.
- Это приводит к крайне неточным результатам подсчета.
- Например: «今天天气很好» будет подсчитано как **1 слово** (потому что нет пробелов).

**Реальный пример**:
```bash
# Файл, содержащий 74 китайских символа
wc -w test.md
# Вывод: 6    # Неправильно! Подсчитано только 6 слов

# Использование правильного метода
count_chinese_words test.md
# Вывод: 74   # Правильно! Подсчитано 74 символа
```

### Почему `wc -m` тоже недостаточно хорош?

`wc -m` подсчитывает количество символов (character count). Хотя это точнее, чем `wc -w`, он учитывает:
- Пробелы
- Символы новой строки
- Знаки препинания
- Маркеры Markdown (`#`, `*`, `-` и т.д.)

Все это не должно учитываться в подсчете основного текста.

## Правильное решение

### Использование функции `count_chinese_words`

Проект предоставляет специальную функцию для подсчета китайских слов, расположенную в `scripts/bash/common.sh`:

```bash
# Загрузка функции
source scripts/bash/common.sh

# Подсчет одного файла
count_chinese_words "stories/my-story/content/第001章.md"

# Вывод: 2845
```

### Особенности функции

✅ **Исключение ненужного контента**:
- Автоматически исключает маркеры Markdown (`#`, `**`, `*`, `_`, `[`, `]` и т.д.)
- Исключает блоки кода (```...```)
- Исключает пробелы, символы новой строки, табуляцию
- Исключает знаки препинания

✅ **Точный подсчет**:
- Подсчитывает фактические китайские символы
- Подсчитывает английские буквы
- Подсчитывает цифры
- Учитывает только основной текст

✅ **Хорошая производительность**:
- Быстрая обработка больших файлов (~10 мс)
- Подходит для пакетной обработки

## Способ использования

### 1. Использование в скриптах

```bash
#!/bin/bash

# Импорт библиотеки функций
source "$(dirname "$0")/common.sh"

# Подсчет слов
file_path="stories/test/content/chapter-001.md"
word_count=$(count_chinese_words "$file_path")

echo "Количество слов: $word_count"
```

### 2. Использование в командной строке

```bash
# Подсчет одного раздела
source scripts/bash/common.sh && \
  count_chinese_words "stories/my-story/content/第001章.md"

# Подсчет всех разделов
for file in stories/my-story/content/*.md; do
  words=$(source scripts/bash/common.sh && count_chinese_words "$file")
  echo "$(basename "$file"): $words слов"
done
```

### 3. Использование вспомогательной функции для отображения понятной информации

```bash
source scripts/bash/common.sh

# Отображение количества слов и проверка соответствия требованиям
show_word_count_info "stories/my-story/content/第001章.md" 2000 4000

# Пример вывода:
# Количество слов: 2845
# ✅ Соответствует требованиям по количеству слов (2000-4000)
```

## Интеграция в рабочий процесс

### 1. Автоматическая проверка после завершения написания

После завершения команды `/write` автоматически отображается статистика подсчета слов:

```
✅ Написание главы завершено
- Сохранено: stories/my-story/content/第001章.md
- Фактическое количество слов: 2845 слов
- Требования к количеству слов: 2000-4000 слов
- Статус количества слов: ✅ Соответствует требованиям
- Статус задачи: Обновлено
```

### 2. Использование `/analyze` для просмотра статистики всей книги

Выполнение команды `/analyze` отображает подробный подсчет слов для каждой главы:

```
Статистика контента:

  第001章.md: 2845 слов
  第002章.md: 3120 слов
  第003章.md: 2678 слов

  Общее количество слов: 8643
  Количество глав: 3
  Средняя длина главы: 2881 слов
```

### 3. Использование скрипта проверки для отслеживания прогресса

Запуск проверки состояния написания:

```bash
.specify/scripts/bash/check-writing-state.sh
```

Пример вывода:
```
Завершенные главы: 3
Требования к количеству слов: 2000-4000 слов

Последнее написание:
  - 第003章.md: 2678 слов ✅
  - 第002章.md: 3120 слов ✅
  - 第001章.md: 2845 слов ✅
```

## Настройка требований к количеству слов

Требования к количеству слов настраиваются в `spec/tracking/validation-rules.json`:

```json
{
  "rules": {
    "chapterMinWords": 2000,    // Минимальное количество слов на главу
    "chapterMaxWords": 4000,    // Максимальное количество слов на главу
    "dailyTarget": 1500,        // Ежедневная цель по количеству слов
    "weeklyTarget": 10000       // Еженедельная цель по количеству слов
  }
}
```

Эти значения можно изменить в соответствии с потребностями проекта.

## Тестирование и проверка

Запустите тестовый скрипт для проверки функции подсчета слов:

```bash
./scripts/bash/test-word-count.sh
```

Тест проверяет:
- Подсчет чисто китайского текста
- Исключение маркеров Markdown
- Исключение блоков кода
- Обработку смешанного китайско-английского текста
- Сравнение с `wc -w`
- Тестирование производительности

## Частые вопросы

### В: Почему мое количество слов меньше ожидаемого?

О: Возможные причины:
1. Использование `wc -w` (неправильный метод)
2. Большое количество маркеров Markdown в файле
3. Наличие блоков кода в файле

**Решение**: Используйте функцию `count_chinese_words`.

### В: Учитывает ли подсчет слов знаки препинания?

О: Нет. Функция `count_chinese_words` исключает знаки препинания и подсчитывает только фактическое текстовое содержимое.

### В: Как подсчитываются английские слова?

О: Английские буквы подсчитываются посимвольно. Например, «hello» подсчитывается как 5 символов.

### В: Что делать, если подсчет слов медленный?

О: Функция оптимизирована, обработка больших файлов ( ~3000 слов) обычно занимает всего 10 мс. Если возникают проблемы с производительностью:
1. Проверьте, не слишком ли велик файл (более 10000 слов)
2. Рассмотрите возможность подсчета по главам
3. Убедитесь, что команды `sed`, `tr`, `grep` доступны

### В: Можно ли использовать в PowerShell?

О: В настоящее время функция поддерживает только Bash. Версия для PowerShell находится в разработке, но пока можно использовать Git Bash или WSL.

## Лучшие практики

1. **Всегда используйте функции, предоставляемые проектом**
   ```bash
   # ✅ Правильно
   source scripts/bash/common.sh
   count_chinese_words "file.md"

   # ❌ Неправильно
   wc -w file.md
   wc -m file.md
   ```

2. **Сразу проверяйте количество слов после завершения написания**
   - Количество слов автоматически отображается после завершения написания с помощью ИИ.
   - Убедитесь, что оно соответствует требованиям, прежде чем переходить к следующему шагу.

3. **Регулярно запускайте `/analyze` для проверки прогресса всей книги**
   - Рекомендуется запускать каждые 5 глав.
   - Проверяйте общее количество слов и среднюю длину главы.

4. **Корректируйте требования к количеству слов в соответствии с проектом**
   - Измените `validation-rules.json`.
   - Различные типы произведений имеют разные требования.

## Технические детали

### Принцип реализации функции

```bash
count_chinese_words() {
    local file="$1"

    cat "$file" | \
        sed '/^```/,/^```/d' |      # Удалить блоки кода
        sed 's/^#\+[[:space:]]*//' | # Удалить маркеры заголовков
        sed 's/\*\*//g' |            # Удалить жирный шрифт
        sed 's/__//g' |              # Удалить жирный шрифт
        sed 's/\*//g' |              # Удалить курсив
        sed 's/_//g' |               # Удалить курсив
        sed 's/\[//g' |              # Удалить ссылки
        sed 's/\]//g' |              # Удалить ссылки
        sed 's/(http[^)]*)//g' |     # Удалить URL
        sed 's/^>[[:space:]]*//' |   # Удалить цитаты
        sed 's/^[[:space:]]*[-*][[:space:]]*//' | # Удалить списки
        tr -d '[:space:]' |          # Удалить пробелы
        tr -d '[:punct:]' |          # Удалить знаки препинания
        grep -o . |                  # Разделить на символы
        wc -l                        # Подсчитать строки (= количество символов)
}
```

### Связанные файлы скриптов

- `scripts/bash/common.sh` - Основная библиотека функций
- `scripts/bash/analyze-story.sh` - Используется для анализа историй
- `scripts/bash/check-writing-state.sh` - Отображает количество слов в главах
- `scripts/bash/test-word-count.sh` - Тестовый скрипт

## Заключение

- ❌ Не используйте `wc -w` для подсчета китайских слов
- ❌ Не используйте `wc -m` для подсчета слов
- ✅ Используйте функцию `count_chinese_words`
- ✅ Используйте автоматизированные инструменты для проверки количества слов
- ✅ Настройте разумные требования к количеству слов

Это обеспечит точный и последовательный подсчет слов, избегая путаницы, вызванной неправильными методами подсчета.