#!/usr/bin/env pwsh
# –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ä–æ–º–∞–Ω–∞ (PowerShell)

param(
  [switch]$check,
  [switch]$fix,
  [switch]$brief,
  [switch]$plot,
  [switch]$stats
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

. "$PSScriptRoot/common.ps1"

$root = Get-ProjectRoot
$storyDir = Get-CurrentStoryDir
$progress = Join-Path $root "stories/current/progress.json"
$plotPath = Join-Path $root "spec/tracking/plot-tracker.json"

function Show-BasicReport {
  Write-Host "üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ä–æ–º–∞–Ω–∞"
  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  if (Test-Path $progress) {
    Write-Host "‚úçÔ∏è –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞–ø–∏—Å–∞–Ω–∏—è"
    Write-Host "  –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ—Ç—Å—è..."
  }
  if (Test-Path $plotPath) {
    Write-Host "üìç –°—Ç–∞—Ç—É—Å —Å—é–∂–µ—Ç–∞"
    Write-Host "  –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏–Ω–∏–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è..."
  }
}

function Run-DeepCheck {
  Write-Host "üîç –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏..."
  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  Write-Host "–≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
  Write-Host "  [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å—é–∂–µ—Ç–∞..."
  Write-Host "  [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã..."
  Write-Host "  [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π..."
  Write-Host "  [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏—è..."
  Write-Host "–≠—Ç–∞–ø 2: –ì–ª—É–±–æ–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π"
  $rules = Join-Path $root "spec/tracking/validation-rules.json"
  if (Test-Path $rules) {
    Write-Host "  ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫–∏"
    Set-Content -LiteralPath "$env:TEMP/validation-tasks.md" -Encoding UTF8 -Value @"
# –ó–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)

## –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ [–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ]
- [ ] T001 [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å—é–∂–µ—Ç–∞
- [ ] T002 [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
- [ ] T003 [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π
- [ ] T004 [P] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏—è

## –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- [ ] T005 –ó–∞–≥—Ä—É–∑–∫–∞ validation-rules.json
- [ ] T006 –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ –≥–ª–∞–≤–∞—Ö
- [ ] T007 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω
- [ ] T008 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
- [ ] T009 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π

## –≠—Ç–∞–ø 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
- [ ] T010 –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] T011 –û—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º
- [ ] T012 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
"@
    Write-Host "  ‚úÖ –ó–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã"
  } else {
    Write-Host "  ‚ö†Ô∏è –§–∞–π–ª –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
  }
  Write-Host "üìä –û—Ç—á–µ—Ç –æ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ"
  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  Write-Host "–ò–ò –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –≥–ª–∞–≤—ã –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç..."
  Write-Host "üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å --fix –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
}

function Run-AutoFix {
  Write-Host "üîß –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  Set-Content -LiteralPath "$env:TEMP/fix-tasks.md" -Encoding UTF8 -Value @"
# –ó–∞–¥–∞—á–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)

## –≠—Ç–∞–ø 1: –ü—Ä–æ—Å—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ [–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏]
- [ ] F001 –ß—Ç–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ
- [ ] F002 [P] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –∏–º–µ–Ω–∞—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- [ ] F003 [P] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö
- [ ] F004 [P] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—á–∞—Ç–æ–∫

## –≠—Ç–∞–ø 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
- [ ] F005 –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] F006 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
"@
  Write-Host "üîß –û—Ç—á–µ—Ç –æ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"
  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  Write-Host "–ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã..."
}

if ($check) { Run-DeepCheck }
elseif ($fix) { Run-AutoFix }
else { Show-BasicReport }

Write-Host ""
Write-Host "‚úÖ –ê–Ω–∞–ª–∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω"