# Анализ различий в расположении команды Analyze: Обоснование дизайна

## Предыстория проблемы

Пользователи сообщества сообщают: **расположение команды analyze в spec-kit и novel-write не совпадает**

- spec-kit (разработка кода): analyze **перед** implement
- novel-write (создание романа): analyze **после** write

Является ли это ошибкой дизайна или намеренным решением? Этот документ подробно обоснует обоснованность этого различия.

## Сравнение процессов

### Стандартный процесс spec-kit (разработка ПО)

```
constitution → specify → clarify → plan → tasks → analyze → implement
                                                      ↑
                                           Проверка перед реализацией
```

Источник: [spec-kit README.md L216](https://github.com/github/spec-kit)

```markdown
| `/analyze` | Cross-artifact consistency & coverage analysis
             (run after /tasks, before /implement) |
```

**Назначение analyze**:
- Кросс-артефактная проверка согласованности спецификаций, планов, задач
- Проверка покрытия (все ли требования имеют соответствующие задачи)
- Выявление противоречий и упущений (исправление до кодирования)
- Обеспечение достаточной подготовки перед реализацией

### Стандартный процесс novel-write (создание романа)

```
constitution → specify → clarify → plan → tasks → write → analyze
                                                             ↑
                                              Проверка после написания
```

Источник: [novel-write templates/commands/write.md L115](../../templates/commands/write.md)

```markdown
/constitution → Определение принципов творчества
     ↓
/specify → Определение требований к истории
     ↓
/clarify → Уточнение ключевых решений
     ↓
/plan → Разработка технического решения
     ↓
/tasks → Декомпозиция задач на выполнение
     ↓
/write → 【Текущий】этап написания
     ↓
/analyze → Проверка согласованности качества
```

**Назначение analyze**:
- Проверка соответствия созданного контента спецификациям
- Проверка связности сюжета, последовательности персонажей
- Оценка достижения стандартов качества
- Генерация предложений по улучшению

## Анализ ключевых различий

### Различие 1: Разные объекты проверки

| Измерение | spec-kit (код) | novel-write (роман) |
|-----------|----------------|-------------------|
| **Объект проверки** | Документы спецификаций, планы, списки задач | Созданный контент |
| **Содержание проверки** | Согласованность, полнота, реализуемость | Качество, связность, выражение темы |
| **Время проверки** | Перед реализацией (превентивное) | После создания (оценочное) |

### Различие 2: Разная стоимость ошибок

**Стоимость ошибок при разработке кода**:
- ❌ Если не провести analyze перед реализацией, можно обнаружить противоречие в дизайне после написания 50% кода
- ❌ Высокая стоимость рефакторинга, написанный код может быть потерян
- ✅ Предварительная проверка позволяет избежать переделок

**Стоимость ошибок при создании романа**:
- ✅ Чрезмерный анализ перед написанием может прервать творческий поток
- ✅ Сначала завершить черновик, затем массово редактировать — более эффективный процесс
- ✅ Литературные произведения допускают совершенствование в процессе редактирования

### Различие 3: Характер цикла обратной связи

**Разработка кода (превентивная обратная связь)**:
```
plan → tasks → analyze → обнаружение противоречий → изменение plan/tasks → implement
          ↑_______________|
        （нет потери кода）
```

**Создание романа (итеративная обратная связь)**:
```
plan → tasks → write → analyze → обнаружение проблем → доработка контента
                  ↑_______________________|
              （контент уже существует, доработка, а не переписывание）
```

## Обоснование дизайна

### Почему код требует "analyze before implement"?

#### 1. **Возможность немедленного изменения**
- Спецификации, планы, задачи — это документы, стоимость изменения которых низка
- После обнаружения проблем analyze достаточно внести коррективы в документы
- Корректировки перед реализацией не приводят к потере рабочего времени на кодирование

#### 2. **Двоичная корректность**
- Код либо компилируется, либо нет
- Тесты либо проходят, либо нет
- Analyze позволяет заранее выявить эти двоичные проблемы

#### 3. **Сложность зависимостей**
- Между модулями кода существуют сильные зависимости
- Как только начинается реализация, дерево зависимостей определяется
- Предварительный analyze позволяет оптимизировать структуру зависимостей

#### 4. **Инструментальная проверка**
- Analyze может автоматически проверять:
  - Есть ли задачи для всех требований spec
  - Охватывают ли задачи все компоненты plan
  - Соответствуют ли контракты data-model
- Эти проверки не требуют реального кода

**Пример: пункты проверки analyze в spec-kit**
```markdown
## Coverage Analysis
- [ ] All P0 requirements have corresponding tasks
- [ ] All entities in data-model.md have CRUD tasks
- [ ] All API endpoints in contracts/ have implementation tasks

## Consistency Analysis
- [ ] Plan's tech stack matches tasks' tooling
- [ ] No contradictions between spec.md and plan.md
- [ ] Test tasks exist before implementation tasks (TDD)
```

### Почему роман требует "write before analyze"?

#### 1. **Защита творческого потока**
- Написание требует непрерывного творческого состояния (flow state)
- Частые прерывания нарушают повествовательный ритм и вдохновение
- Сначала завершить черновик, затем провести массовый анализ больше соответствует психологии творчества

#### 2. **Непрерывность качества**
- Качество литературы не является двоичным (не "правильно/неправильно")
- Требуется оценка, аналитические параметры (1-10 баллов)
- Необходимо иметь фактический контент для оценки качества

#### 3. **Зависимость от контекста**
- Отдельная глава не может проверить тему, ритм, арку персонажа
- Требуется накопление определённого объёма (5-10 глав) для глубокого анализа
- Массовая проверка эффективнее поглавной

#### 4. **Режим итеративного совершенствования**
- Создание романа по сути — это "черновик → рецензирование → доработка"
- Черновик допускает несовершенство, корректировка происходит после analyze
- Этот режим принципиально отличается от "сначала тесты" в коде

**Пример: пункты проверки analyze в novel-write**
```markdown
## Проверка соответствия конституции
- [ ] Соответствует ли основным ценностям
- [ ] Достигнуты ли стандарты качества

## Анализ соответствия спецификации
- [ ] Реализованы ли обязательные элементы P0
- [ ] Оценка соответствия целевой аудитории

## Анализ качества контента
- [ ] Оценка плотности сюжета
- [ ] Проверка последовательности персонажей
- [ ] Анализ изменений ритма
```

## Инженерия vs Искусство: Сущностные различия

### Сравнительная таблица измерений

| Измерение | Разработка кода (инженерия) | Создание романа (искусство) |
|-----------|----------------|----------------|
| **Стандарт корректности** | Двоичный (пройден/не пройден) | Непрерывный спектр (1-10 баллов) |
| **Время проверки** | Превентивное (до) | Оценочное (после) |
| **Стоимость изменений** | Высокая после реализации, низкая до | Приемлема после черновика |
| **Характер рабочего процесса** | Может прерываться, параллельный | Требует непрерывности |
| **Механизм обратной связи** | Автоматизированная проверка инструментами | Комплексная оценка человеком + ИИ |
| **Гранулярность проверки** | Мелкая (уровень функций) | Грубая (уровень глав/томов) |
| **Идеальное время** | С первого раза должно быть правильно | Постепенное совершенствование в процессе итераций |

### Психологические различия

**Рабочий режим инженера**:
- Сначала проектирование архитектуры (можно многократно обдумывать)
- Кодирование после подтверждения отсутствия ошибок
- Проблемы в процессе кодирования — это дефекты дизайна

**Рабочий режим писателя**:
- Сначала быстрое фиксирование идей (не прерывать рациональным мышлением)
- Оценка всего произведения после завершения черновика
- Редактирование — неотъемлемая часть творческого процесса

### Проверка историческим опытом

**Лучшие практики в разработке ПО**:
- TDD (Test-Driven Development): сначала пишешь тесты, потом код
- Design Review: проверка дизайна перед реализацией
- Architecture Review: проверка архитектуры перед кодированием
- **Вывод**: предварительная проверка признана лучшей практикой в отрасли

**Лучшие практики в создании литературы**:
- Хемингуэй: "Первые черновики — это всегда дерьмо" (сначала завершить, потом совершенствовать)
- Стивен Кинг: сначала написать полную историю, затем отложить на 6 недель для редактирования
- Стандартный процесс писательских мастерских: Draft → Critique → Revise
- **Вывод**: пост-редактирование — стандартный процесс творчества

## Что будет, если сделать наоборот?

### Гипотеза 1: Код также использует "implement before analyze"

```
plan → tasks → implement → analyze → обнаружение проблем
                    ↓
                Написано 5000 строк кода
                    ↓
            Analyze обнаруживает противоречие в архитектуре
                    ↓
            Требуется рефакторинг или переписывание ❌
```

**Проблемы**:
- Потеряно много времени на кодирование
- Возможно накопление технического долга
- Снижение морального духа команды

### Гипотеза 2: Роман также использует "analyze before write"

```
plan → tasks → analyze (проверка плана) → write
                ↑
        Что проверять? Контента еще нет!
```

**Проблемы**:
- Analyze не может проверить несуществующий контент
- Можно проверить только логичность плана, но это уже сделано на этапе clarify
- Чрезмерный анализ приводит к "параличу перфекциониста", невозможно начать писать черновик

## Реальные сценарии использования

### Сценарии использования analyze в spec-kit

**Время**: после завершения tasks.md, перед implement

**Типичный диалог**:
```
User: /tasks
AI: Список задач сгенерирован, включает 23 задачи

User: /analyze
AI:
Анализ завершен!

【Анализ покрытия】
✅ Все P0 требования имеют соответствующие задачи
⚠️  В спецификации отсутствует задача для функции "уведомления пользователя"
❌ В data-model.md отсутствует задача CRUD для сущности Comment

【Анализ согласованности】
✅ Plan использует PostgreSQL, задачи корректно настраивают базу данных
❌ Spec требует "обновления в реальном времени", но WebSocket не указан в plan

Рекомендации:
1. Добавить 3 задачи для функции уведомлений
2. Добавить 4 задачи для CRUD сущности Comment
3. Дополнить план решением WebSocket

Исправьте эти проблемы, затем запустите /implement
```

### Сценарии использования analyze в novel-write

**Время**: после завершения 5-10 глав или одного тома

**Типичный диалог**:
```
User: /write (завершено 1-5 глав)

User: /analyze
AI:
Комплексный отчет по анализу

【Соответствие конституции】8/10
✅ Соответствует основным ценностям
⚠️ Ритм в главе 3 немного медленный, что может повлиять на удержание читателя

【Соответствие спецификации】7/10
✅ Обязательный элемент P0 "конфликт родителей и детей" полностью раскрыт
❌ Обязательный элемент P0 "создание интриги" недостаточен, в главе 5 должен быть поворотный момент

【Качество контента】
- Плотность сюжета: средняя
- Последовательность персонажей: главный герой в главе 2 и главе 4 реагирует на одно и то же событие противоречиво
- Ритм: первые 3 главы медленные, ускорение в главах 4-5 обосновано

【Предложения по улучшению】
P0 (срочно):
1. Исправить противоречие в характере главного героя (глава 2 vs глава 4)
2. Добавить создание интриги в конце главы 5

P1 (оптимизация):
1. Главу 3 можно сократить на 20%, улучшив ритм
```

## Заключение

### Различие в расположении analyze — правильный дизайн

| Пункт | Расположение команды | Причина |
|-----|---------|------|
| **spec-kit** | tasks → **analyze** → implement | Превентивная проверка, снижение стоимости реализации |
| **novel-write** | tasks → write → **analyze** | Оценочная проверка, защита творческого потока |

### Принципы дизайна

**Инженерная деятельность** (код):
- Следовать принципу "Семь раз отмерь, один раз отрежь"
- Предварительная проверка позволяет избежать переделок
- Analyze перед implement

**Художественная деятельность** (роман):
- Следовать принципу "Лучше сделано, чем идеально"
- Черновик допускает несовершенство, доработка происходит позже
- Analyze после write

### Единая методологическая философия

Несмотря на различие в расположении analyze, оба случая следуют основной идее **Specification-Driven Development**:

```
Specification (что) → Plan (как) → Execute (делать) → Verify (проверять)
```

Различие заключается в **времени Verify**:
- Код: verify перед Execute (превентивное)
- Роман: verify после Execute (оценочное)

Это различие демонстрирует **гибкость методологии SDD**: одна и та же концептуальная рамка адаптируется к особенностям предметной области.

### Рекомендации для пользователей

**При разработке ПО с использованием spec-kit**:
- ✅ Обязательно запускайте analyze перед implement
- ✅ Корректируйте plan/tasks в соответствии с отчетом analyze
- ✅ Начинайте кодирование только после успешного прохождения всех проверок analyze

**При создании романа с использованием novel-write**:
- ✅ Сосредоточьтесь на написании, не анализируйте часто в процессе
- ✅ Запустите analyze после накопления определённого объёма (5-10 глав или том)
- ✅ Проведите массовую доработку в соответствии с отчетом analyze

---

**Итоговое резюме**: это не ошибка дизайна, а **обоснованное различие, обусловленное предметной областью**. Коду нужен "всезнайка до события", роману — "всезнайка после события".

---

## Приложение: Интеллектуальный двухрежимный дизайн (Новое в v0.12.0)

### Проблема: Оба типа требований разумны

После обсуждения в сообществе мы обнаружили, что оба типа анализа analyze имеют ценность:

1. **Анализ фреймворка перед написанием** (предложение Цзэн Сишэна)
   - Проверка согласованности спецификаций, планов, задач
   - Обеспечение достаточной подготовки перед началом написания
   - Предотвращение обнаружения проблем дизайна в середине процесса написания

2. **Анализ контента после написания** (исходный дизайн)
   - Проверка качества созданного контента
   - Проверка соответствия спецификациям
   - Предоставление предложений по улучшению

### Решение: Одна команда, двойной интеллект

Придерживаясь **принципа сдержанности** (избегая взрыва команд), мы реализовали **интеллектуальный двухрежимный analyze**:

```bash
/analyze  # Автоматически определяет, какой тип анализа следует выполнить
```

### Логика интеллектуального определения

Система автоматически определяет текущую стадию создания контента и решает, какой тип анализа выполнить:

```
Количество глав = 0     → Анализ фреймворка (подготовительная стадия)
<RESULT>
Количество глав < 3     → Анализ структуры (рекомендуется продолжить написание)
Количество глав ≥ 3     → Анализ содержания (проверка качества)
```

### Режим ручного управления

Поддерживает явное указание пользователем типа анализа:

```bash
/analyze --type=framework  # Принудительный анализ структуры
/analyze --type=content    # Принудительный анализ содержания
```

### Сравнение двух режимов анализа

| Аспект | Анализ структуры | Анализ содержания |
|------|---------|---------|
| **Время выполнения** | до `write` | после `write` |
| **Объект анализа** | Документы со спецификациями/планами/задачами | Завершенные главы |
| **Основная цель** | Проверка готовности | Проверка соответствия качеству |
| **Проверяемые пункты** | Полнота охвата, согласованность, предупреждения о логике | Соответствие конституции, соответствие спецификациям, качество содержания |
| **Рекомендации по выводу** | Исправление противоречий в документах, дополнение недостающих задач | Исправление проблем содержания, оптимизация качества глав |

### Пример реального использования

#### Пример 1: Этап подготовки к написанию

```bash
Пользователь: /tasks
AI: Сгенерировано 28 задач по написанию

Пользователь: /analyze
AI: Обнаружено отсутствие глав, выполняется анализ согласованности структуры...

【Анализ полноты охвата】
⚠️ Спецификация "Описание антагониста" не соответствует ни одной задаче
❌ В плане глав 10-12 отсутствуют разбивки на задачи

【Оценка готовности】6/10
Рекомендация: Начните написание после исправления указанных проблем
```

#### Пример 2: После завершения нескольких глав

```bash
Пользователь: /write (завершено глав 1-7)

Пользователь: /analyze
AI: Обнаружено 7 завершенных глав, выполняется анализ качества содержания...

【Соответствие конституции】8/10 ✅
【Соответствие спецификациям】7/10 ⚠️ Охват требований P0 составляет 67%
【Качество содержания】7.5/10 ⚠️ Имеются 2 логических противоречия

【Рекомендации по улучшению】
P0: Исправить противоречия во временной шкале и способностях персонажей
P1: Добавить интригу в главу 5

【Рекомендация】: Продолжайте создавать главы 8-10 после исправления проблем P0
```

### Философия дизайна

**Сдержанность, но не упрощение**：
- ❌ Не создавать две команды: `/framework-analyze` и `/content-analyze`
- ✅ Одна команда `/analyze` с интеллектуальным определением сценария
- ✅ Поддержка ручного указания режима (для продвинутых пользователей)
- ✅ Автоматическая обработка 90% сценариев, ручное управление 10%

**Принцип сдержанности WeChat**：
- Мощный функционал, но лаконичные команды
- Интеллектуальная система, не нагружающая пользователя
- Продвинутые функции скрыты, не мешая обычному использованию

### Техническая реализация

Подробности см. в `templates/commands/analyze.md` и `scripts/bash/check-analyze-stage.sh`

---

**Резюме**: Интеллектуальный двухрежимный дизайн удовлетворяет обеим потребностям в анализе, сохраняя при этом лаконичность команды. Это образец идеального баланса между **принципом сдержанности** и **потребностями пользователя**.
</RESULT>