# Руководство по программированию Spec-Kit: Методология разработки, управляемой спецификациями (SDD)

> Практическое руководство по Spec-Kit для китайских разработчиков
> Создание платформы онлайн-образования "Умный класс" с нуля

---

## 0. Начало работы со Spec-Kit

### Установка инструмента командной строки Specify CLI

Spec-Kit предоставляет инструмент командной строки `specify` для быстрого инициализации проектов. Выберите любой из следующих способов установки:

#### Способ 1: Постоянная установка (рекомендуется)

Установите один раз и используйте везде:

```bash
uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
```

После установки можно использовать напрямую:

```bash
specify init <имя проекта>
specify check
```

Обновление инструмента:

```bash
uv tool install specify-cli --force --from git+https://github.com/github/spec-kit.git
```

#### Способ 2: Одноразовое использование

Не требуется установка, запускайте напрямую:

```bash
uvx --from git+https://github.com/github/spec-kit.git specify init <имя проекта>
```

### Инициализация проекта

Используйте команду `specify init` для инициализации проекта Spec-Kit:

```bash
# Создание нового проекта
specify init my-project

# Указание AI-агента
specify init my-project --ai claude

# Инициализация в текущем каталоге
specify init . --ai claude
# Или используйте флаг --here
specify init --here --ai claude

# Принудительное слияние в непустой каталог (пропустить подтверждение)
specify init . --force --ai claude
```

### Поддерживаемые AI-агенты

| AI-агент | Статус поддержки | Примечания |
|---------|-----------------|------------|
| [Claude Code](https://www.anthropic.com/claude-code) | ✅ | |
| [GitHub Copilot](https://code.visualstudio.com/) | ✅ | |
| [Gemini CLI](https://github.com/google-gemini/gemini-cli) | ✅ | |
| [Cursor](https://cursor.sh/) | ✅ | |
| [Windsurf](https://windsurf.com/) | ✅ | |
| [Qwen Code](https://github.com/QwenLM/qwen-code) | ✅ | |
| [opencode](https://opencode.ai/) | ✅ | |
| [Roo Code](https://roocode.com/) | ✅ | |

### Предварительные требования

- **Операционная система**: Linux/macOS (или Windows WSL2)
- **AI-агент**: Любой из поддерживаемых инструментов для программирования с ИИ
- **Python**: 3.11+
- **Менеджер пакетов**: [uv](https://docs.astral.sh/uv/)
- **Система контроля версий**: [Git](https://git-scm.com/downloads)

---

## 1. Основная концепция: Сущность разработки, управляемой спецификациями

### Что такое разработка, управляемая спецификациями?

**SDD (Spec-Driven Development - Разработка, управляемая спецификациями)** — это революционный метод разработки программного обеспечения, основная идея которого заключается в следующем:

> **Спецификации больше не служат коду, код служит спецификациям**

**Проблемы традиционной разработки ПО**:
```
Документ с требованиями (Word) → Документ проектирования (Visio) → Кодирование → Тестирование → Запуск
    ↓               ↓                ↓      ↓
  Устарел         Не соответствует коду         Правда   Исправление
```
Результат: Документация всегда отстает, в итоге "код — это документация"

**Цикл разработки, управляемый SDD**:
```
Конституция проекта → Спецификации функций → Решения для уточнения → Технические решения → Декомпозиция задач
                                              ↓
                                          Проверка качества
                                              ↓
                                          Автоматическая реализация кода
  ↑                                           ↓
  └────── Обнаружение проблем, возврат к соответствующему уровню для изменения спецификаций ──────┘
```

### Почему SDD необходим сейчас?

**Три тенденции делают SDD неизбежным:**

1. **Прорыв в возможностях ИИ**: LLM, такие как GPT-4/Claude, могут понимать спецификации на естественном языке и генерировать исполняемый код.
2. **Взрывной рост сложности**: Современные системы интегрируют десятки компонентов, таких как Redis, MQ, микросервисы; поддерживать согласованность вручную становится все труднее.
3. **Ускорение изменений требований**: В условиях гибкой разработки требования меняются еженедельно. Традиционный подход к изменению требований — это катастрофа, SDD требует только обновления спецификаций для повторной генерации.

**Ключевое понимание SDD**:

Традиционная разработка: Код — это истина, документация — это дополнение → Код постоянно развивается, документация постепенно устаревает.

SDD меняет отношение: **Спецификация — это истина, код — это ее выражение на Java/Python/Go**.
- Поддержка программного обеспечения = Эволюция спецификаций
- Отладка ошибок = Исправление логических ошибок в спецификациях
- Рефакторинг = Реорганизация структуры спецификаций

### SDD — это не линейный процесс, а рекурсивный цикл

**❌ Неправильное понимание: Однократное линейное выполнение**
```
Весь проект: Конституция → Спецификации → Решения → Задачи → Реализация (100 функций написаны вручную)
                                      ↑
                              Всегда вручную кодируем здесь
```

**✅ Правильное понимание: Многоуровневая рекурсия**
```
Уровень 1 - Весь проект:   Конституция → Спецификации (архитектура) → Выбор технологий
           ↓
Уровень 2 - Отдельная функция:   Спецификации → Уточнение → Решения → Задачи → Проверка качества → Реализация
           ↓
Уровень 3 - Функциональный модуль:   Решения → Задачи → Реализация
           ↓
Уровень 4 - Отдельная задача:   Реализация
```

**Полный цикл SDD может выполняться на каждом уровне!** Это суть методологии.

---

## 2. Метод семи шагов: Подробное описание

### Основной поток команд

**Описание формата команды**:
- **Полный формат**: `/speckit.xxx` - официальная запись, четко определяющая пространство имен.
- **Сокращенный формат**: `/xxx` - удобный формат, фактически выполняющий то же самое.
- В этом документе для краткости в большинстве примеров используется сокращенный формат.

SDD предоставляет следующие основные команды для выполнения полного процесса разработки:

```
1. /speckit.constitution (или /constitution)  →  Конституция проекта (высшие принципы, определяющие ДНК проекта)
2. /speckit.specify (или /specify)            →  Спецификации функций (единственный источник истины, определяющий ЧТО делать и ПОЧЕМУ)
3. /speckit.clarify (или /clarify)            →  Решения для уточнения (устранение неоднозначности, маркировка точек для подтверждения) [Необязательно, рекомендуется]
4. /speckit.plan (или /plan)                  →  Технические решения (определение КАК делать, выбор технологического стека)
5. /speckit.tasks (или /tasks)                →  Декомпозиция задач (выполнимые шаги, маркировка параллельности)
6. /speckit.analyze (или /analyze)            →  Проверка качества (проверка согласованности, CRITICAL-проблемы обязательны к исправлению) [Необязательно, рекомендуется]
7. /speckit.implement (или /implement)        →  Реализация (генерация кода в стиле TDD)
```

**Дополнительные команды:**
- `/speckit.checklist` (или `/checklist`) - Генерация специфического для предметной области контрольного списка качества
  - **Когда использовать**: Для областей с высоким риском (безопасность/производительность/соответствие требованиям/UX) генерируется подробный контрольный список.
  - **Время выполнения**: После `/plan` или `/tasks`, в качестве специализированного дополнения к `/analyze` для конкретной области.
  - **Отличие от analyze**: `analyze` — это общая автоматическая проверка, `checklist` — это целенаправленная проверка с точки зрения эксперта в данной области.

### Основные обязанности каждой команды

| Команда | Входные данные | Выходные данные | Ключевые ограничения |
|------|-----------------|-----------------|----------------------|
| `/speckit.constitution` | Идея проекта | `Конституция проекта.md` | Определение не подлежащих обсуждению принципов |
| `/speckit.specify` | Описание функции | `Спецификации функций.md` | Писать только ЧТО делать/ПОЧЕМУ, не КАК делать |
| `/speckit.clarify` | Документ со спецификациями | Обновленный документ со спецификациями | Принудительное решение всех неопределенных моментов |
| `/speckit.plan` | Спецификации + выбор технологий | `Технические решения.md` + `Модель данных.md` | Должно пройти проверку Конституцией |
| `/speckit.tasks` | Технические решения | `Список задач.md` | Маркировка зависимостей и параллельности |
| `/speckit.analyze` | Спецификации + Решения + Задачи | Отчет об анализе | **Только чтение**, не изменяет файлы |
| `/speckit.implement` | Список задач | Код + тесты | Строго TDD: сначала тесты, потом реализация |
| `/speckit.checklist` | Документ со спецификациями | Контрольный список качества | Проверка полноты и согласованности требований |

### Механизм проверки качества в семишаговом процессе

```
Конституция ──→ Спецификации ──→ Уточнение ──→ Решения ──→ Задачи
         ↓         ↓        ↓        ↓
     [Маркировка неоднозначности] [Решение неоднозначности] [Проверка Конституцией] [Проверка задачами]
                                     ↓
                                 Проверка качества ←── CRITICAL-проблемы блокируют процесс
                                     ↓
                                 Реализация
```

**`/speckit.analyze` — ключевая проверка качества**:
- **Принудительно запускается** после завершения `/speckit.tasks` и перед `/speckit.implement`.
- Обнаруживает 6 типов проблем: дублирование, неоднозначность, полнота покрытия, нарушение Конституции, несогласованность, смещение терминологии.
- Уровни: CRITICAL (обязательно к исправлению) / HIGH (рекомендуется) / MEDIUM (улучшение) / LOW (необязательно).
- **При наличии CRITICAL-проблем блокируется `/speckit.implement`**.

### Как применять семишаговый процесс на разных уровнях

| Уровень | Конституция | Спецификации | Уточнение | Решения | Задачи | Проверка качества | Реализация |
|------|------|------|------|------|------|--------|------|
| **Весь проект** | ✅ Один раз | ✅ Высокоуровневая архитектура | ✅ Ключевые решения | ✅ Выбор технологий | ✅ Список функций | ✅ Проверка архитектуры | - |
| **Отдельная функция** | Наследуется | ✅ Спецификации функций | ✅ Детали | ✅ Решения по реализации | ✅ Задачи разработки | ✅ **Принудительно** | ✅ Генерация кода |
| **Функциональный модуль** | Наследуется | Наследуется | - | ✅ Проектирование модуля | ✅ Подзадачи | ✅ Необязательно | ✅ Код модуля |
| **Отдельная задача** | Наследуется | Наследуется | - | - | - | - | ✅ Код задачи |

---

## 3. Практический пример: Онлайн-платформа "Умный класс"

### Предыстория проекта

- **Название проекта**: Умный класс
- **Тип проекта**: Платформа онлайн-образования для K12
- **Основные функции**: Управление курсами, проверка домашних заданий, онлайн-экзамены, анализ успеваемости.
- **Технологический стек**: Spring Boot 3.x + Vue 3 + MySQL 8.0 + Redis
- **Цель**: Демонстрация полного SDD-процесса от нуля до рабочего приложения.

---

## Сценарий 1: Инициализация проекта — определение ДНК проекта с помощью Конституции

### Шаг 1: Создание Конституции проекта

```bash
/speckit.constitution Создать принципы проекта, фокусирующиеся на качестве кода, стандартах тестирования, соответствии требованиям образовательной отрасли и производительности.
```

**Ключевое содержание Конституции, сгенерированное ИИ**:

```markdown
# Конституция проекта "Умный класс"

## Статья 1: Принцип приоритета модулей

Каждая функция должна сначала проектироваться как отдельный модуль. Запрещается напрямую реализовывать бизнес-логику в основном коде приложения; она должна быть абстрагирована в многократно используемые компоненты уровня Service.

**Причина**: Принудительное модульное проектирование, повторное использование и тестируемость.

## Статья 2: Принцип четкости интерфейсов

Все сервисы должны определять четкие интерфейсы:
- RESTful API: Единый формат возвращаемых данных с оберткой Result<T>.
- Обработка ошибок: Бизнес-исключения BusinessException, системные исключения перехватываются единообразно.
- Поддержка формата JSON, имена полей в стиле camelCase.

**Причина**: Обеспечение единообразия интерфейсов между фронтендом и бэкендом, упрощение тестирования с помощью Mock.

## Статья 3: Принцип приоритета тестирования (не подлежит обсуждению)

Запрещается писать реализационный код до завершения следующих шагов:
1. Контракты интерфейсов определены (спецификация OpenAPI).
2. Написаны и прошли ревью тестовые случаи.
3. Тесты запущены и показали неудачу (красная фаза TDD).

**Причина**: Предотвращение написания непроверяемого кода, обеспечение ясности требований.

## Статья 4: Принцип безопасности данных (соответствие требованиям образовательной отрасли)

Личные данные учащихся должны:
1. Храниться в зашифрованном виде (AES-256) для номеров телефонов/идентификационных номеров.
2. Маскироваться в логах (135****1234).
3. Экспорт данных требует процедуры утверждения.
4. Соответствовать требованиям "Закона о защите личной информации".

**Последствия нарушения**: Уровень CRITICAL, блокировка запуска.

## Статья 7: Контроль простоты

- Начальная версия максимум 3 Maven-модуля: common, service, web.
- Запрещается добавлять зависимости "которые могут понадобиться в будущем" (например, Elasticsearch, текущего MySQL достаточно).
- Принцип YAGNI: Вам это не понадобится.

## Статья 8: Контроль против избыточной абстракции

- Использовать MyBatis-Plus напрямую, не оборачивать его дополнительным слоем BaseMapper.
- Единое представление модели: Entity напрямую используется для возврата в контроллере (для небольших проектов не требуется разделение DTO/VO).

## Статья 9: Приоритет интеграционных тестов

- Использовать реальный MySQL (docker-compose), а не H2 in-memory базу данных.
- Тесты контроллеров запускать с полной загрузкой `@SpringBootTest`.
- Тестовые данные управлять с помощью SQL-скриптов (src/test/resources/data.sql).
```

**Почему Конституция важна?**

Конституция — это "ген" проекта, определяющий **не подлежащие обсуждению принципы**. Все последующие решения, сгенерированные `/speckit.plan`, должны пройти проверку этими принципами, иначе `/speckit.analyze` выдаст ошибку уровня CRITICAL, блокируя реализацию.

---

## Сценарий 2: Полный цикл разработки функции — от спецификации до реализации

### Шаг 2: Определение спецификаций функции (писать только ЧТО делать, а не КАК делать)

```bash
/speckit.specify Разработать функцию "Проверка домашних заданий". Учителя могут публиковать задания (вопрос + срок + вложения), ученики могут отправлять задания (поддержка загрузки изображений/PDF), учителя могут проверять их онлайн и ставить оценку (0-100 баллов + текстовый комментарий). Начальная версия: 3 учителя, 30 учеников, 2 класса. Статусы заданий: Не отправлено, Отправлено, Проверено, Требует исправления. Ученики могут просматривать результаты проверки и историю. Учителя могут статистику по проценту сдачи и средней оценке в классе. Задания, сданные после срока, отмечаются красным. Контроль доступа: Ученики видят только свои задания, учителя — только задания своих классов.
```

**Вывод**: `specs/001-zuoye-pigai/spec.md`

**Ключевое содержание**:

```markdown
## Обзор функции

**Что делать**: Система онлайн-отправки и проверки домашних заданий.
**Почему**: Заменить традиционную бумажную отправку и проверку, повысить эффективность проверки, сохранить записи об обучении.

## Требования к функции

### Требование 1: Публикация заданий
Учитель может создавать задания, включая следующую информацию:
- Заголовок задания (обязательно, ≤50 символов)
- Содержание задания (обязательно, форматированный текст, поддержка вставки изображений)
- Срок выполнения (обязательно, не ранее текущего времени)
- Вложения (необязательно, поддержка PDF/Word, ≤10 МБ каждое)

### Требование 2: Отправка заданий учениками
学生可以提交作业答案:
- 支持上传图片(jpg/png,单张≤5MB,最多9张)
- 支持上传PDF(≤10MB)
- 可在截止时间前修改提交内容
- 逾期提交策略: 允许逾期提交,但前端显示红色"迟交"标签,教师可酌情扣分

### 需求3: 教师批改
教师可以批改已提交的作业:
- 给分: 0-100整数
- 评语: 文字评价(≤500字)
- 批改时间自动记录

### 需求4: 状态管理
作业对学生有4种状态:
- 未提交: 学生未提交,截止时间内
- 已提交: 学生已提交,等待批改
- 已批改: 教师已批改并给分
- 需修改: 教师要求学生重新提交

### 需求5: 统计功能
教师可查看班级作业统计:
- 提交率: 已提交人数/班级总人数
- 平均分: 已批改作业的平均成绩
- 分数分布: 各分数段人数

### 需求6: 权限控制
- 学生: 只能看到自己提交的作业和批改结果
- 教师: 只能看到自己任教班级的所有学生作业

## 非功能需求

### 性能要求
- 作业列表加载时间 < 1秒(100个作业内)
- 文件上传速度: 5MB文件在10秒内完成

### 数据安全
- 学生姓名和学号符合《个人信息保护法》,日志脱敏
- 作业内容和批改记录保留1年

### 待确认点
- [已确认] 学生逾期是否还能提交? 还是直接锁定?
  - 方案A: 允许逾期提交,但标记"迟交",教师可酌情扣分
  - 方案B: 截止时间后禁止提交

- [已确认] 批改后学生是否可申诉?
  - 方案A: 不支持申诉,教师批改为最终结果
  - 方案B: 学生可发起申诉,教师重新批改

## 用户故事

### 用户故事1: 教师发布作业
**作为** 数学老师张老师
**我想要** 在系统中创建一个作业"第三章练习题"
**以便于** 学生在线提交,我可以集中批改

**验收标准**:
- 输入标题、内容、截止时间(2024-06-30 23:59)
- 上传附件"练习题.pdf"
- 点击"发布"后,2个班级(初一(1)班、初一(2)班)的学生都能看到

### 用户故事2: 学生提交作业
**作为** 初一(1)班学生小明
**我想要** 上传我的作业答案照片
**以便于** 老师批改

**验收标准**:
- 拍摄3张作业照片,上传成功
- 提交后状态变为"已提交"
- 如果在截止时间(2024-06-30 23:59)后提交,显示红色"迟交"标签

### 用户故事3: 教师批改作业
**作为** 张老师
**我想要** 批改小明的作业
**以便于** 给出成绩和反馈

**验收标准**:
- 查看小明上传的3张照片
- 给分: 85分
- 评语: "计算过程清晰,但第3题粗心算错了"
- 保存后,小明可以看到批改结果

## 边界情况

### 边界1: 截止时间恰好到达时提交
学生在2024-06-30 23:59:58提交,是否算逾期?
**决策**: 截止时间当分钟内提交都算准时(≤23:59:59)

### 边界2: 文件上传失败
学生上传5MB图片,网络超时失败。
**处理**: 前端显示"上传失败,请重试",已上传的其他图片保留

### 边界3: 教师误批
教师给小明打了58分,发现输错了,应该是85分。
**处理**: 教师可以重新批改,覆盖之前的成绩和评语

**注意**:
- ✅ 专注于做什么(功能需求)和为什么(业务目标)
- ✅ 标记了2个待确认点,等待`/speckit.clarify`解决
- ❌ 没有提及MySQL、Redis、MyBatis等技术细节

### 步骤3: 澄清待确认点

```bash
/speckit.clarify
```

**AI自动分析并提问**:

```markdown
## 待确认问题

### 问题1: 逾期提交策略(需求2相关)
当前规格不明确。可选方案:

**方案A: 允许逾期提交(推荐)**
- 优点: 灵活,教师可酌情给分
- 缺点: 可能被滥用
- 实现: 数据库加字段`is_late`标记

**方案B: 截止后禁止提交**
- 优点: 规则严格,培养时间观念
- 缺点: 学生忘记截止时间会投诉
- 实现: Controller判断时间,超时返回403

**建议**: 教育场景选方案A,给学生改正机会。

用户选择: 方案A
```

**AI更新规格文档**:

```markdown
### 需求2: 学生提交作业(已更新)

学生可以提交作业答案:
- 支持上传图片(jpg/png,单张≤5MB,最多9张)
- 支持上传PDF(≤10MB)
- 可在截止时间前修改提交内容
- **逾期提交策略**: 允许逾期提交,但前端显示红色"迟交"标签,教师可酌情扣分
```

**问题2: 批改后申诉机制**

```markdown
**方案A: 不支持申诉(推荐MVP)**
- 优点: 简单,减少争议
- 缺点: 教师误批无法纠正?
- 实现: 无需额外表设计

**方案B: 支持申诉流程**
- 优点: 公平,可纠错
- 缺点: 复杂,需要申诉表、通知机制
- 实现: 需要`homework_appeal`表 + 消息推送

**建议**: 初始版本选方案A,但教师可自行修改批改结果(等同简化版申诉)。

用户选择: 方案A,但允许教师修改
```

**澄清完成,所有待确认点已解决**。

### 步骤4: 制定技术方案(开始涉及怎么做)

```bash
/speckit.plan 使用Spring Boot 3.2 + MyBatis-Plus + MySQL 8.0 + Redis作为缓存。文件上传使用阿里云OSS,统计数据用Redis缓存5分钟。前端Vue3 + Element Plus,图片预览用viewerjs。
```

**输出**: `specs/001-zuoye-pigai/plan.md`, `data-model.md`, `contracts/api-spec.yaml`

**技术方案关键内容**:

```markdown
## 技术架构

### 技术选型
- **后端框架**: Spring Boot 3.2.5
- **ORM**: MyBatis-Plus 3.5.6(简化CRUD)
- **数据库**: MySQL 8.0
- **缓存**: Redis 7.0(缓存班级统计数据)
- **文件存储**: 阿里云OSS(存储作业附件和学生提交的图片)
- **前端**: Vue 3.3 + Element Plus + Axios
- **图片预览**: viewerjs

### 第0阶段: 实现前检查(宪法关卡)

#### 简单性关卡(第七条)
- [✅] 使用≤3个Maven模块?
  是: homework-common、homework-service、homework-web
- [✅] 无未来导向功能?
  是: 不引入Elasticsearch(当前MySQL够用)

#### 反过度抽象关卡(第八条)
- [✅] 直接使用框架?
  是: 用MyBatis-Plus BaseMapper,不再封装
- [⚠️] 单一模型表示?
  否: 分离Entity和VO(理由: Entity包含敏感字段如`student_id_card`,VO需要脱敏)
  **复杂度跟踪**: 已记录,用户审批

#### 测试先行关卡(第三条)
- [✅] 契约已定义?
  是: 见`contracts/api-spec.yaml`
- [⏳] 契约测试已写?
  待执行: 在`/speckit.tasks`阶段完成

### 核心实现阶段

#### 阶段1: 数据层搭建
1. 创建MySQL表: `homework`(作业表)、`homework_submission`(提交表)、`homework_review`(批改表)
2. 实现Entity: HomeworkEntity、HomeworkSubmissionEntity、HomeworkReviewEntity
3. MyBatis-Plus Mapper: HomeworkMapper、SubmissionMapper、ReviewMapper
4. 数据初始化: 3个教师、30个学生、2个班级

#### 阶段2: 业务层实现
1. HomeworkService: 发布作业、查询作业列表
2. SubmissionService: 提交作业、查询提交记录、判断逾期
3. ReviewService: 批改作业、修改批改
4. StatisticsService: 计算提交率、平均分(Redis缓存5分钟)

#### 阶段3: 接口层实现
1. HomeworkController: POST /api/homework(发布), GET /api/homework/list(列表)
2. SubmissionController: POST /api/submission(提交), GET /api/submission/:id(详情)
3. ReviewController: POST /api/review(批改), PUT /api/review/:id(修改)
4. FileController: POST /api/file/upload(OSS上传)

#### 阶段4: 前端页面
1. 教师端: 作业发布页、批改页、统计页
2. 学生端: 作业列表页、提交页、结果查看页
3. 公共组件: 文件上传组件、图片预览组件
```

**数据模型(data-model.md)**:

```markdown
## 数据表设计

### 作业表(homework)
```sql
CREATE TABLE homework (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '作业ID',
  title VARCHAR(50) NOT NULL COMMENT '作业标题',
  content TEXT NOT NULL COMMENT '作业内容(富文本)',
  teacher_id BIGINT NOT NULL COMMENT '发布教师ID',
  class_ids VARCHAR(200) NOT NULL COMMENT '班级ID列表(JSON数组)',
  deadline DATETIME NOT NULL COMMENT '截止时间',
  attachment_url VARCHAR(500) COMMENT '附件OSS地址',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_teacher_id (teacher_id),
  INDEX idx_deadline (deadline)
) COMMENT='作业表';
```

### 提交表(homework_submission)
```sql
CREATE TABLE homework_submission (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  homework_id BIGINT NOT NULL COMMENT '作业ID',
  student_id BIGINT NOT NULL COMMENT '学生ID',
  content TEXT COMMENT '提交内容(文字)',
  image_urls TEXT COMMENT '图片地址列表(JSON数组)',
  pdf_url VARCHAR(500) COMMENT 'PDF地址',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1未批改 2已批改 3需修改',
  is_late TINYINT NOT NULL DEFAULT 0 COMMENT '0准时 1逾期',
  submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_homework_student (homework_id, student_id),
  INDEX idx_student_id (student_id),
  INDEX idx_status (status)
) COMMENT='作业提交表';
```

### 批改表(homework_review)
```sql
CREATE TABLE homework_review (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  submission_id BIGINT NOT NULL COMMENT '提交ID',
  teacher_id BIGINT NOT NULL COMMENT '批改教师ID',
  score TINYINT NOT NULL COMMENT '分数0-100',
  comment VARCHAR(500) COMMENT '评语',
  reviewed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '批改时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_submission (submission_id),
  INDEX idx_teacher_id (teacher_id)
) COMMENT='批改表';
```
```

**API契约(contracts/api-spec.yaml)**:

```yaml
openapi: 3.0.0
info:
  title: 智慧课堂-作业批改API
  version: 1.0.0

paths:
  /api/homework:
    post:
      summary: 发布作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [title, content, classIds, deadline]
              properties:
                title:
                  type: string
                  maxLength: 50
                  example: "第三章练习题"
                content:
                  type: string
                  example: "<p>完成第45-50页习题</p>"
                classIds:
                  type: array
                  items:
                    type: integer
                  example: [1, 2]
                deadline:
                  type: string
                  format: date-time
                  example: "2024-06-30T23:59:59"
                attachmentUrl:
                  type: string
                  example: "https://oss.example.com/homework/xxx.pdf"
      responses:
        '200':
          description: 发布成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'

  /api/submission:
    post:
      summary: 提交作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [homeworkId]
              properties:
                homeworkId:
                  type: integer
                  example: 1
                content:
                  type: string
                  example: "我的答案是..."
                imageUrls:
                  type: array
                  items:
                    type: string
                  example: ["https://oss.example.com/sub/1.jpg", "https://oss.example.com/sub/2.jpg"]
                pdfUrl:
                  type: string
      responses:
        '200':
          description: 提交成功

  /api/review:
    post:
      summary: 批改作业
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [submissionId, score]
              properties:
                submissionId:
                  type: integer
                score:
                  type: integer
                  minimum: 0
                  maximum: 100
                  example: 85
                comment:
                  type: string
                  maxLength: 500
                  example: "Процесс расчета понятен, но в задаче 3 была допущена вычислительная ошибка"
      responses:
        '200':
          description: Оценка успешна

components:
  schemas:
    Result:
      type: object
      properties:
        code:
          type: integer
          example: 200
        message:
          type: string
          example: "Операция успешна"
        data:
          type: object
```

### Шаг 5: Разделение на выполнимые задачи

```bash
/speckit.tasks
```

**Вывод**: `specs/001-zuoye-pigai/tasks.md`

```markdown
## Разбивка задач

### Фаза 0: Создание структуры и контрактов

#### Задача 001 [Параллельно] - Создание структуры проекта
- Инициализация проекта Spring Boot (maven)
- Создание 3 модулей: common, service, web
- Конфигурация зависимостей pom.xml (MyBatis-Plus, Redis, OSS SDK)
- **Результат**: Проект компилируется

#### Задача 002 [Параллельно] - Определение контрактов API
- Копирование `contracts/api-spec.yaml` в проект
- Генерация Java DTO с помощью swagger-codegen
- **Результат**: Классы DTO могут быть использованы Controller

#### Задача 003 [Зависимость: Задача 002] - Написание контрактных тестов
- Тест: POST /api/homework возвращает 200
- Тест: POST /api/submission без homeworkId возвращает 400
- Тест: POST /api/review score=101 возвращает 400
- **Результат**: Все тесты не пройдены (фаза TDD Red)

### Фаза 1: Слой данных (Параллельная группа A)

#### Задача 004 [Параллельно] [Зависимость: Задача 003] - Настройка MySQL
- Запуск MySQL 8.0 с помощью docker-compose
- Создание базы данных `classroom_db`
- Выполнение DDL скриптов (homework, homework_submission, homework_review)
- **Результат**: Структура таблиц создана

#### Задача 005 [Параллельно] [Зависимость: Задача 003] - Инициализация начальных данных
- Вставка 3 преподавателей: Учитель Чжан (математика), Учитель Ли (китайский), Учитель Ван (английский)
- Вставка 30 студентов: номера студентов 1001-1030, распределение по 2 классам
- Вставка 2 классов: Седьмой класс (1), Седьмой класс (2)
- **Результат**: Начальные данные доступны для запросов

### Фаза 2: Реализация бизнес-логики (Зависимость: Фаза 1)

#### Задача 006 [Зависимость: Задача 004] - Реализация HomeworkService
- Создание HomeworkMapper (MyBatis-Plus)
- Реализация публикации задания: `publishHomework(HomeworkDTO dto)`
- Реализация запроса списка: `listHomework(Long teacherId)`
- **Результат**: Тест POST /api/homework из Задачи 003 пройден (становится Green)

#### Задача 007 [Зависимость: Задача 004] - Реализация SubmissionService
- Создание SubmissionMapper
- Реализация отправки задания: `submitHomework(SubmissionDTO dto)`
- Реализация определения просрочки: `isLate(Long homeworkId, LocalDateTime submitTime)`
- Реализация запроса: `getSubmission(Long submissionId)`
- **Результат**: Тест POST /api/submission пройден

#### Задача 008 [Зависимость: Задача 004] - Реализация ReviewService
- Создание ReviewMapper
- Реализация оценки: `reviewHomework(ReviewDTO dto)`
- Реализация изменения оценки: `updateReview(Long reviewId, ReviewDTO dto)`
- **Результат**: Тест POST /api/review пройден

### Фаза 3: Слой API (Параллельная группа B)

#### Задача 009 [Параллельно] [Зависимость: Задача 006] - HomeworkController
- Создание Controller, внедрение HomeworkService
- Реализация POST /api/homework
- Реализация GET /api/homework/list?teacherId=1
- Проверка прав: только преподаватели могут публиковать
- **Результат**: Тесты Postman пройдены

#### Задача 010 [Параллельно] [Зависимость: Задача 007] - SubmissionController
- Реализация POST /api/submission
- Реализация GET /api/submission/:id
- Проверка прав: студенты могут запрашивать только свои отправки
- **Результат**: Фронтенд может вызывать API

#### Задача 011 [Зависимость: Задача 008] - ReviewController
- Реализация POST /api/review
- Реализация PUT /api/review/:id (изменение оценки)
- Проверка прав: преподаватели могут оценивать только задания студентов своего класса
- **Результат**: Полный процесс оценки завершен

#### Задача 012 [Параллельно] - FileController загрузка файлов
- Интеграция Alibaba Cloud OSS SDK
- Реализация POST /api/file/upload (поддержка изображений/PDF)
- Проверка размера файла: изображение ≤ 5 МБ, PDF ≤ 10 МБ
- Возврат адреса OSS
- **Результат**: Фронтенд может загружать файлы и получать URL

#### Задача 013 [Зависимость: Задача 007] - StatisticsService функция статистики
- Реализация расчета процента сдачи: `calcSubmitRate(Long homeworkId)`
- Реализация расчета среднего балла: `calcAvgScore(Long homeworkId)`
- Кэширование Redis на 5 минут (ключ: `stats:homework:{id}`)
- **Результат**: GET /api/statistics/:homeworkId возвращает статистические данные

### Фаза 4: Страницы фронтенда

#### Задача 014 [Зависимость: Задача 009] - Страница публикации задания преподавателем
- Компонент Vue: HomeworkPublish.vue
- Форма: Заголовок, редактор форматированного текста, выбор срока выполнения
- Вызов POST /api/homework
- **Результат**: Преподаватели могут публиковать задания

#### Задача 015 [Зависимость: Задача 010, Задача 012] - Страница отправки задания студентом
- Компонент Vue: HomeworkSubmit.vue
- Компонент загрузки изображений (максимум 9)
- Компонент загрузки PDF
- Подсказка о просрочке (красная метка "Просрочено")
- **Результат**: Студенты могут отправлять задания

#### Задача 016 [Зависимость: Задача 011] - Страница оценки задания преподавателем
- Компонент Vue: HomeworkReview.vue
- Предварительный просмотр изображений (viewerjs)
- Поле ввода оценки (0-100)
- Текстовое поле для комментариев
- **Результат**: Преподаватели могут оценивать задания

### Фаза 5: Интеграционное тестирование и подготовка к запуску

#### Задача 017 - Сквозное тестирование
- Сценарий 1: Учитель Чжан публикует задание → Сяо Мин отправляет (вовремя) → Учитель Чжан оценивает на 85 баллов
- Сценарий 2: Сяо Хуан отправляет с опозданием → Отображается красная метка
- Сценарий 3: Учитель Чжан изменяет оценку Сяо Мина на 90 баллов
- **Результат**: Все сценарии пройдены

#### Задача 018 - Проверка производительности
- Загрузка списка из 100 заданий, проверка времени отклика (цель < 1 секунды)
- Загрузка файла размером 5 МБ, проверка времени загрузки (цель < 10 секунд)
- **Результат**: Нефункциональные требования выполнены

## План выполнения

### Неделя 1
- Параллельные группы: Задачи 001, 002, 004, 005
- Последовательно: Задача 003 (написание контрактных тестов завершено)

### Неделя 2
- Последовательно: Задача 006 → Задача 007 → Задача 008 (реализация бизнес-логики)
- Параллельный запуск: Задача 012 (загрузка файлов, независимо)

### Неделя 3
- Параллельная группа B: Задачи 009, 010 (слой Controller)
- Последовательно: Задача 011, 013

### Неделя 4
- Фронтенд: Задача 014 → Задача 015 → Задача 016
- Последние: Задачи 017, 018 (тестирование и проверка)

## Статистические показатели
- Общее количество задач: 18
- Предполагаемый срок: 4 недели
- Параллельных задач: 7
- Критический путь: Задача 002 → Задача 003 → Задача 004 → Задача 006 → Задача 009 → Задача 014 → Задача 017
```

### Шаг 6: Запуск проверки качества (Критически важно!)

```bash
/speckit.analyze
```

**AI выполняет проверку**:

```markdown
# Отчет об анализе спецификаций

## Сводка выполнения
- Общее количество функциональных требований: 6
- Общее количество нефункциональных требований: 2
- Общее количество задач: 18
- Покрытие: 100% (8/8 требований имеют соответствующие задачи)
- **КРИТИЧЕСКИЕ проблемы: 1**
- ВЫСОКИЕ проблемы: 2
- СРЕДНИЕ проблемы: 3
- НИЗКИЕ проблемы: 1

## ❌ КРИТИЧЕСКИЕ проблемы (должны быть исправлены перед /implement)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Рекомендация |
|----|------|--------|------|----------|------|
| C1 | Нарушение конституции | CRITICAL | Фаза 2 задач.md | Нарушение принципа "сначала тесты" статьи 3: Задача 006 "Реализация HomeworkService" выполняется до Задачи 003 "Контрактные тесты" | Изменить зависимости: Задача 003 должна выполняться до Задачи 004-005, чтобы гарантировать реализацию после провала теста |

## ⚠️ ВЫСОКИЕ проблемы (настоятельно рекомендуется исправить)

| ID | Категория | Серьезность | Местоположение | Описание проблемы | Рекомендация |
|----|------|--------|------|----------|------|
| H1 | Отсутствие покрытия | HIGH | Требование 4 spec.md | Отсутствует задача для состояния "требуется изменение" | Добавить метод `setNeedRevision()` в ReviewService |
| H2 | Двусмысленность | HIGH | Фаза 3 plan.md | "Проверка прав" не указывает, какой код ошибки возвращается при сбое | Указать: Отсутствие прав возвращает 403 с сообщением "Нет доступа" |

## 📊 Детализация покрытия

| Требование | Есть задача? | ID задачи | Примечание |
|------|--------|--------|------|
| Требование 1: Публикация задания | ✅ | Задача 006, Задача 009 | Полное покрытие |
| Требование 2: Отправка задания студентом | ✅ | Задача 007, Задача 010 | Полное покрытие |
| Требование 3: Оценка задания преподавателем | ✅ | Задача 008, Задача 011 | Полное покрытие |
| Требование 4: Управление состоянием | ⚠️ | Задача 007 (частично) | Отсутствует обработка состояния "требуется изменение", см. H1 |
| Требование 5: Статистика | ✅ | Задача 013 | Полное покрытие |
| Требование 6: Контроль доступа | ✅ | Задачи 009-011 | Каждый Controller имеет проверку |
| Нефункциональное 1: Производительность | ✅ | Задача 018 | Полное покрытие |
| Нефункциональное 2: Безопасность данных | ✅ | Автоматически выполняется по статье 4 Конституции | Полное покрытие |

## 🚨 Проблемы соответствия Конституции

### Нарушение статьи 3 (CRITICAL)
**Местоположение**: Фаза 2 задач.md
**Проблема**: Задача 006 "Реализация HomeworkService" зависит от Задачи 004 (база данных), но должна зависеть от Задачи 003 (провал контрактного теста)
**Оригинал Конституции**: "Запрещается писать код реализации до того, как тест подтвердил провал"
**Исправление**: Изменить порядок зависимостей задач: Задача 003 → Задача 004 → Задача 006

## 📈 Статистические показатели
- Коэффициент покрытия требований: 100% (8/8)
- Коэффициент отображения задач: 94% (17/18, Задача 001 - базовая настройка)
- Количество двусмысленностей: 1 (H2)
- Количество дубликатов: 0
- КРИТИЧЕСКИЕ проблемы: 1

## ⚙️ Следующие шаги

### ❌ Блокировка: Невозможно выполнить /implement
**Причина**: 1 КРИТИЧЕСКАЯ проблема (нарушение конституции)

### Обязательно исправить:
1. **Исправить C1**: Изменить порядок зависимостей задач в tasks.md
   - Изменение: Зависимость Задачи 006 изменить с `[Зависимость: Задача 004]` на `[Зависимость: Задача 003]`
   - Обоснование: Контрактные тесты должны сначала провалиться, прежде чем начинать реализацию.

2. **Решить H1**: Добавить обработку состояния "требуется изменение"
   - В Задаче 008 добавить подзадачу: "Реализовать метод `setNeedRevision()`"

### После исправления:
Повторно запустить `/speckit.analyze`, чтобы убедиться, что CRITICAL=0, затем выполнить `/speckit.implement`.
```

**Ответ пользователя**:

```
Исправить C1 и H1
```

**AI автоматически исправляет tasks.md**:

```markdown
#### Задача 003 [Зависимость: Задача 002] - Написание контрактных тестов
(Содержание без изменений)

#### Задача 004 [Зависимость: Задача 003] - Настройка MySQL  ← Изменение: добавлена зависимость от Задачи 003
- Запуск MySQL 8.0 с помощью docker-compose
- ...

#### Задача 006 [Зависимость: Задача 004, Задача 003] - Реализация HomeworkService  ← Изменение: явно указана зависимость от 003
- ...

#### Задача 008 [Зависимость: Задача 004] - Реализация ReviewService
- Создание ReviewMapper
- Реализация оценки: `reviewHomework(ReviewDTO dto)`
- Реализация изменения оценки: `updateReview(Long reviewId, ReviewDTO dto)`
- **Добавлено: Реализация установки статуса "требуется изменение": `setNeedRevision(Long submissionId, String reason)`**  ← Добавлено
- **Результат**: Тест POST /api/review пройден
```

**Повторный запуск `/speckit.analyze`**:

```bash
/speckit.analyze
```

```markdown
# Отчет об анализе спецификаций

## Сводка выполнения
- **КРИТИЧЕСКИЕ проблемы: 0** ✅
- ВЫСОКИЕ проблемы: 1 (H2 - Стандарт кодов ошибок)
- СРЕДНИЕ проблемы: 3
- НИЗКИЕ проблемы: 1

## ⚙️ Следующие шаги
✅ **Готовность**: Нет КРИТИЧЕСКИХ проблем. ВЫСОКИЕ/СРЕДНИЕ проблемы являются улучшениями и не блокируют реализацию.

Можно выполнить: `/speckit.implement`
```

### Шаг 7: Выполнение реализации (генерация кода в стиле TDD)

```bash
/speckit.implement
```

**AI выполняет процесс** (строго в стиле TDD):

```
[Задача 001] Создание структуры проекта...
✅ Проект Maven создан, 3 модуля компилируются

[Задача 002] Определение контрактов API...
✅ DTO сгенерированы из api-spec.yaml: HomeworkDTO, SubmissionDTO, ReviewDTO

[Задача 003] Написание контрактных тестов...
```java
@SpringBootTest
@AutoConfigureMockMvc
class HomeworkControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void testPublishHomework_успешно() throws Exception {
        HomeworkDTO dto = new HomeworkDTO()
            .setTitle("Упражнения третьей главы")
            .setContent("<p>Завершить страницы 45-50</p>")
            .setClassIds(Arrays.asList(1L, 2L))
            .setDeadline(LocalDateTime.of(2024, 6, 30, 23, 59));

        mockMvc.perform(post("/api/homework")
                .contentType(MediaType.APPLICATION_JSON)
                .content(JsonUtil.toJson(dto)))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200));
    }

    @Test
    void testPublishHomework_пустой_заголовок_возвращает_400() throws Exception {
        HomeworkDTO dto = new HomeworkDTO()
            .setContent("Содержание")
            .setDeadline(LocalDateTime.now().plusDays(1));

        mockMvc.perform(post("/api/homework")
                .contentType(MediaType.APPLICATION_JSON)
                .content(JsonUtil.toJson(dto)))
            .andExpect(status().isBadRequest());
    }
}
```
❌ Тест не пройден (ожидается) - Controller еще не реализован

[Задача 004] Настройка MySQL...
✅ Контейнер Docker запущен, структура таблиц создана

[Задача 005] Инициализация начальных данных...
✅ Вставлены данные для 3 преподавателей, 30 студентов, 2 классов

[Задача 006] Реализация HomeworkService...
```java
@Service
public class HomeworkServiceImpl implements HomeworkService {

    @Autowired
    private HomeworkMapper homeworkMapper;

    @Override
    public Long publishHomework(HomeworkDTO dto) {
        HomeworkEntity entity = new HomeworkEntity();
        BeanUtils.copyProperties(dto, entity);
        entity.setCreatedAt(LocalDateTime.now());
        homeworkMapper.insert(entity);
        return entity.getId();
    }

    @Override
    public List<HomeworkVO> listHomework(Long teacherId) {
        return homeworkMapper.selectList(
            new QueryWrapper<HomeworkEntity>()
                .eq("teacher_id", teacherId)
                .orderByDesc("created_at")
        ).stream()
         .map(this::toVO)
         .collect(Collectors.toList());
    }
}
```

[Task 009] Implement HomeworkController...
```java
@RestController
@RequestMapping("/api/homework")
public class HomeworkController {

    @Autowired
    private HomeworkService homeworkService;

    @PostMapping
    public Result<Long> publishHomework(@Validated @RequestBody HomeworkDTO dto,
                                        @RequestAttribute Long teacherId) {
        Long id = homeworkService.publishHomework(dto);
        return Result.success(id);
    }

    @GetMapping("/list")
    public Result<List<HomeworkVO>> listHomework(@RequestAttribute Long teacherId) {
        List<HomeworkVO> list = homeworkService.listHomework(teacherId);
        return Result.success(list);
    }
}
```
✅ Task 003 tests now pass - TDD loop complete

... (Similar TDD loops for Tasks 007-018)

[Task 018] Performance verification...
✅ Load 100 homework list time: 0.8 seconds (Target < 1 second)
✅ Upload 5MB image time: 7 seconds (Target < 10 seconds)

🎉 All 18 tasks completed. Functionality is ready for testing.
```

**Final Deliverables**:
- ✅ Fully runnable "Homework Grading" feature
- ✅ All 18 tasks completed, all tests passed
- ✅ All constitutional principles met (modular, test-first, data security)
- ✅ Front-end and back-end integrated, ready for actual use by teachers and students

---

## Scenario 3: Real-world case of /analyze discovering issues

### Case: Discovering data security violations

Assume when running `/speckit.analyze` in Step 6, the following is found:

```markdown
| ID | Category | Severity | Location | Description | Recommendation |
|----|----------|----------|----------|-------------|----------------|
| C2 | Constitutional Violation | CRITICAL | plan.md data model | Violation of Article 4 "Data Security Principle": student_id_card field is not encrypted | Add field student_id_card_encrypted, store AES encrypted data |
```

**Fixing Process**:

**Step 1: Determine the issue level**

This is a `/speckit.plan` level issue (data model design), requiring a rollback to `/speckit.plan`.

**Step 2: Update data-model.md**

```markdown
### Student Table (student) - Fixed

```sql
CREATE TABLE student (
  id BIGINT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  student_no VARCHAR(20) NOT NULL COMMENT 'Student ID',
  -- Before modification: id_card VARCHAR(18) COMMENT 'ID Card Number'
  id_card_encrypted VARCHAR(200) COMMENT 'ID Card Number (AES-256 Encrypted)',  ← Fixed
  phone_encrypted VARCHAR(200) COMMENT 'Phone Number (AES-256 Encrypted)',     ← Fixed
  class_id BIGINT NOT NULL,
  ...
);
```

**Step 3: Update tasks.md**

```markdown
#### Task 005 - Initialize Seed Data (Updated)
- Insert 30 student records
- **New: Encrypt ID card and phone numbers using AESUtil before storing**
- **New: Configure encryption keys (read from environment variables, do not commit to Git)**
```

**Step 4: Re-run `/speckit.analyze`**

```bash
/analyze
```

```markdown
## Execution Summary
- **CRITICAL Issues: 0** ✅
- Constitutional Article 4: Compliant

✅ Ready to execute `/speckit.implement`
```

**Key Point**: `/speckit.analyze` acts like a compiler, catching security risks before "execution".

---

## Scenario 4: Rapid response to requirement changes

### Change Request

Product Manager proposes:

```
Requirement Change: Add a "Featured Homework" display feature. Teachers can mark homework graded ≥90 as "Featured", which will be displayed on the class bulletin board for other students to learn from (displaying "Featured Homework" instead of student names).
```

**SDD Handling Process**:

**Step 1: Determine the change level**

| Change Type | Impact Level | Rollback Required To |
|-------------|--------------|----------------------|
| Button color change | Implementation Detail | `/speckit.implement` |
| Add "is_excellent" field | Data Model | `/speckit.plan` |
| New "Display Feature" | Feature Definition | `/speckit.specify` |
| Change project architecture | Project DNA | `/speckit.constitution` |

**Current Change**: New Feature → Rollback to `/speckit.specify`

**Step 2: Update spec.md**

```markdown
### Requirement 7: Featured Homework Display (New)

Teachers can mark homework graded ≥90 as "Featured Homework", which will be displayed on the class bulletin board.

**Feature Details**:
- When grading, teachers can check "Mark as Featured Homework".
- The class bulletin board will display a list of featured homework (in reverse chronological order).
- Students can view the content of featured homework, but the submitter's name will not be displayed (displaying "Featured Homework Example").
- Teachers can unmark homework as "Featured".

**Acceptance Criteria**:
- Teacher Zhang grades Xiao Ming's homework with 95 points and checks "Featured".
- Student Xiao Hong in Class 1 Grade 7 sees this homework on the bulletin board, displayed as "Featured Homework Example".
- Xiao Hong can view the homework details but not see who submitted it.
```

**Step 3: Re-execute subsequent steps**

```bash
/clarify  # AI might ask: Can a single homework be marked as multiple featured examples?
/plan     # AI updates plan.md, adds is_excellent field to homework_submission table
/tasks    # AI automatically inserts new tasks
```

**AI-Generated New Tasks**:

```markdown
#### Task 008.1 [Depends on: Task 008] - Mark Featured Homework Feature
- Add `markAsExcellent(Long submissionId)` method to ReviewService.
- Add `is_excellent` field (0=No, 1=Yes) to homework_submission table.
- **Deliverable**: Teacher can mark homework as featured.

#### Task 019 [Depends on: Task 008.1] - Featured Homework Display API
- Implement GET /api/excellent-homework/list?classId=1.
- Anonymize returned data: change `studentName` field to "Featured Homework Example".
- **Deliverable**: Front-end can fetch the list of featured homework.

#### Task 020 [Depends on: Task 019] - Front-end Bulletin Board Page
- Vue component: ExcellentHomeworkList.vue.
- Display featured homework (without student information).
- Click to view details.
- **Deliverable**: Students can view featured homework.
```

**Step 4: Run /analyze**

```bash
/analyze
```

```markdown
## Execution Summary
- **CRITICAL Issues: 0** ✅
- New Requirement Coverage: 100% (Requirement 7 covered by 3 tasks)

✅ Ready for: `/speckit.implement`
```

**Step 5: Incremental Implementation**

```bash
/implement
```

AI generates only the new tasks 008.1, 019, and 020, without regenerating the entire project.

**Time Comparison**:

| Phase | Traditional Development | SDD Approach |
|-------|-------------------------|--------------|
| Update PRD | 1 hour | 5 minutes (editing spec.md) |
| Design Review | 2 hours | 0 minutes (automatic) |
| Code Modification | 4 hours | 15 minutes (/implement) |
| Test Verification | 2 hours | Automatic (TDD) |
| **Total** | **9 hours** | **20 minutes** |
| **Speedup Ratio** | - | **27x** |

---

## IV. In-depth Analysis of Three Core Mechanisms

### 4.1 Constitution: How to Automatically Constrain LLM Behavior

#### Nine Categories of Constitutional Principles (Example: Smart Classroom)

| Article | Content | How to Detect | Violation Consequences |
|---------|---------|---------------|------------------------|
| **Article 1: Modularity First** | Features must be built as independent Services | `/speckit.analyze` detects business logic written directly in Controllers | CRITICAL Error |
| **Article 2: Clear Interfaces** | Use consistent `Result<T>` return format | `/speckit.analyze` detects Controller return types | HIGH Warning |
| **Article 3: Test First** | Write tests before implementation | `/speckit.implement` checks task order | Rejects code generation |
| **Article 4: Data Security** | Encrypt sensitive information during storage | `/speckit.analyze` detects `_encrypted` fields | CRITICAL Error |
| **Article 7: Simplicity** | ≤ 3 Maven modules | `/speckit.plan` checks during generation | Requires written justification |
| **Article 8: Avoid Over-Abstraction** | Use MyBatis-Plus directly | `/speckit.analyze` detects unnecessary Wrappers | Requires justification |
| **Article 9: Integration Testing** | Test with a real MySQL database | `/speckit.implement` checks test configuration | Test suite fails |

#### How the Constitution is Automatically Enforced During /implement

**Example: Enforcement of Article 3 "Test First"**

1. **User runs `/speckit.implement`**
2. **AI reads Article 3 of the Constitution**:
   ```
   Prohibit writing implementation code before the completion of the following steps:
   1. Contract tests are written.
   2. Tests have passed user review.
   3. Tests have been run and confirmed to fail.
   ```
3. **AI enforces TDD workflow**:
   ```
   [Task 003] Write contract tests...

   @Test
   void testPublishHomework() {
       // Call the API
       Result<Long> result = homeworkController.publishHomework(dto, 1L);
       // Assert
       assertEquals(200, result.getCode());
   }

   ❌ Test Failure (Expected) - HomeworkService not yet implemented

   [Waiting for user confirmation...]

   User: "Tests look good, proceed."

   // Now AI generates the implementation code
   [Task 006] Implement HomeworkService...
   ```

**Traditional AI Coding** vs **Constitution-Constrained AI Coding**:

| Aspect | Traditional AI | Constitution-Constrained AI |
|--------|----------------|----------------------------|
| Testing | Post-hoc testing (or none) | Mandatory Test-First |
| Architecture | Arbitrary module creation | ≤ 3 modules, justification required for more |
| Data Security | May store in plain text | Sensitive fields must be encrypted, otherwise CRITICAL |
| Quality | Relies on manual review | `/speckit.analyze` automatically detects violations |

#### How to Customize the Constitution for Your Project

**Step 1: Identify Non-Negotiable Principles**

Ask yourself:
- What technical decisions, if made incorrectly, would cause the project to fail?
- What code quality standards must be adhered to 100%?
- What architectural principles cannot be sacrificed for deadlines?

**Example: Constitution for a Financial Payment Project**

```markdown
# Payment System Project Constitution

## Article 1: Idempotency Principle (Non-Negotiable)

All write operation APIs must:
1. Accept an idempotency-key header.
2. Return the same result for repeated requests, preventing duplicate charges.
3. Store the idempotency-key in Redis for 24 hours.

Violation = CRITICAL, blocks deployment.

## Article 2: Mandatory Audit Logging

All state changes must:
1. Record the operator, timestamp, and pre/post values.
2. Write to the `audit_log` table (append-only).
3. Be retained for 7 years (regulatory requirement).

Violation = CRITICAL, fails compliance.

## Article 3: Amount Precision

All monetary calculations must:
1. Use `BigDecimal`, disallow `float`/`double`.
2. Round to the cent (2 decimal places) using round-half-up.
3. Unit tests must cover boundary values (0.01, -0.01, Max).

Violation = HIGH, requires fixing.

## Article 4: Performance Budget

All APIs must:
1. P95 latency < 200ms.
2. P99 latency < 500ms.
3. Support 1000 QPS concurrency.

Violation = HIGH, requires performance optimization tasks.
```

**Step 2: Define Checkpoints in the `/plan` Phase**

```markdown
### Phase 0: Pre-Implementation Checks

#### Idempotency Checkpoint (Article 1)
- [ ] All POST/PUT endpoints accept `idempotency-key`?
- [ ] Redis configuration is ready?
- [ ] Test cases for duplicate requests are written?

#### Audit Checkpoint (Article 2)
- [ ] `audit_log` table created?
- [ ] AOP aspect configured?

#### Amount Precision Checkpoint (Article 3)
- [ ] `pom.xml` prohibits the introduction of Lombok (which generates float builders)?
- [ ] All monetary fields are of type `BigDecimal`?
```

**Step 3: `/analyze` Executes Checks Automatically**

```bash
/analyze
```

AI automatically scans:
```markdown
| ID | Category | Severity | Location | Issue | Recommendation |
|----|----------|----------|----------|-------|----------------|
| C1 | Constitutional Violation | CRITICAL | PaymentService.java:45 | Violation of Article 3: Using `double` type for amount calculation | Change to `BigDecimal` |
| C2 | Constitutional Violation | CRITICAL | tasks.md | Violation of Article 2: No audit logging task | Add task: Implement audit AOP |
```

### 4.2 Template: Guiding LLMs to Generate High-Quality Specifications

#### How Templates Constrain LLM Output

**Problem**: Directly asking an LLM "Write a PRD for a login feature" results in vague output.

**Traditional Prompt** (Low Quality):
```
User: Help me write a requirements document for a student homework submission feature.

AI: The student homework submission feature includes:
1. Students can upload homework after logging in.
2. File upload is supported.
3. Teachers can see it after submission.

(Problem: Too vague, lacks edge cases and error handling)
```

**Template-Constrained Approach** (High Quality):
```
User: /specify Student Homework Submission Feature

AI: (Reads spec-template.md)

Template Requirements:
- ✅ Focus on WHAT and WHY, not HOW.
- ✅ Use [To Confirm] for ambiguous points.
- ✅ Include edge cases.
- ✅ Define measurable acceptance criteria.

Generated spec.md:

## Feature Overview
**What**: Students submit homework answers online.
**Why**: To replace paper submissions, facilitating archiving and grading.

## Functional Requirements

### Requirement 1: File Upload
Students can upload homework files.

[To Confirm: What file formats are supported? Images, PDFs, or Word documents?]
[To Confirm: What is the file size limit? 5MB or 10MB?]

## Edge Cases

### Edge Case 1: Upload Timeout
Student uploads a 5MB file, network is slow, and it's not completed within 30 seconds.
**Handling**: The front-end displays an upload progress bar; if it exceeds 30 seconds, prompt "Please check your network."
### 边界2: 重复提交
学生提交后发现错误，想重新提交。
[待确认：允许修改吗？还是一次提交后锁定？]

## 非功能性需求

### 性能要求
- 上传5MB文件在10秒内完成（正常网络）
- 支持50个学生同时上传

### 数据安全
- 作业文件存储在OSS，有访问权限控制
- 学生只能访问自己的作业，不能访问他人的
```

**对比**: 模板强制AI思考了：
1. ✅ 核心功能（需求1）
2. ✅ 边界情况（超时、重复提交）
3. ✅ 标记歧义（2个待确认点）
4. ✅ 性能指标（有具体数字：10秒、50人）
5. ✅ 数据安全（权限控制）
6. ✅ 可测试性（验收标准明确）
7. ✅ 没有技术实现（没提OSS、MySQL）

#### [待确认] 机制：强制AI承认不确定性

**问题**: LLM倾向于“猜测”缺失信息，导致错误假设。

**解决**: 模板强制标记：

```markdown
创建规格时的规则：
1. **标记所有歧义点**：使用[待确认：具体问题]
2. **不要猜测**：如果prompt没说，就标记
3. **提供选项**：给出2-3个备选方案
```

**实战示例**：

用户prompt：
```
/specify 开发一个文件上传功能
```

AI生成（带待确认标记）：
```markdown
## 需求1：文件上传

用户可以上传文件。

[待确认：支持哪些文件类型？]
- 方案A：仅图片（jpg、png） - 适合作业提交
- 方案B：文档（pdf、docx） - 适合资料分享
- 方案C：任意文件（安全风险较高）

[待确认：文件大小限制？]
- 方案A：5MB（Web标准） - 适合图片
- 方案B：10MB - 适合PDF
- 方案C：100MB - 适合视频（需CDN支持）

[待确认：存储在哪里？]
- 方案A：本地服务器磁盘 - 简单，但不易扩展
- 方案B：阿里云OSS/腾讯云COS - 推荐，可靠
- 方案C：数据库BLOB字段 - 不推荐，性能差
```

**用户在 `/speckit.clarify` 阶段解决**：
```
用户：文件类型选方案A（仅图片），大小选方案A（5MB），存储选方案B（OSS）
```

AI更新规格：
```markdown
### 需求1：文件上传（已明确）

用户可上传图片文件（jpg、png格式），单个文件≤5MB，存储在阿里云OSS。
```

#### Phase Gates 关卡：自动质量检查

**定义**：在`/speckit.plan`生成时，AI必须检查宪法的关卡。

**plan-template.md 片段**：
```markdown
### 第0阶段：实现前检查

#### 简单性关卡（第七条）
- [ ] 使用≤3个Maven模块？
  - 如果否：在“复杂度跟踪”章节说明理由

#### 反过度抽象关卡（第八条）
- [ ] 直接使用框架？
  - 如果否：说明为什么需要包装

#### 测试先行关卡（第三条）
- [ ] 契约测试在实现之前？
  - 必须是tasks.md的第0阶段
```

**AI执行 `/speckit.plan` 时的流程**：

```
[AI] 读取宪法...
[AI] 第七条：最多3个Maven模块
[AI] 检查方案...
[AI] 发现：common、service、web、admin = 4个模块
[AI] ❌ 简单性关卡未通过
[AI] 写入plan.md：

### 第0阶段：实现前检查

#### 简单性关卡（第七条）
- [❌] 使用≤3个Maven模块？
  **状态**：未通过（4个模块）
  **理由**：admin模块需要单独的权限控制，不能和web模块混在一起
  **审批**：待用户确认

[等待用户审查...]

用户：去掉admin模块，初始版本不做后台管理

[AI] ✅ 更新plan.md，去掉admin模块，简单性关卡通过
```

### 4.3 Analyze 质量门：六种检测 + 四级严重性

#### /analyze 的六种检测类型

**1. 重复检测（Duplication）**

检测相似或重复的需求。

**示例**：
```markdown
spec.md：
需求1：学生可以上传作业图片
需求5：系统支持学生提交图片作业

/analyze 报告：
| D1 | 重复 | HIGH | 需求1 vs 需求5 | 两个需求描述相同功能 | 合并为需求1，删除需求5 |
```

**2. 歧义检测（Ambiguity）**

检测模糊形容词、无法测量的标准。

**示例**：
```markdown
spec.md：
非功能需求1：系统应该快速响应

/analyze 报告：
| A1 | 歧义 | HIGH | 非功能需求1 | “快速”无法测量 | 改为“API响应时间P95 < 200ms” |
```

**常见歧义词**：快、慢、好、稳定、安全、流畅、直观

**3. 规格不足（Underspecification）**

检测缺少对象或结果的需求。

**示例**：
```markdown
spec.md：
需求3：教师可以删除

/analyze 报告：
| U1 | 规格不足 | MEDIUM | 需求3 | 缺少对象：删除什么？ | 改为“教师可以删除自己发布的作业” |
```

**4. 宪法对齐（Constitution Alignment）**

检测违反宪法原则。

**示例**：
```markdown
constitution.md：
第三条：测试先行原则（不可妥协）

tasks.md：
阶段1：任务001 - 实现HomeworkService
阶段2：任务010 - 编写HomeworkService测试

/analyze 报告：
| C1 | 宪法违规 | CRITICAL | tasks.md 阶段1 | 违反第三条：实现在测试之前 | 调整顺序：任务010必须在任务001之前 |
```

**5. 覆盖度缺失（Coverage Gap）**

检测需求无对应任务，或任务无对应需求。

**示例**：
```markdown
spec.md：
非功能需求2：系统必须支持100个学生同时提交作业

tasks.md：
（未找到并发测试任务）

/analyze 报告：
| G1 | 覆盖度缺失 | CRITICAL | 非功能需求2 | 无任务覆盖并发测试 | 添加任务020：“JMeter压测100并发” |
```

**6. 一致性检查（Inconsistency）**

检测术语漂移、数据模型冲突。

**示例**：
```markdown
spec.md：
使用术语“作业状态”（未提交、已提交、已批改）

data-model.md：
字段名：homework_state（enum）

api-spec.yaml：
参数名：homeworkStatus（string）

/analyze 报告：
| I1 | 不一致 | MEDIUM | spec/plan/contracts | 术语漂移：“状态”vs“state”vs“Status” | 统一为“status”（数据库、API、文档） |
```

#### 四级严重性分级

| 级别       | 定义                                   | 典型问题                               | 如何处理                                   |
|------------|----------------------------------------|----------------------------------------|--------------------------------------------|
| **CRITICAL** | 违反宪法MUST条款，或核心功能零覆盖       | 测试先行未遵守、数据安全违规、主功能无任务 | **阻塞 `/speckit.implement`**，必须修复 |
| **HIGH**   | 重复/冲突需求，安全/性能需求模糊       | 两个需求描述同一功能、非功能需求无指标 | 强烈建议修复，继续有风险                   |
| **MEDIUM** | 术语漂移，非功能需求未覆盖             | status vs state不一致、文档与代码用词不同 | 建议修复，不影响功能                       |
| **LOW**    | 风格/措辞改进                          | 任务ID格式不一致（T1 vs T001）、注释不规范 | 可选改进，不影响质量                       |

#### /analyze 的典型输出结构

```markdown
# 规格分析报告

## 执行摘要
- 功能需求：6个
- 非功能需求：2个
- 任务总数：18个
- 覆盖率：100%（8/8需求有任务）
- **CRITICAL问题：1个**
- HIGH问题：2个
- MEDIUM问题：3个
- LOW问题：1个

## ❌ CRITICAL问题（必须修复）

| ID | 类别     | 严重性   | 位置           | 问题描述                     | 建议         |
|----|----------|----------|----------------|------------------------------|--------------|
| C1 | 宪法违规 | CRITICAL | tasks.md 第2阶段 | 违反第三条：任务006实现在任务003测试之前 | 调整依赖顺序 |

## ⚠️ HIGH问题（强烈建议）

| ID | 类别   | 严重性 | 位置         | 问题描述                 | 建议       |
|----|--------|--------|--------------|--------------------------|------------|
| H1 | 重复   | HIGH   | 需求2 vs 需求7 | 都描述“学生提交作业”     | 合并为需求2 |
| H2 | 歧义   | HIGH   | 非功能需求1 | “系统应该安全”无标准     | 具体化：“通过等保三级认证” |

## 📊 覆盖度详情

| 需求             | 有任务? | 任务ID           | 备注       |
|------------------|---------|------------------|------------|
| 需求1：作业发布   | ✅      | 任务006、任务009 | 完整覆盖   |
| 需求2：学生提交   | ✅      | 任务007、任务010 | 完整覆盖   |
| ...              |         |                  |            |
| 非功能需求2：并发性能 | ❌      | 无               | **缺失** - 见G1 |

## 🚨 宪法对齐问题

### 第三条违规（CRITICAL）
- ❌ 任务006“实现Service”在任务003“测试”之前
- ✅ 其他任务遵守TDD顺序

## 📈 统计指标
- 需求覆盖率：88%（7/8）
- 任务映射率：94%（17/18）
- 歧义计数：1
- CRITICAL问题：1

## ⚙️ 下一步行动

### ❌ 阻塞：不能执行/implement
**原因**：1个CRITICAL问题

### 必须修复：
1. **C1**：调整tasks.md任务依赖
2. **G1**：添加并发测试任务

### 修复后：
重新运行`/speckit.analyze`确认CRITICAL=0，然后执行`/speckit.implement`。
```

---

## 五、常见问题与解答

### Q1: AI生成的代码偏离了需求，如何更新规格？

**场景**：运行`/speckit.implement`后发现AI生成的批改页面没有“批量批改”功能，现在想加。

**❌ 错误做法**：
```
直接告诉AI：“加一个批量批改按钮”
→ AI加了，但spec.md/plan.md没更新
→ 下次重新生成时又消失了
```

**✅ 正确做法**：

**步骤1：判断变更层级**

“批量批改”是新功能需求 → 影响`/speckit.specify`层级

**步骤2：回退到 `/speckit.specify`，更新spec.md**

```markdown
### 需求8：批量批改（新增）

教师可一次批改多个学生的作业，提升效率。

**功能细节**：
- 作业列表页，教师可勾选多个“已提交”状态的作业
- 点击“批量批改”按钮，进入批量模式
- 逐个显示作业，教师快速给分和评语
- 支持键盘快捷键：Enter跳下一个，Ctrl+S保存

**验收标准**：
- 张老师勾选5个作业，进入批量模式
- 逐个批改，每个耗时10秒
- 5个作业批改完成，状态全部变为“已批改”
```

**步骤3：重新执行后续流程**

```bash
/clarify  # AI可能问：批量时能跳过某个作业吗？
/plan     # AI更新BatchReviewService
/tasks    # AI自动插入新任务
/analyze  # 检查一致性
/implement  # 生成批量批改功能
```

**关键原则**：

| 变更类型     | 回退到         | 示例             |
|--------------|----------------|------------------|
| UI样式       | `/speckit.implement` | 按钮颜色改蓝色   |
| 添加字段     | `/speckit.plan`    | 作业表加difficulty字段 |
| 新增功能     | `/speckit.specify` | 添加批量批改     |
| 改核心逻辑   | `/speckit.specify` | 批改改用AI自动评分 |
| 架构变更     | `/speckit.constitution` | 改为微服务架构   |

### Q2: /analyze 发现 CRITICAL 问题怎么办？

**场景**：运行`/speckit.analyze`看到：

```markdown
## CRITICAL问题

| C1 | 宪法违规 | CRITICAL | tasks.md | 第三条违规：任务010实现在任务009测试之前 |
```

**处理流程**：

**步骤1：理解 CRITICAL 含义**

CRITICAL = **阻塞 `/speckit.implement` 的问题**，必须修复，否则：
- 违反项目宪法（不可妥协原则）
- 或导致核心功能无法实现

**步骤2：评估影响范围**

```
任务009 - 编写HomeworkService单元测试
任务010 - 实现HomeworkService  ← 顺序错误
```

影响：如果先实现再测试，违反TDD原则 → 宪法第三条

**步骤3：修复 tasks.md**

**修复前**：
```markdown
阶段1：业务层
- 任务009 [可并行] - 编写HomeworkService测试
- 任务010 [可并行] - 实现HomeworkService  ← 错误！
```

**修复后**：
```markdown
阶段1：业务层
- 任务009 [可并行] - 编写HomeworkService测试
- 任务010 [依赖：任务009] - 实现HomeworkService  ← 添加依赖
```

**步骤4：重新运行 `/speckit.analyze`**

```bash
/analyze
```

```markdown
## 执行摘要
- **CRITICAL问题：0** ✅
- HIGH问题：2

✅ 准备就绪：可执行`/speckit.implement`
```

**关键**：
- ❌ 不要跳过CRITICAL直接实现
- ✅ 修复后必须重新`/speckit.analyze`确认
- ✅ 宪法违规永远是CRITICAL，无妥协

### Q3: 需求频繁变更，如何快速响应？

**场景**：产品经理每周改需求，传统开发很痛苦。

**SDD解决方案：规格是单一真相源**

**传统开发痛点**：
```
需求变更 → 更新PRD → 通知开发 → 手动改代码 → 重新测试 → 更新文档（常忘）
              ↓          ↓           ↓
           永远过时   漏改一处   文档与代码不符
```

**SDD方式**：
```
需求变更 → 更新spec.md → /plan → /tasks → /analyze → /implement
           （单一真相源）                               ↓
                                                 自动重新生成代码
```

**实战示例：智慧课堂需求变更**

**第1周**：初始需求
```
/specify 作业截止时间为固定时间点
```

**第2周**：产品说要支持延期
```
# 编辑 spec.md
### 需求9: 截止时间延期(新增)

教师可以延长作业截止时间。

# 重新执行
/plan    # AI自动更新HomeworkService.extendDeadline()
/tasks   # AI自动添加任务: "实现延期功能"
/analyze
/implement  # 只重新生成HomeworkService,其他不变
```

**耗时**: 8分钟

**第3周**: 产品又说要支持针对单个学生延期
```
# 编辑 spec.md

### 需求9: 截止时间延期(更新)

教师可以延长作业截止时间:
- 全班延期: 所有学生的截止时间统一延长
- 单个学生延期: 为特定学生(如请假)单独延长

# 重新执行
/plan    # AI添加student_id参数
/tasks   # AI添加任务: "支持学生级延期"
/analyze
/implement
```

**耗时**: 10分钟

**关键优势**:
1. **单一真相源**: spec.md永远最新,代码从规格生成
2. **增量更新**: `/speckit.implement`只重新生成受影响的部分
3. **自动一致性**: `/speckit.analyze`确保规格+方案+任务+代码一致
4. **版本控制**: spec.md用Git跟踪,变更历史清晰

**对比耗时**:

| 任务 | 传统开发 | SDD方式 | 加速比 |
|------|---------|---------|-------|
| 添加延期功能 | 2小时 | 8分钟 | 15x |
| 支持学生级延期 | 3小时 | 10分钟 | 18x |
| 确保文档同步 | 1小时(常忘) | 0分钟(自动) | ∞ |

### Q4: 如何确保测试先行(Test-First)?

**场景**: 希望团队严格遵守TDD,但总有人先写代码。

**SDD解决方案: 宪法 + /analyze双重保障**

**机制1: 宪法强制**

```markdown
# constitution.md

## 第三条: 测试先行原则(不可妥协)

禁止在以下步骤完成前编写实现代码:
1. 契约测试已编写
2. 测试已通过评审
3. 测试已运行并确认失败(TDD红灯)

违规后果:
- /analyze报CRITICAL错误
- /implement拒绝生成代码
```

**机制2: tasks.md强制顺序**

```markdown
## 第0阶段: 契约和测试(永远最先)

#### 任务001 - 定义API契约
- 创建OpenAPI规范
- **交付物**: api-spec.yaml

#### 任务002 [依赖: 任务001] - 编写契约测试
- 测试所有端点
- **交付物**: 所有测试失败(红灯) ← 明确要求失败

#### 任务003 [依赖: 任务002] - 用户审查检查点
- 用户审查测试质量
- **交付物**: 用户明确批准

## 第1阶段: 实现(测试通过关卡后)

#### 任务004 [依赖: 任务003] - 实现API
- 让任务002的测试通过
- **交付物**: 所有测试变绿
```

**机制3: /implement执行逻辑**

```
AI内部逻辑:

def implement_task(task_id):
    if task_id == "任务004":  # 实现任务
        # 检查依赖
        if not is_completed("任务003"):
            raise Error("不能实现: 任务003(测试审查)未完成")

        # 检查测试状态
        test_results = run_tests("任务002")
        if test_results.status != "FAILED":
            raise Error("不能实现: 测试必须先失败(TDD红灯)")

        # 生成实现代码
        generate_implementation()

        # 验证测试变绿
        test_results = run_tests("任务002")
        if test_results.status != "PASSED":
            raise Error("实现不完整: 测试仍失败")

        return "✅ 任务004完成: 测试现在通过"
```

**实际执行流程**:

```bash
/implement

[任务001] 定义API契约...
✅ 创建api-spec.yaml

[任务002] 编写契约测试...
```java
@Test
void testPublishHomework_成功() {
    // 调用API
    Result<Long> result = client.post("/api/homework", dto);
    // 断言
    assertEquals(200, result.getCode());
}
```
运行测试...
❌ 10/10测试失败(预期 - TDD红灯)

[任务003] 等待用户审查...

用户: "测试写得很全面,批准"

[任务004] 实现API...
```java
@RestController
public class HomeworkController {
    @PostMapping("/api/homework")
    public Result<Long> publishHomework(@RequestBody HomeworkDTO dto) {
        Long id = homeworkService.publish(dto);
        return Result.success(id);
    }
}
```

运行测试...
✅ 10/10测试通过(TDD绿灯)
```

**如果有人试图跳过测试**:

```bash
/implement

[检查前置条件...]
❌ 错误: 宪法第三条违规

tasks.md显示:
- 任务010 [可并行] - 实现HomeworkService  ← 无测试依赖!

要求的结构:
- 任务009 - 编写HomeworkService测试
- 任务010 [依赖: 任务009] - 实现HomeworkService

必须: 修复tasks.md强制TDD顺序

运行 /analyze 查找所有违规。
```

---

## 六、最佳实践

### 1. 规格应该写到什么粒度?

**判断标准**:
- ✅ 可测试(testable)
- ✅ 无歧义(unambiguous)
- ❌ 不写实现(no HOW)

**粒度对比**:

| 粒度 | ❌ 太粗(不可测) | ✅ 恰当(可测试) | ❌ 太细(实现细节) |
|------|----------------|----------------|------------------|
| **功能需求** | "系统要快" | "API响应P95 < 200ms" | "用Redis缓存查询结果" |
| **用户操作** | "学生可提交作业" | "学生可上传jpg/png,≤5MB" | "前端用axios POST到/api/submission" |
| **错误处理** | "系统要健壮" | "网络超时30秒后提示重试" | "使用axios的timeout配置30000ms" |

**实战案例: 文件上传功能**

**❌ 太粗**:
```markdown
需求1: 学生可以上传文件
```
问题: 什么文件?多大?存哪?无法写测试。

**✅ 恰当**:
```markdown
需求1: 学生可上传作业图片

**功能细节**:
- 支持格式: jpg、png
- 文件大小: 单张≤5MB,最多9张
- 上传时限: 10秒内完成(正常网络)
- 成功后返回OSS地址

**验收标准**:
- 上传1张3MB的jpg图片 → 返回URL
- 上传6MB的图片 → 提示"文件过大"
- 上传.docx文件 → 提示"格式不支持"
```
可以写自动化测试了!

**❌ 太细**:
```markdown
需求1: 学生通过multipart/form-data POST到/api/file/upload上传图片

**实现细节**:
- 后端用MultipartFile接收
- 调用OSSUtil.upload()上传到阿里云
- 返回JSON: {"code":200,"data":"https://..."}
```
问题: 这是`/speckit.plan`的内容,不属于规格。

**判断方法**:

1. **能写测试吗?** 如果不能,太粗。
2. **有多种实现吗?** 如果只有一种,太细。
3. **换技术栈成立吗?** 如果不成立,太细。

### 2. 何时必须使用/clarify?

**必须使用**:
- ✅ spec.md有`[待确认]`标记
- ✅ AI生成的规格明显遗漏关键决策
- ✅ 在`/speckit.plan`之前强制执行

**不需要使用**:
- ❌ 规格已足够清晰(零`[待确认]`)
- ❌ 只是改改措辞(直接编辑spec.md)

**实战示例**:

```bash
# 步骤1: /specify生成规格
/specify 开发搜索功能,支持按关键词查找作业

# AI生成的规格包含:
[待确认: 搜索算法 - 精确匹配还是模糊搜索?]
[待确认: 搜索范围 - 只搜标题还是包括内容?]

# 步骤2: 必须运行/clarify
/clarify

AI: 发现2个待确认点。

问题1: 搜索算法
方案A: 精确匹配(LIKE '关键词') - 简单,但不友好
方案B: 模糊搜索(LIKE '%关键词%') - 推荐
方案C: 全文搜索(MySQL FULLTEXT或ES) - 复杂

用户选择: 方案B

AI: ✅ 更新规格 → "使用SQL模糊匹配(LIKE %keyword%)"

问题2: 搜索范围
方案A: 仅搜索标题 - 快
方案B: 标题+内容 - 推荐,体验好

用户选择: 方案B

AI: ✅ 更新规格 → "搜索字段: title、content"

所有待确认点已解决。可以执行 /plan。
```

### 3. /analyze的最佳使用时机

**强制运行**:
1. **After `/speckit.tasks`, before `/speckit.implement`**(最重要!)
2. **需求变更后** - 更新spec.md后运行
3. **Code review前** - 确保规格与代码一致

**可选运行**:
- After `/speckit.plan`: 检查方案是否覆盖所有需求
- 每周定期: 检查规格漂移

**实战案例1: 发现隐藏的覆盖度缺失**

```bash
# 你以为任务全覆盖了
/tasks

# 运行analyze
/analyze

报告:
| G1 | 覆盖度缺失 | CRITICAL | 非功能需求2 | "数据安全:敏感信息加密"无对应任务 |

# 你意识到: 哦对,加密忘了!
# 添加任务
任务025 - 实现AES-256加密工具类EncryptUtil

# 重新analyze
/analyze
✅ 覆盖率: 100%
```

**实战案例2: 早期发现术语不一致**

```bash
/analyze

报告:
| I1 | 不一致 | MEDIUM | spec vs plan | spec用"作业",plan用"homework" |

# 早期发现,容易修复
# 如果等到代码写完,改动范围巨大(表名、API、变量名...)
```

### 4. 何时使用 /checklist

**定位**: 领域特定的深度质量检查，验证规格在特定领域的完整性。

**典型使用场景**:
```bash
# 高风险领域：支付/安全/合规
/plan → /checklist 支付安全 → /tasks → /analyze → /implement

# 特定领域：UX/性能/API
/specify → /checklist ux → /clarify → /plan
```

**与 /analyze 的关系**:
- `/analyze` - 必须运行，通用质量检测（重复、歧义、覆盖度等）
- `/checklist` - 可选运行，领域专家视角检查（如"幂等性要求是否明确？"）
- 配合使用：先 `/checklist` 做深度检查，再 `/analyze` 做通用验证

**使用决策**: 高风险/关键领域（支付、安全、合规）→ 必须用；普通功能 → 不需要

### 5. 如何制定好的宪法(Constitution)

**原则1: 不超过10条**

太多原则=没有原则。

**原则2: 每条都可自动检测**

如果`/speckit.analyze`检测不了,不是好原则。

**❌ 不可检测**:
```markdown
第五条: 代码应该优雅且易维护
```
问题: "优雅"和"易维护"无法量化。

**✅ 可检测**:
```markdown
第五条: 代码复杂度限制

所有方法必须:
- 圈复杂度 ≤ 10
- 最大嵌套层级 ≤ 3
- 方法长度 ≤ 50行

检测方式: /analyze阶段运行代码复杂度检查工具。
```

**原则3: 违规后果明确**

每条原则标注违规严重性。

**宪法模板**:

```markdown
## 第[N]条: [原则名称]

### 规则
[具体的、可测量的要求]

### 理由
[为什么有这个原则]

### 违规处理
- 严重性: CRITICAL / HIGH / MEDIUM
- 检测方式: /analyze如何检测
- 后果: 阻塞/警告/记录

### 例外情况
[什么情况可违反,需要什么审批]
```

**示例: 金融系统宪法**

```markdown
## 第一条: 金额精度原则

### 规则
所有金额计算必须:
1. 使用BigDecimal类型,禁止float/double
2. 四舍五入到分(setScale(2, RoundingMode.HALF_UP))
3. 单元测试覆盖边界值(0.01、-0.01、Long.MAX_VALUE)

### 理由
float/double存在精度丢失,可能导致资金差额,引发对账问题。

### 违规处理
- 严重性: CRITICAL
- 检测方式: /analyze扫描代码中的float/double字段
- 后果: 阻塞上线,必须修复

### 例外情况
无例外。金额精度不可妥协。
```

---

## 七、总结: SDD的核心价值

### 传统开发 vs SDD对比

| 维度 | 传统开发 | SDD方式 | 提升 |
|------|---------|---------|------|
| **真相源** | 代码(文档过时) | 规格文档 | 单一真相 |
| **需求变更** | 手工改代码+文档 | 更新规格重新生成 | 20-30x加速 |
| **质量保证** | 人工Code Review | 宪法+/analyze自动检测 | 自动化 |
| **测试先行** | 依赖自觉 | 强制TDD流程 | 100%遵守 |
| **一致性** | 经常不一致 | /analyze强制检测 | 0不一致 |
| **新人上手** | 需数月 | 遵循模板即可 | 周级上手 |

### SDD适合的项目

✅ **理想场景**:
- 新项目(从零开始)
- 需求频繁变更
- 团队3-20人
- 质量要求高(金融、医疗、教育)
- 需要快速试错

⚠️ **需要调整**:
- 遗留系统改造 - 需先"规格化"现有代码
- 超大型项目(>50人) - 需分层宪法

❌ **不适合**:
- 一次性脚本
- 纯前端UI调试

### 开始你的SDD之旅

**第1步: 安装Spec-Kit**

```bash
# 使用uv安装(推荐)
uv tool install specify-cli --from git+https://github.com/github/spec-kit.git

# 或使用uvx临时运行
uvx --from git+https://github.com/github/spec-kit.git specify init 我的项目
```

**第2步: 初始化项目**

```bash
specify init 智慧课堂 --ai claude
# 选择: 使用Claude Code作为AI助手
```

**第3步: 建立宪法**

```bash
/constitution Создание принципов, ориентированных на качество кода, стандарты тестирования и соответствие требованиям в сфере образования
```

**Шаг 4: Разработка первой функции**

```bash
/specify Разработка функции отправки домашних заданий студентами с поддержкой загрузки изображений и PDF
/clarify
/plan Использование Spring Boot + MyBatis-Plus + MySQL + Alibaba Cloud OSS
/tasks
/analyze  # Ключевой шаг!
/implement
```

**Шаг 5: Присоединяйтесь к сообществу**

- GitHub: https://github.com/github/spec-kit
- Отправляйте Issue, чтобы поделиться своим опытом
- Участвуйте в обсуждении улучшений методологии SDD

---

## Запомните четыре ядра SDD

1. **Спецификация — это истина, код — это выражение**
   - Поддержка ПО = эволюция спецификаций
   - Отладка = исправление логики спецификаций
   - Рефакторинг = реструктуризация спецификаций

2. **Конституция — это гены, не подлежит компромиссу**
   - Определение ≤10 основных принципов
   - Каждый принцип подлежит автоматической проверке
   - Нарушение = CRITICAL, блокирует реализацию

3. **/analyze — это контрольная точка качества, CRITICAL обязателен**
   - 6 видов проверок: Повторение, Неоднозначность, Полнота покрытия, Конституция, Согласованность, Терминология
   - 4 уровня серьезности: CRITICAL блокирует, HIGH — рекомендация, MEDIUM — улучшение, LOW — опционально
   - Обязательно выполняется между /tasks и /implement

4. **SDD — это не линейный, а рекурсивный цикл**
   - На уровне проекта/функции/модуля/задачи
   - Каждый уровень может выполнять полный цикл SDD
   - Обнаружение проблем — возврат на подходящий уровень, а не полное переделывание

---

**Начните разрабатывать свой следующий проект с помощью SDD!** 🚀

> Данное руководство основано на проекте Spec-Kit, написано для китайских разработчиков.
> Последнее обновление: Январь 2025 г.
> Добро пожаловать с отзывами: https://github.com/github/spec-kit/issues