#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /plan

set -e

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

# –†–∞–∑–±–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
STORY_NAME=""
if [ $# -gt 0 ]; then
    STORY_NAME="$1"
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT=$(get_project_root)
cd "$PROJECT_ROOT"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏—Å—Ç–æ—Ä–∏–∏
if [ -z "$STORY_NAME" ]; then
    STORY_NAME=$(get_active_story)
fi

STORY_DIR="stories/$STORY_NAME"
SPEC_FILE="$STORY_DIR/specification.md"
CLARIFY_FILE="$STORY_DIR/clarification.md"
PLAN_FILE="$STORY_DIR/creative-plan.md"

echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞"
echo "============"
echo "–ò—Å—Ç–æ—Ä–∏—è: $STORY_NAME"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
missing=()

if [ ! -f "memory/writing-constitution.md" ] && [ ! -f ".specify/memory/writing-constitution.md" ]; then
    missing+=("–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞")
fi

if [ ! -f "$SPEC_FILE" ]; then
    missing+=("–§–∞–π–ª —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏")
fi

if [ ${#missing[@]} -gt 0 ]; then
    echo "‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:"
    for doc in "${missing[@]}"; do
        echo "  - $doc"
    done
    echo ""
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    if [ ! -f "memory/writing-constitution.md" ] && [ ! -f ".specify/memory/writing-constitution.md" ]; then
        echo "  1. /constitution - –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—é —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞"
    fi
    if [ ! -f "$SPEC_FILE" ]; then
        echo "  2. /specify - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –∏—Å—Ç–æ—Ä–∏–∏"
    fi
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—É–Ω–∫—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è
if [ -f "$SPEC_FILE" ]; then
    unclear_count=$(grep -o '\[ÈúÄË¶ÅÊæÑÊ∏Ö\]' "$SPEC_FILE" | wc -l | tr -d ' ')

    if [ "$unclear_count" -gt 0 ]; then
        echo "‚ö†Ô∏è –í —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –µ—Å—Ç—å $unclear_count –ø—É–Ω–∫—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è"
        echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å /clarify –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π"
        echo ""
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π –æ–± —É—Ç–æ—á–Ω–µ–Ω–∏–∏
if [ -f "$CLARIFY_FILE" ]; then
    echo "‚úÖ –ó–∞–ø–∏—Å–∏ –æ–± —É—Ç–æ—á–Ω–µ–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω—ã, –ø–ª–∞–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ç–æ—á–Ω–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π"
else
    echo "üìù –ó–∞–ø–∏—Å–∏ –æ–± —É—Ç–æ—á–Ω–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–ª–∞–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ö–æ–¥–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –ø–ª–∞–Ω–∞
if [ -f "$PLAN_FILE" ]; then
    echo ""
    echo "üìã –§–∞–π–ª –ø–ª–∞–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω"

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
    if grep -q "ÁâàÊú¨Ôºö" "$PLAN_FILE"; then
        version=$(grep "ÁâàÊú¨Ôºö" "$PLAN_FILE" | head -1 | sed 's/.*ÁâàÊú¨Ôºö//')
        echo "  –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $version"
    fi
else
    echo ""
    echo "üìù –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–ª–∞–Ω —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞"
fi

echo ""
echo "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ø–ª–∞–Ω–∞: $PLAN_FILE"
echo ""
echo "–ì–æ—Ç–æ–≤–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –ø–ª–∞–Ω–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞"