# Руководство по разработке команд Gemini

В этом руководстве описано, как разрабатывать кроссплатформенные команды с использованием слешей (Claude, Gemini, Cursor, Windsurf, Roo Code) для проекта novel-writer.

## Обзор архитектуры (v0.15.0+)

Novel Writer использует архитектуру **единого источника + система сборки**:

```
templates/
└── commands/                  # Единый исходный файл (формат Markdown)
    ├── analyze.md
    ├── specify.md
    └── ...

scripts/build/
└── generate-commands.sh       # Скрипт сборки (автоматически генерирует команды для всех платформ)

dist/                          # Результаты сборки (публикуются в npm)
├── claude/.claude/commands/   # С префиксом novel.*
│   ├── novel.analyze.md
│   └── novel.specify.md
├── gemini/.gemini/commands/novel/  # Подкаталог novel/
│   ├── analyze.toml
│   └── specify.toml
├── cursor/.cursor/commands/   # Стандартное именование
├── windsurf/.windsurf/workflows/
└── roocode/.roocode/commands/
```

### Основные принципы

1. **Единый источник**: Обслуживайте только файлы Markdown в `templates/commands/`.
2. **Генерация сборкой**: Запустите `npm run build:commands` для автоматической генерации команд для всех платформ.
3. **Пространство имён**: Автоматически добавляйте префикс пространства имён (Claude: `novel.*`, Gemini: `novel/`).
4. **Сборка при публикации**: Автоматическая сборка при `npm publish`, пользователи получают результаты сборки.

## Разработка новых команд

### Шаг 1: Создание исходного файла (единственный шаг, требующий ручного вмешательства)

Создайте файл Markdown в каталоге `templates/commands/`:

```markdown
---
description: Краткое описание команды
argument-hint: [Подсказка по аргументам]
allowed-tools: Read(//stories/**), Write(//stories/**), Bash(*)
model: claude-sonnet-4-5-20250929
scripts:
  sh: .specify/scripts/bash/example.sh
  ps: .specify/scripts/powershell/example.ps1
---

Ввод пользователя: $ARGUMENTS

# Название команды

Подробное описание команды...

## Руководство по выполнению ИИ

Подробные шаги выполнения...
```

### Шаг 2: Сборка всех версий для платформ (автоматически)

```bash
npm run build:commands
```

Эта команда автоматически:
1. Читает все команды из `templates/commands/`.
2. Генерирует формат `novel.*.md` для Claude (с префиксом пространства имён).
3. Преобразует для Gemini в формат TOML и помещает в подкаталог `novel/`.
4. Генерирует стандартный формат для других платформ.
5. Выводит результаты в каталог `dist/`.

## Подробности системы сборки

### Правила автоматического преобразования

Скрипт сборки `scripts/build/generate-commands.sh` автоматически обрабатывает:

#### 1. Добавление пространства имён
- **Claude**: `analyze.md` → `novel.analyze.md`
- **Gemini**: `analyze.md` → `novel/analyze.toml` (подкаталог)
- **Другие платформы**: `analyze.md` (без пространства имён)

#### 2. Преобразование формата (Markdown → TOML)
```markdown
---
description: Анализ качества написания
---

Ввод пользователя: $ARGUMENTS
Содержимое...
```

Автоматически преобразуется в:
```toml
description = "Анализ качества написания"

prompt = """
Ввод пользователя: {{args}}
Содержимое...
"""
```

#### 3. Замена переменных
- `$ARGUMENTS` → `{{args}}` (формат Gemini)
- Пути к скриптам автоматически копируются в `.specify/scripts/`

### Команды сборки

```bash
# Сборка для всех платформ
npm run build:commands

# Ручная сборка (для разработки)
bash scripts/build/generate-commands.sh \
  --agents=claude,gemini,cursor,windsurf,roocode \
  --scripts=sh

# Сборка только для определённых платформ
bash scripts/build/generate-commands.sh --agents=claude,gemini
```

## Спецификация формата TOML (автоматическая генерация)

Система сборки автоматически обрабатывает следующие преобразования, **создавать файлы TOML вручную не нужно**:

### Заполнители переменных
- Markdown: `$ARGUMENTS` → TOML: `{{args}}`

### Вызовы инструментов
Имена инструментов, используемых Gemini (см.):
- `read_file` - чтение файла
- `write_file` - создание файла
- `edit_file` - редактирование файла
- `run_shell_command` - выполнение команды
- `glob_files` - поиск файлов

## Пример разработки

### Шаг 1: Создание исходного файла

Создайте файл `templates/commands/example.md`:

```markdown
---
description: Пример команды - демонстрация процесса разработки команды
argument-hint: [Описание необязательных аргументов]
allowed-tools: Read(//**), Write(//stories/**), Bash(*)
model: claude-sonnet-4-5-20250929
scripts:
  sh: .specify/scripts/bash/example.sh
---

Ввод пользователя: $ARGUMENTS

# Пример команды

Это описание команды-примера.

## Руководство по выполнению ИИ

Когда пользователь вводит `/example`:

1. Прочитать файл конфигурации
2. Выполнить соответствующее действие
3. Сгенерировать отчёт о результатах
```

### Шаг 2: Запуск сборки

```bash
npm run build:commands
```

### Шаг 3: Проверка результатов сборки

После сборки автоматически генерируются:

**Версия Claude** (`dist/claude/.claude/commands/novel.example.md`):
```markdown
---
description: Пример команды - демонстрация процесса разработки команды
argument-hint: [Описание необязательных аргументов]
allowed-tools: Read(//**), Write(//stories/**), Bash(*)
model: claude-sonnet-4-5-20250929
---

Ввод пользователя: $ARGUMENTS
...
```

**Версия Gemini** (`dist/gemini/.gemini/commands/novel/example.toml`):
```toml
description = "Пример команды - демонстрация процесса разработки команды"

prompt = """
Ввод пользователя: {{args}}

# Пример команды

Это описание команды-примера.

## Руководство по выполнению ИИ

Когда пользователь вводит `/example`:

1. Прочитать файл конфигурации
2. Выполнить соответствующее действие
3. Сгенерировать отчёт о результатах
"""
```

## Поддержка команд плагинов

Плагины теперь также используют архитектуру единого источника, CLI автоматически обрабатывает сборку.

Структура каталога плагина (v0.15.0+):
```
plugins/example-plugin/
├── commands-claude/       # Единый источник (Markdown)
│   └── plugin-cmd.md
├── dist/                  # Результаты сборки (автоматически генерируются)
│   ├── claude/
│   ├── gemini/
│   └── ...
└── config.yaml
```

## Тестирование команд

### 1. Тестирование сборки
```bash
# Очистка старых сборок
rm -rf dist/

# Сборка для всех платформ
npm run build:commands

# Проверка результатов сборки
ls dist/claude/.claude/commands/novel.*
ls dist/gemini/.gemini/commands/novel/
```

### 2. Тестирование инициализации
```bash
# Тестирование установки Claude
novel init test-project --ai claude
ls test-project/.claude/commands/novel.*

# Тестирование установки Gemini
novel init test-project-gemini --ai gemini
ls test-project-gemini/.gemini/commands/novel/

# Тестирование всех платформ
novel init test-all --all
```

### 3. Тестирование обновления
```bash
# Тестирование обновления в существующем проекте
cd existing-project
novel upgrade
ls .claude/commands/novel.*
```

## Лучшие практики

### Процесс разработки
1. **Обслуживание единого источника**: Редактируйте только файлы Markdown в `templates/commands/`.
2. **Своевременная сборка**: Сразу после внесения изменений запускайте `npm run build:commands` для проверки.
3. **Покрытие тестами**: Тестируйте как минимум на двух платформах: Claude и Gemini.
4. **Согласованность именования**: Используйте строчные буквы и дефисы в именах файлов (например, `plot-check.md`).
5. **Синхронизация документации**: При обновлении команд синхронно обновляйте README.md.

### Качество кода
1. **Чёткое описание**: Поле `description` должно быть кратким и ясным (менее 50 символов).
2. **Подсказки по аргументам**: Используйте `argument-hint` для предоставления примеров аргументов (только Claude).
3. **Минимизация привилегий**: `allowed-tools` должны предоставлять только необходимые разрешения (только Claude).
4. **Соответствие модели**: Выбирайте подходящую `model` в зависимости от сложности задачи (только Claude).
5. **Пути к скриптам**: Убедитесь, что `scripts.sh` и `scripts.ps` указаны правильно.
6. **Совместимость с Gemini**: Помните, что Gemini поддерживает только `description` и `prompt`.

### Принципы пространства имён
1. **Избегание конфликтов**: Пространство имён гарантирует отсутствие конфликтов с другими инструментами (например, spec-kit).
2. **Прозрачность для пользователя**: Пользователи по-прежнему используют `/specify`, а не `/novel.specify`.
3. **Организация файлов**:
   - Claude: Используйте префикс `novel.*`.
   - Gemini: Используйте подкаталог `novel/`.
   - Другие платформы: Стандартное именование (без пространства имён).

## Обслуживание системы сборки

### Изменение скриптов сборки

Для изменения логики сборки отредактируйте `scripts/build/generate-commands.sh`:

```bash
# Ключевые функции
generate_commands() {
  local agent=$1      # claude, gemini, etc.
  local format=$2     # md, toml
  local args_var=$3   # $ARGUMENTS or {{args}}
  local output_dir=$4
  local script=$5
  local namespace=$6  # novel (для claude) или пустой
}
```

### Добавление новой платформы

1. Добавьте конфигурацию платформы в `generate-commands.sh`.
2. Реализуйте логику преобразования формата (при необходимости).
3. Обновите скрипт `build:commands` в `package.json`.
4. Протестируйте сборку и процесс установки.

## Устранение неполадок

### Сбой сборки
```bash
# Проверка синтаксиса исходного файла
head -20 templates/commands/problematic.md

# Ручной запуск сборки для просмотра подробных ошибок
bash -x scripts/build/generate-commands.sh --agents=claude
```

### Команда не работает
```bash
# Проверка наличия результатов сборки
ls dist/claude/.claude/commands/

# Проверка включения результатов сборки в npm pack
npm pack --dry-run | grep dist/

# Проверка файлов после установки
npm list -g novel-writer-cn
ls ~/.npm-global/lib/node_modules/novel-writer-cn/dist/
```

### Проблемы с пространством имён
```bash
# Файлы Claude должны иметь префикс novel.*
ls .claude/commands/ | grep ^novel\\.

# Файлы Gemini должны находиться в подкаталоге novel/
ls .gemini/commands/novel/
```

## Совместимость версий

### v0.15.0+ (текущая)
- ✅ Единый источник + система сборки
- ✅ Поддержка пространства имён
- ✅ Автоматическое преобразование формата

### v0.12.2-v0.14.x (старая версия)
- ⚠️ Режим двойного источника (commands-claude/ + commands-gemini/)
- ⚠️ Ручное обслуживание нескольких форматов
- ⚠️ Отсутствие пространства имён

### Рекомендации по миграции
Обновление старых проектов до v0.15.0+:
```bash
novel upgrade  # Автоматическая миграция к новой архитектуре
```

---
Дата обновления: 2025-10-11
Версия: 2.0.0 (архитектура v0.15.0+)