description = "Написание глав, автоматическое применение стиля и голоса персонажа"

prompt = """
Написание глав, интеллектуальное применение стиля и голоса персонажа.

Требования пользователя: {{args}}

## Шаги выполнения

### 1. Подготовка
Используйте run_shell_command для инициализации: .specify/scripts/bash/write-chapter.sh

Чтение соответствующих файлов:
- Используйте glob_files для поиска "stories/**/outline.md" - План глав
- spec/knowledge/character-voices.md - Голоса персонажей
- spec/knowledge/world-setting.md - Мироустройство
- .specify/memory/writing-constitution.md - Стиль письма
- memory/personal-voice.md - Отпечаток личного голоса
- spec/knowledge/natural-expression.md - Руководство по естественному выражению
- spec/presets/anti-ai-detection.md - Стратегии по обнаружению против ИИ

### 2. Определение главы
Определите главу для написания:
- Получите номер главы из параметров
- Определите её положение в общей структуре
- Подтвердите соответствующий узел метода

### 3. Применение элементов письма

**Согласованность стиля**
- Поддерживайте заданную точку зрения повествования
- Используйте установленный языковой стиль
- Сохраняйте темп и атмосферу

**Голос персонажа**
- Каждый персонаж сохраняет уникальный способ речи
- Отражайте черты характера
- Соответствуйте его статусу и происхождению

**Развитие сюжета**
- Продолжайте содержание предыдущей главы
- Выполните задачу текущей главы
- Подготовьте почву для следующей главы

### 4. Стратегия интеллектуального разделения на части

**Важные примечания**
Из-за ограничений Gemini на один вывод (около 2500-3000 слов), длинные главы требуют многократной генерации.

**Стандартный режим из трех частей** (около 7500 слов)
Подходит для: переходных глав, описания повседневности
- Начало: Начальная установка (2500 слов)
- Развитие: Развитие сюжета (2500 слов)
- Завершение: Завершение перехода (2500 слов)

**Рекомендуемый режим из четырех частей** (9000-9500 слов)
Подходит для: важных сюжетных линий, кульминационных глав, использующих классическую структуру "начало-развитие-поворот-завершение"

1. **С преобладанием диалогов** (2:2.5:3:2 тыс. слов)
   - Начало: Установка сцены (2000 слов)
   - Развитие: Развитие диалога (2500 слов)
   - Поворот: Нарастание конфликта (3000 слов) [Кульминация]
   - Завершение: Завершение влияния (2000 слов)

2. **С преобладанием экшена** (2:2:3:2.5 тыс. слов)
   - Начало: Приближение кризиса (2000 слов)
   - Развитие: Начальное столкновение (2000 слов)
   - Поворот: Пик битвы (3000 слов) [Самая захватывающая часть]
   - Завершение: Определение исхода (2500 слов)

3. **С преобладанием эмоционального развития** (2.5:2.5:2.5:2 тыс. слов)
   - Начало: Создание атмосферы (2500 слов)
   - Развитие: Эмоциональное нарастание (2500 слов)
   - Поворот: Эмоциональный взрыв (2500 слов)
   - Завершение: Послевкусие (2000 слов)

4. **С преобладанием интриги и поворотов** (2:2.5:3:2 тыс. слов)
   - Начало: Завязка (2000 слов)
   - Развитие: Нарастание загадки (2500 слов)
   - Поворот: Раскрытие правды (3000 слов) [Ключевое открытие]
   - Завершение: Продолжение влияния (2000 слов)

**Интеллектуальные рекомендации**
Автоматически рекомендуйте:
"Глава [N] является [обычной/ключевой] главой, рекомендуется использовать режим [трех частей/четырех частей], принять?"

### 5. Применение стратегий обнаружения против ИИ

**Натурализация выражения**
На основе прочитанного файла по обнаружению против ИИ, обработайте сгенерированный контент:

1. **Оптимизация на уровне лексики**
   - Замените слова, характерные для ИИ, на разговорные выражения
   - Контролируйте плотность идиом (2-3 на тысячу слов)
   - Умеренно используйте диалекты/интернет-сленг

2. **Натурализация синтаксиса**
   - Чередуйте длинные и короткие предложения (избегайте равномерного распределения)
   - Вставляйте неполные предложения и разговорные выражения
   - Добавляйте частицы и слова-паразиты

3. **Симуляция когнитивных процессов**
   - Симулируйте несовершенство памяти ("кажется...", "вроде...")
   - Отражайте избирательность внимания
   - Добавляйте личные субъективные оттенки

4. **Внедрение дефектов** (для повышения реалистичности)
   - 1 ошибка на 2000 слов (смешение 的, 地, 得)
   - Произвольность пунктуации (вариации многоточия)
   - Случайные изменения порядка слов

5. **Персонализация**
   - Применяйте личные характеристики из personal-voice.md
   - Поддерживайте единообразие стиля
   - Усиливайте уникальные привычки выражения

### 6. Генерация контента главы

**Стандартный режим** (одна часть)
Используйте write_file для создания файла главы:
# Глава X: [Название главы]
[Содержание, 2500-3000 слов, с применением стратегий против ИИ]

**Режим из трех частей** (7500 слов)
- Глава X (Начало): Начальная установка [2500 слов]
- Глава X (Развитие): Развитие сюжета [2500 слов]
- Глава X (Завершение): Завершение перехода [2500 слов]

**Режим из четырех частей** (9000-9500 слов)
- Глава X (Начало): [Соответствующее количество слов]
- Глава X (Развитие): [Соответствующее количество слов]
- Глава X (Поворот): [Соответствующее количество слов] [Часть кульминации]
- Глава X (Завершение): [Соответствующее количество слов]

Каждая часть должна быть связной, обратите внимание:
- Начало: Установка сцены и атмосферы
- Развитие: Продолжение начала, продвижение сюжета
- Поворот: Ключевой поворот или кульминация (в режиме четырех частей)
- Завершение: Соответствующее завершение, подготовка к следующей главе

---
Количество слов: [Фактическое количество слов]
Выполненные пункты: [Выполненные пункты]
Анонс следующей главы: [Анонс в одном предложении]

### 7. Контроль качества
- Достигнуто ли требуемое количество слов
- Выполнены ли пункты
- Согласован ли стиль
- Соответствуют ли персонажи
- Естественно ли соединяются части
- **Самопроверка на обнаружение ИИ**:
  - Есть ли 3 последовательных предложения со схожей структурой
  - Слишком ли книжная лексика
  - Отсутствуют ли разговорные черты
  - Нет ли излишнего совершенства без недостатков

### 8. Автоматическое обновление данных отслеживания

После завершения письма автоматически выполняются следующие обновления:

**Обновление отслеживания сюжета**
Используйте edit_file для обновления spec/tracking/plot-tracker.json:
- Отметьте текущую главу как завершенную
- Запишите выполненные сюжетные узлы
- Добавьте новые завязки

**Обновление временной шкалы**
Используйте edit_file для обновления spec/tracking/timeline.json:
- Извлеките информацию о времени из главы
- Обновите текущую точку времени истории
- Проверьте непрерывность времени

**Обновление взаимоотношений персонажей**
Используйте edit_file для обновления spec/tracking/relationships.json:
- Определите изменения в отношениях
- Запишите развитие отношений
- Обновите статус отношений

**Обновление состояния персонажей**
Используйте edit_file для обновления spec/tracking/character-state.json:
- Запишите изменения местоположения персонажей
- Обновите стадию развития персонажей
- Отслеживайте рост персонажей

### 9. Уведомление об отслеживании генерации
```
✅ Написание главы N завершено, данные отслеживания обновлены

Рекомендуется выполнить:
- /plot-check для проверки связности сюжета
- /timeline для проверки логики временной шкалы
- /relations для подтверждения изменений в отношениях
- /track для пакетной проверки последних глав (рекомендуется выполнять каждые 10 глав)
```

### 10. Отчет о завершении
✅ Создание главы X завершено!
- Количество слов: [Фактическое количество слов]
- Файл: stories/[Название]/chapters/[Имя файла]
- Степень завершенности: [Завершенность пунктов]
- Отслеживание: Все файлы отслеживания автоматически обновлены
- Следующий шаг: Продолжайте /write для следующей главы

## Напоминание о пакетной проверке
После завершения нескольких глав (рекомендуется каждые 5-10 глав), запустите:
- /track для глубокой проверки согласованности всего контента
- /plot-check для проверки логики сюжета
- /world-check для проверки согласованности мироустройства

## Примечания
- Строго придерживайтесь заданного стиля
- Диалоги персонажей должны быть индивидуальными
- Сюжет должен соответствовать требованиям плана
- Поддерживайте живость и конкретность сцен
- Данные отслеживания синхронизируются автоматически
- **Ключевые моменты по обнаружению ИИ**:
  - Естественное выражение важнее идеальных слов
  - Умеренное количество недостатков повышает реалистичность
  - Личные характеристики должны проходить через весь текст
  - Избегайте накопления словарного запаса, характерного для ИИ
"""